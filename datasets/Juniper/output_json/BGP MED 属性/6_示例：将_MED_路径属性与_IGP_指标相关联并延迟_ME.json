{
  "title": "示例：将 MED 路径属性与 IGP 指标相关联并延迟 MED 更新",
  "sections": [
    {
      "title": "要求",
      "level": 3,
      "content": "在配置此示例之前，不需要除设备初始化之外的特殊配置。"
    },
    {
      "title": "概述",
      "level": 3,
      "content": "可以将 BGP 配置为根据路由的内部 BGP （IBGP） 路由下一跃点的 IGP 距离通告路由的 MED 属性。IGP 指标使内部路由能够根据管理设置遵循最短路径。在某些部署中，最好将 IGP 最短路径信息传递给相邻自治系统 (AS) 中的外部 BGP (EBGP) 对等方。这允许这些 EBGP 对等方使用尽可能短的路径将流量转发到您的 AS。 从 EBGP 对等方获知的路由通常在直接连接的接口上具有下一跃点，因此 IGP 值等于零。零是宣传的值。当 BGP 对等方发送需要本地系统执行下一跃点解析（IBGP 配置、联合对等方内的配置或包含 multihop 该语句的 EBGP 配置）的第三方下一跃点时，IGP 指标是一个非零值。在这些情况下，通过包含 metric-out minimum-igp 或 metric-out igp 选项将 MED 值与 IGP 指标相关联可能是有意义的。 将 MED 与 IGP 指标相关联的缺点是，当网络中存在 IGP 不稳定时，可能会出现路由通告过多的风险。为 MED 更新配置延迟提供了一种在此类情况下减少路由播发的机制。延迟的工作原理是在下一跃点的 IGP 指标更改时减慢 MED 更新速度。该方法使用计时器定期播发 MED 更新。计时器过期时，已配置路由 metric-out igp delay-updates 的 MED 属性将更新为下一跃点的当前 IGP 指标。启用 BGP 的设备会针对 MED 属性已更改的路由发出播发。 该 delay-updates 选项标识必须禁止其 MED 更新的 BGP 组（或对等方）。默认情况下，播发 MED 更新的时间设置为 10 分钟。您可以通过在 med-igp-update-interval 配置中包含 routing-options 语句来将间隔增加到最多 600 分钟。 注： 如果启用了不间断活动路由 （NSR） 并且发生了切换，则延迟的 MED 更新可能会在切换发生后立即播发。 配置该 metric-out igp 选项时，IGP 指标会直接跟踪 IBGP 对等方的 IGP 成本。当 IGP 成本下降时，通告的 MED 值也会下降。相反，当IGP成本上升时，MED值也会上升。 配置该 metric-out minimum-igp 选项时，仅当 IBGP 对等方的 IGP 成本下降时，通告的 MED 值才会更改。IGP 成本的增加不会影响 MED 值。路由器会监控并记住最低 IGP 开销，直到路由进程 （rpd） 重新启动。仅当 MED 低于之前播发的值或与路由关联的其他属性已更改，或者 BGP 对等方正在响应刷新路由请求时，BGP 对等方才会发送更新。 此示例使用 OSPF 配置中的语句来 metric 演示当 IGP 指标更改时，MED 也会在配置的延迟间隔后更改。OSPF 指标的范围为 1 到 65535。 图 4 显示了示例拓扑。 图 4： 用于延迟 MED 更新的拓扑 在此示例中，设备 R1 播发的 MED 值与在 AS 1 中运行的 IGP 相关联。当 AS 2 将流量转发到 AS 1 时，设备 R1 通告的 MED 值会影响相邻 AS （AS 2） 的决策。 可以将 BGP 配置为根据路由的内部 BGP （IBGP） 路由下一跃点的 IGP 距离通告路由的 MED 属性。IGP 指标使内部路由能够根据管理设置遵循最短路径。在某些部署中，最好将 IGP 最短路径信息传递给相邻自治系统 (AS) 中的外部 BGP (EBGP) 对等方。这允许这些 EBGP 对等方使用尽可能短的路径将流量转发到您的 AS。 从 EBGP 对等方获知的路由通常在直接连接的接口上具有下一跃点，因此 IGP 值等于零。零是宣传的值。当 BGP 对等方发送需要本地系统执行下一跃点解析（IBGP 配置、联合对等方内的配置或包含 multihop 该语句的 EBGP 配置）的第三方下一跃点时，IGP 指标是一个非零值。在这些情况下，通过包含 metric-out minimum-igp 或 metric-out igp 选项将 MED 值与 IGP 指标相关联可能是有意义的。 将 MED 与 IGP 指标相关联的缺点是，当网络中存在 IGP 不稳定时，可能会出现路由通告过多的风险。为 MED 更新配置延迟提供了一种在此类情况下减少路由播发的机制。延迟的工作原理是在下一跃点的 IGP 指标更改时减慢 MED 更新速度。该方法使用计时器定期播发 MED 更新。计时器过期时，已配置路由 metric-out igp delay-updates 的 MED 属性将更新为下一跃点的当前 IGP 指标。启用 BGP 的设备会针对 MED 属性已更改的路由发出播发。 该 delay-updates 选项标识必须禁止其 MED 更新的 BGP 组（或对等方）。默认情况下，播发 MED 更新的时间设置为 10 分钟。您可以通过在 med-igp-update-interval 配置中包含 routing-options 语句来将间隔增加到最多 600 分钟。 注： 如果启用了不间断活动路由 （NSR） 并且发生了切换，则延迟的 MED 更新可能会在切换发生后立即播发。 如果启用了不间断活动路由 （NSR） 并且发生了切换，则延迟的 MED 更新可能会在切换发生后立即播发。 配置该 metric-out igp 选项时，IGP 指标会直接跟踪 IBGP 对等方的 IGP 成本。当 IGP 成本下降时，通告的 MED 值也会下降。相反，当IGP成本上升时，MED值也会上升。 配置该 metric-out minimum-igp 选项时，仅当 IBGP 对等方的 IGP 成本下降时，通告的 MED 值才会更改。IGP 成本的增加不会影响 MED 值。路由器会监控并记住最低 IGP 开销，直到路由进程 （rpd） 重新启动。仅当 MED 低于之前播发的值或与路由关联的其他属性已更改，或者 BGP 对等方正在响应刷新路由请求时，BGP 对等方才会发送更新。 此示例使用 OSPF 配置中的语句来 metric 演示当 IGP 指标更改时，MED 也会在配置的延迟间隔后更改。OSPF 指标的范围为 1 到 65535。 图 4 显示了示例拓扑。 图 4： 用于延迟 MED 更新的拓扑 在此示例中，设备 R1 播发的 MED 值与在 AS 1 中运行的 IGP 相关联。当 AS 2 将流量转发到 AS 1 时，设备 R1 通告的 MED 值会影响相邻 AS （AS 2） 的决策。"
    },
    {
      "title": "配置",
      "level": 3,
      "content": "要快速配置此示例，请复制以下命令，将其粘贴到文本文件中，删除所有换行符，更改与您的网络配置匹配所需的任何详细信息，然后将命令复制并粘贴到层次结构级别的 CLI [edit] 中。 设备 R1 set interfaces fe-1/2/0 unit 2 description R1->R2 set interfaces fe-1/2/0 unit 2 family inet address 10.0.0.1/30 set interfaces fe-1/2/1 unit 7 description R1->R4 set interfaces fe-1/2/1 unit 7 family inet address 172.16.0.1/30 set interfaces lo0 unit 1 family inet address 192.168.0.1/32 set protocols bgp group internal type internal set protocols bgp group internal local-address 192.168.0.1 set protocols bgp group internal export send-direct set protocols bgp group internal neighbor 192.168.0.2 set protocols bgp group internal neighbor 192.168.0.3 set protocols bgp group external type external set protocols bgp group external metric-out igp delay-med-update set protocols bgp group external export send-direct set protocols bgp group external peer-as 2 set protocols bgp group external neighbor 172.16.0.2 set protocols ospf area 0.0.0.0 interface fe-1/2/0.2 metric 600 set protocols ospf area 0.0.0.0 interface lo0.1 passive set policy-options policy-statement send-direct term 1 from protocol direct set policy-options policy-statement send-direct term 1 then accept set routing-options med-igp-update-interval 12 set routing-options router-id 192.168.0.1 set routing-options autonomous-system 1 设备 R2 set interfaces fe-1/2/0 unit 1 description R2->R1 set interfaces fe-1/2/0 unit 1 family inet address 10.0.0.2/30 set interfaces fe-1/2/1 unit 4 description R2->R3 set interfaces fe-1/2/1 unit 4 family inet address 10.0.2.2/30 set interfaces lo0 unit 2 family inet address 192.168.0.2/32 set protocols bgp group internal type internal set protocols bgp group internal local-address 192.168.0.2 set protocols bgp group internal export send-direct set protocols bgp group internal neighbor 192.168.0.1 set protocols bgp group internal neighbor 192.168.0.3 set protocols ospf area 0.0.0.0 interface fe-1/2/0.1 set protocols ospf area 0.0.0.0 interface fe-1/2/1.4 set protocols ospf area 0.0.0.0 interface lo0.2 passive set policy-options policy-statement send-direct term 1 from protocol direct set policy-options policy-statement send-direct term 1 then accept set routing-options router-id 192.168.0.2 set routing-options autonomous-system 1 设备 R3 set interfaces fe-1/2/0 unit 3 description R3->R2 set interfaces fe-1/2/0 unit 3 family inet address 10.0.2.1/30 set interfaces fe-1/2/1 unit 5 description R3->R5 set interfaces fe-1/2/1 unit 5 family inet address 172.16.0.5/30 set interfaces lo0 unit 3 family inet address 192.168.0.3/32 set protocols bgp group internal type internal set protocols bgp group internal local-address 192.168.0.3 set protocols bgp group internal export send-direct set protocols bgp group internal neighbor 192.168.0.1 set protocols bgp group internal neighbor 192.168.0.2 set protocols bgp group external type external set protocols bgp group external export send-direct set protocols bgp group external peer-as 2 set protocols bgp group external neighbor 172.16.0.6 set protocols ospf area 0.0.0.0 interface fe-1/2/0.3 set protocols ospf area 0.0.0.0 interface lo0.3 passive set policy-options policy-statement send-direct term 1 from protocol direct set policy-options policy-statement send-direct term 1 then accept set routing-options router-id 192.168.0.3 set routing-options autonomous-system 1 设备 R4 set interfaces fe-1/2/0 unit 8 description R4->R1 set interfaces fe-1/2/0 unit 8 family inet address 172.16.0.2/30 set interfaces fe-1/2/1 unit 9 description R4->R5 set interfaces fe-1/2/1 unit 9 family inet address 10.0.4.1/30 set interfaces fe-1/2/2 unit 13 description R4->R6 set interfaces fe-1/2/2 unit 13 family inet address 172.16.0.9/30 set interfaces lo0 unit 4 family inet address 192.168.0.4/32 set protocols bgp group internal type internal set protocols bgp group internal local-address 192.168.0.4 set protocols bgp group internal export send-direct set protocols bgp group internal neighbor 192.168.0.5 set protocols bgp group external type external set protocols bgp group external export send-direct set protocols bgp group external neighbor 172.16.0.10 peer-as 3 set protocols bgp group external neighbor 172.16.0.1 peer-as 1 set protocols ospf area 0.0.0.0 interface fe-1/2/1.9 set protocols ospf area 0.0.0.0 interface lo0.4 passive set policy-options policy-statement send-direct term 1 from protocol direct set policy-options policy-statement send-direct term 1 then accept set routing-options router-id 192.168.0.4 set routing-options autonomous-system 2 设备 R5 set interfaces fe-1/2/0 unit 6 description R5->R3 set interfaces fe-1/2/0 unit 6 family inet address 172.16.0.6/30 set interfaces fe-1/2/1 unit 10 description R5->R4 set interfaces fe-1/2/1 unit 10 family inet address 10.0.4.2/30 set interfaces fe-1/2/2 unit 11 description R5->R8 set interfaces fe-1/2/2 unit 11 family inet address 172.16.0.13/30 set interfaces lo0 unit 5 family inet address 192.168.0.5/32 set protocols bgp group internal type internal set protocols bgp group internal local-address 192.168.0.5 set protocols bgp group internal export send-direct set protocols bgp group internal neighbor 192.168.0.4 set protocols bgp group external type external set protocols bgp group external export send-direct set protocols bgp group external neighbor 172.16.0.5 peer-as 1 set protocols bgp group external neighbor 172.16.0.14 peer-as 3 set protocols ospf area 0.0.0.0 interface fe-1/2/1.10 set protocols ospf area 0.0.0.0 interface lo0.5 passive set policy-options policy-statement send-direct term 1 from protocol direct set policy-options policy-statement send-direct term 1 then accept set routing-options router-id 192.168.0.5 set routing-options autonomous-system 2 设备 R6 set interfaces fe-1/2/0 unit 14 description R6->R4 set interfaces fe-1/2/0 unit 14 family inet address 172.16.0.10/30 set interfaces fe-1/2/1 unit 15 description R6->R7 set interfaces fe-1/2/1 unit 15 family inet address 10.0.6.1/30 set interfaces lo0 unit 6 family inet address 192.168.0.6/32 set protocols bgp group internal type internal set protocols bgp group internal local-address 192.168.0.6 set protocols bgp group internal export send-direct set protocols bgp group internal neighbor 192.168.0.7 set protocols bgp group internal neighbor 192.168.0.8 set protocols bgp group external type external set protocols bgp group external export send-direct set protocols bgp group external peer-as 2 set protocols bgp group external neighbor 172.16.0.9 peer-as 2 set protocols ospf area 0.0.0.0 interface fe-1/2/1.15 set protocols ospf area 0.0.0.0 interface lo0.6 passive set policy-options policy-statement send-direct term 1 from protocol direct set policy-options policy-statement send-direct term 1 then accept set routing-options router-id 192.168.0.6 set routing-options autonomous-system 3 设备 R7 set interfaces fe-1/2/0 unit 16 description R7->R6 set interfaces fe-1/2/0 unit 16 family inet address 10.0.6.2/30 set interfaces fe-1/2/1 unit 17 description R7->R8 set interfaces fe-1/2/1 unit 17 family inet address 10.0.7.2/30 set interfaces lo0 unit 7 family inet address 192.168.0.7/32 set protocols bgp group internal type internal set protocols bgp group internal local-address 192.168.0.7 set protocols bgp group internal export send-direct set protocols bgp group internal neighbor 192.168.0.6 set protocols bgp group internal neighbor 192.168.0.8 set protocols ospf area 0.0.0.0 interface fe-1/2/0.16 set protocols ospf area 0.0.0.0 interface fe-1/2/1.17 set protocols ospf area 0.0.0.0 interface lo0.7 passive set policy-options policy-statement send-direct term 1 from protocol direct set policy-options policy-statement send-direct term 1 then accept set routing-options router-id 192.168.0.7 set routing-options autonomous-system 3 设备 R8 set interfaces fe-1/2/0 unit 12 description R8->R5 set interfaces fe-1/2/0 unit 12 family inet address 172.16.0.14/30 set interfaces fe-1/2/1 unit 18 description R8->R7 set interfaces fe-1/2/1 unit 18 family inet address 10.0.7.1/30 set interfaces lo0 unit 8 family inet address 192.168.0.8/32 set protocols bgp group internal type internal set protocols bgp group internal local-address 192.168.0.8 set protocols bgp group internal export send-direct set protocols bgp group internal neighbor 192.168.0.6 set protocols bgp group internal neighbor 192.168.0.7 set protocols bgp group external type external set protocols bgp group external export send-direct set protocols bgp group external peer-as 2 set protocols bgp group external neighbor 172.16.0.13 peer-as 2 set protocols ospf area 0.0.0.0 interface fe-1/2/1.18 set protocols ospf area 0.0.0.0 interface lo0.8 passive set policy-options policy-statement send-direct term 1 from protocol direct set policy-options policy-statement send-direct term 1 then accept set routing-options router-id 192.168.0.8 set routing-options autonomous-system 3 下面的示例要求您在各个配置层级中进行导航。有关导航 CLI 的信息，请参阅《Junos OS CLI 用户指南》中的在配置模式下使用 CLI 编辑器。 要配置设备 R1： 配置接口。 [edit interfaces fe-1/2/0 unit 2] user@R1# set description R1->R2 user@R1# set family inet address 10.0.0.1/30 [edit interfaces fe-1/2/1 unit 7] user@R1# set description R1->R4 user@R1# set family inet address 172.16.0.1/30 [edit interfaces lo0 unit 1] user@R1# set family inet address 192.168.0.1/32 配置 IBGP。 [edit protocols bgp group internal] user@R1# set type internal user@R1# set local-address 192.168.0.1 user@R1# set export send-direct user@R1# set neighbor 192.168.0.2 user@R1# set neighbor 192.168.0.3 配置 EBGP。 [edit protocols bgp group external] user@R1# set type external user@R1# set export send-direct user@R1# set peer-as 2 user@R1# set neighbor 172.16.0.2 将 MED 值与 IGP 指标相关联。 [edit protocols bgp group external] user@R1# set metric-out igp delay-med-update 包含该 delay-med-update 选项时，MED 更新的默认值为 10 分钟。排除该 delay-med-update 选项时，MED 更新会在 IGP 指标更改后立即发生。 （可选）配置 MED 更新的更新间隔。 [edit routing-options] user@R1# set med-igp-update-interval 12 您可以配置从 10 分钟到 600 分钟的间隔。 配置 OSPF。 [edit protocols ospf area 0.0.0.0] user@R1# set interface fe-1/2/0.2 metric 600 user@R1# set interface lo0.1 passive metric 此处使用该语句来演示 IGP 指标更改时发生的情况。 配置接受直接路由的策略。 此方案的其他有用选项可能是接受通过 OSPF 或本地路由获知的路由。 [edit policy-options policy-statement send-direct term 1] user@R1# set from protocol direct user@R1# set then accept 配置路由器 ID 和自治系统 (AS) 编号。 [edit routing-options] user@R1# set router-id 192.168.0.1 user@R1# set autonomous-system 1 在配置模式下，输入 show interfaces 、 show policy-options 、 show protocols 和 show routing-options 命令，以确认您的配置。如果输出未显示预期的配置，请重复此示例中的说明，以便进行更正。 user@R1# show interfaces fe-1/2/0 { unit 2 { description R1->R2; family inet { address 10.0.0.1/30; } } } fe-1/2/1 { unit 7 { description R1->R4; family inet { address 172.16.0.1/30; } } } lo0 { unit 1 { family inet { address 192.168.0.1/32; } } } user@R1# show policy-options policy-statement send-direct { term 1 { from protocol direct; then accept; } } user@R1# show protocols bgp { group internal { type internal; local-address 192.168.0.1; export send-direct; neighbor 192.168.0.2; neighbor 192.168.0.3; } group external { type external; metric-out igp delay-med-update; export send-direct; peer-as 2; neighbor 172.16.0.2; } } ospf { area 0.0.0.0 { interface fe-1/2/0.2 { metric 600; } interface lo0.1 { passive; } } } user@R1# show routing-options med-igp-update-interval 12; router-id 192.168.0.1; autonomous-system 1; 如果完成设备配置，请从配置模式输入 commit 。根据您的网络需要在拓扑中的其他设备上重复这些配置步骤。",
      "sections": [
        {
          "title": "CLI 快速配置",
          "level": 4,
          "content": "要快速配置此示例，请复制以下命令，将其粘贴到文本文件中，删除所有换行符，更改与您的网络配置匹配所需的任何详细信息，然后将命令复制并粘贴到层次结构级别的 CLI [edit] 中。 设备 R1 set interfaces fe-1/2/0 unit 2 description R1->R2 set interfaces fe-1/2/0 unit 2 family inet address 10.0.0.1/30 set interfaces fe-1/2/1 unit 7 description R1->R4 set interfaces fe-1/2/1 unit 7 family inet address 172.16.0.1/30 set interfaces lo0 unit 1 family inet address 192.168.0.1/32 set protocols bgp group internal type internal set protocols bgp group internal local-address 192.168.0.1 set protocols bgp group internal export send-direct set protocols bgp group internal neighbor 192.168.0.2 set protocols bgp group internal neighbor 192.168.0.3 set protocols bgp group external type external set protocols bgp group external metric-out igp delay-med-update set protocols bgp group external export send-direct set protocols bgp group external peer-as 2 set protocols bgp group external neighbor 172.16.0.2 set protocols ospf area 0.0.0.0 interface fe-1/2/0.2 metric 600 set protocols ospf area 0.0.0.0 interface lo0.1 passive set policy-options policy-statement send-direct term 1 from protocol direct set policy-options policy-statement send-direct term 1 then accept set routing-options med-igp-update-interval 12 set routing-options router-id 192.168.0.1 set routing-options autonomous-system 1 设备 R2 set interfaces fe-1/2/0 unit 1 description R2->R1 set interfaces fe-1/2/0 unit 1 family inet address 10.0.0.2/30 set interfaces fe-1/2/1 unit 4 description R2->R3 set interfaces fe-1/2/1 unit 4 family inet address 10.0.2.2/30 set interfaces lo0 unit 2 family inet address 192.168.0.2/32 set protocols bgp group internal type internal set protocols bgp group internal local-address 192.168.0.2 set protocols bgp group internal export send-direct set protocols bgp group internal neighbor 192.168.0.1 set protocols bgp group internal neighbor 192.168.0.3 set protocols ospf area 0.0.0.0 interface fe-1/2/0.1 set protocols ospf area 0.0.0.0 interface fe-1/2/1.4 set protocols ospf area 0.0.0.0 interface lo0.2 passive set policy-options policy-statement send-direct term 1 from protocol direct set policy-options policy-statement send-direct term 1 then accept set routing-options router-id 192.168.0.2 set routing-options autonomous-system 1 设备 R3 set interfaces fe-1/2/0 unit 3 description R3->R2 set interfaces fe-1/2/0 unit 3 family inet address 10.0.2.1/30 set interfaces fe-1/2/1 unit 5 description R3->R5 set interfaces fe-1/2/1 unit 5 family inet address 172.16.0.5/30 set interfaces lo0 unit 3 family inet address 192.168.0.3/32 set protocols bgp group internal type internal set protocols bgp group internal local-address 192.168.0.3 set protocols bgp group internal export send-direct set protocols bgp group internal neighbor 192.168.0.1 set protocols bgp group internal neighbor 192.168.0.2 set protocols bgp group external type external set protocols bgp group external export send-direct set protocols bgp group external peer-as 2 set protocols bgp group external neighbor 172.16.0.6 set protocols ospf area 0.0.0.0 interface fe-1/2/0.3 set protocols ospf area 0.0.0.0 interface lo0.3 passive set policy-options policy-statement send-direct term 1 from protocol direct set policy-options policy-statement send-direct term 1 then accept set routing-options router-id 192.168.0.3 set routing-options autonomous-system 1 设备 R4 set interfaces fe-1/2/0 unit 8 description R4->R1 set interfaces fe-1/2/0 unit 8 family inet address 172.16.0.2/30 set interfaces fe-1/2/1 unit 9 description R4->R5 set interfaces fe-1/2/1 unit 9 family inet address 10.0.4.1/30 set interfaces fe-1/2/2 unit 13 description R4->R6 set interfaces fe-1/2/2 unit 13 family inet address 172.16.0.9/30 set interfaces lo0 unit 4 family inet address 192.168.0.4/32 set protocols bgp group internal type internal set protocols bgp group internal local-address 192.168.0.4 set protocols bgp group internal export send-direct set protocols bgp group internal neighbor 192.168.0.5 set protocols bgp group external type external set protocols bgp group external export send-direct set protocols bgp group external neighbor 172.16.0.10 peer-as 3 set protocols bgp group external neighbor 172.16.0.1 peer-as 1 set protocols ospf area 0.0.0.0 interface fe-1/2/1.9 set protocols ospf area 0.0.0.0 interface lo0.4 passive set policy-options policy-statement send-direct term 1 from protocol direct set policy-options policy-statement send-direct term 1 then accept set routing-options router-id 192.168.0.4 set routing-options autonomous-system 2 设备 R5 set interfaces fe-1/2/0 unit 6 description R5->R3 set interfaces fe-1/2/0 unit 6 family inet address 172.16.0.6/30 set interfaces fe-1/2/1 unit 10 description R5->R4 set interfaces fe-1/2/1 unit 10 family inet address 10.0.4.2/30 set interfaces fe-1/2/2 unit 11 description R5->R8 set interfaces fe-1/2/2 unit 11 family inet address 172.16.0.13/30 set interfaces lo0 unit 5 family inet address 192.168.0.5/32 set protocols bgp group internal type internal set protocols bgp group internal local-address 192.168.0.5 set protocols bgp group internal export send-direct set protocols bgp group internal neighbor 192.168.0.4 set protocols bgp group external type external set protocols bgp group external export send-direct set protocols bgp group external neighbor 172.16.0.5 peer-as 1 set protocols bgp group external neighbor 172.16.0.14 peer-as 3 set protocols ospf area 0.0.0.0 interface fe-1/2/1.10 set protocols ospf area 0.0.0.0 interface lo0.5 passive set policy-options policy-statement send-direct term 1 from protocol direct set policy-options policy-statement send-direct term 1 then accept set routing-options router-id 192.168.0.5 set routing-options autonomous-system 2 设备 R6 set interfaces fe-1/2/0 unit 14 description R6->R4 set interfaces fe-1/2/0 unit 14 family inet address 172.16.0.10/30 set interfaces fe-1/2/1 unit 15 description R6->R7 set interfaces fe-1/2/1 unit 15 family inet address 10.0.6.1/30 set interfaces lo0 unit 6 family inet address 192.168.0.6/32 set protocols bgp group internal type internal set protocols bgp group internal local-address 192.168.0.6 set protocols bgp group internal export send-direct set protocols bgp group internal neighbor 192.168.0.7 set protocols bgp group internal neighbor 192.168.0.8 set protocols bgp group external type external set protocols bgp group external export send-direct set protocols bgp group external peer-as 2 set protocols bgp group external neighbor 172.16.0.9 peer-as 2 set protocols ospf area 0.0.0.0 interface fe-1/2/1.15 set protocols ospf area 0.0.0.0 interface lo0.6 passive set policy-options policy-statement send-direct term 1 from protocol direct set policy-options policy-statement send-direct term 1 then accept set routing-options router-id 192.168.0.6 set routing-options autonomous-system 3 设备 R7 set interfaces fe-1/2/0 unit 16 description R7->R6 set interfaces fe-1/2/0 unit 16 family inet address 10.0.6.2/30 set interfaces fe-1/2/1 unit 17 description R7->R8 set interfaces fe-1/2/1 unit 17 family inet address 10.0.7.2/30 set interfaces lo0 unit 7 family inet address 192.168.0.7/32 set protocols bgp group internal type internal set protocols bgp group internal local-address 192.168.0.7 set protocols bgp group internal export send-direct set protocols bgp group internal neighbor 192.168.0.6 set protocols bgp group internal neighbor 192.168.0.8 set protocols ospf area 0.0.0.0 interface fe-1/2/0.16 set protocols ospf area 0.0.0.0 interface fe-1/2/1.17 set protocols ospf area 0.0.0.0 interface lo0.7 passive set policy-options policy-statement send-direct term 1 from protocol direct set policy-options policy-statement send-direct term 1 then accept set routing-options router-id 192.168.0.7 set routing-options autonomous-system 3 设备 R8 set interfaces fe-1/2/0 unit 12 description R8->R5 set interfaces fe-1/2/0 unit 12 family inet address 172.16.0.14/30 set interfaces fe-1/2/1 unit 18 description R8->R7 set interfaces fe-1/2/1 unit 18 family inet address 10.0.7.1/30 set interfaces lo0 unit 8 family inet address 192.168.0.8/32 set protocols bgp group internal type internal set protocols bgp group internal local-address 192.168.0.8 set protocols bgp group internal export send-direct set protocols bgp group internal neighbor 192.168.0.6 set protocols bgp group internal neighbor 192.168.0.7 set protocols bgp group external type external set protocols bgp group external export send-direct set protocols bgp group external peer-as 2 set protocols bgp group external neighbor 172.16.0.13 peer-as 2 set protocols ospf area 0.0.0.0 interface fe-1/2/1.18 set protocols ospf area 0.0.0.0 interface lo0.8 passive set policy-options policy-statement send-direct term 1 from protocol direct set policy-options policy-statement send-direct term 1 then accept set routing-options router-id 192.168.0.8 set routing-options autonomous-system 3",
          "commands_by_device": {
            "设备 R1": "set interfaces fe-1/2/0 unit 2 description R1->R2\nset interfaces fe-1/2/0 unit 2 family inet address 10.0.0.1/30\nset interfaces fe-1/2/1 unit 7 description R1->R4\nset interfaces fe-1/2/1 unit 7 family inet address 172.16.0.1/30\nset interfaces lo0 unit 1 family inet address 192.168.0.1/32\nset protocols bgp group internal type internal\nset protocols bgp group internal local-address 192.168.0.1\nset protocols bgp group internal export send-direct\nset protocols bgp group internal neighbor 192.168.0.2\nset protocols bgp group internal neighbor 192.168.0.3\nset protocols bgp group external type external\nset protocols bgp group external metric-out igp delay-med-update\nset protocols bgp group external export send-direct\nset protocols bgp group external peer-as 2\nset protocols bgp group external neighbor 172.16.0.2\nset protocols ospf area 0.0.0.0 interface fe-1/2/0.2 metric 600\nset protocols ospf area 0.0.0.0 interface lo0.1 passive\nset policy-options policy-statement send-direct term 1 from protocol direct\nset policy-options policy-statement send-direct term 1 then accept\nset routing-options med-igp-update-interval 12\nset routing-options router-id 192.168.0.1\nset routing-options autonomous-system 1",
            "设备 R2": "set interfaces fe-1/2/0 unit 1 description R2->R1\nset interfaces fe-1/2/0 unit 1 family inet address 10.0.0.2/30\nset interfaces fe-1/2/1 unit 4 description R2->R3\nset interfaces fe-1/2/1 unit 4 family inet address 10.0.2.2/30\nset interfaces lo0 unit 2 family inet address 192.168.0.2/32\nset protocols bgp group internal type internal\nset protocols bgp group internal local-address 192.168.0.2\nset protocols bgp group internal export send-direct\nset protocols bgp group internal neighbor 192.168.0.1\nset protocols bgp group internal neighbor 192.168.0.3\nset protocols ospf area 0.0.0.0 interface fe-1/2/0.1\nset protocols ospf area 0.0.0.0 interface fe-1/2/1.4\nset protocols ospf area 0.0.0.0 interface lo0.2 passive\nset policy-options policy-statement send-direct term 1 from protocol direct\nset policy-options policy-statement send-direct term 1 then accept\nset routing-options router-id 192.168.0.2\nset routing-options autonomous-system 1",
            "设备 R3": "set interfaces fe-1/2/0 unit 3 description R3->R2\nset interfaces fe-1/2/0 unit 3 family inet address 10.0.2.1/30\nset interfaces fe-1/2/1 unit 5 description R3->R5\nset interfaces fe-1/2/1 unit 5 family inet address 172.16.0.5/30\nset interfaces lo0 unit 3 family inet address 192.168.0.3/32\nset protocols bgp group internal type internal\nset protocols bgp group internal local-address 192.168.0.3\nset protocols bgp group internal export send-direct\nset protocols bgp group internal neighbor 192.168.0.1\nset protocols bgp group internal neighbor 192.168.0.2\nset protocols bgp group external type external\nset protocols bgp group external export send-direct\nset protocols bgp group external peer-as 2\nset protocols bgp group external neighbor 172.16.0.6\nset protocols ospf area 0.0.0.0 interface fe-1/2/0.3\nset protocols ospf area 0.0.0.0 interface lo0.3 passive\nset policy-options policy-statement send-direct term 1 from protocol direct\nset policy-options policy-statement send-direct term 1 then accept\nset routing-options router-id 192.168.0.3\nset routing-options autonomous-system 1",
            "设备 R4": "set interfaces fe-1/2/0 unit 8 description R4->R1\nset interfaces fe-1/2/0 unit 8 family inet address 172.16.0.2/30\nset interfaces fe-1/2/1 unit 9 description R4->R5\nset interfaces fe-1/2/1 unit 9 family inet address 10.0.4.1/30\nset interfaces fe-1/2/2 unit 13 description R4->R6\nset interfaces fe-1/2/2 unit 13 family inet address 172.16.0.9/30\nset interfaces lo0 unit 4 family inet address 192.168.0.4/32\nset protocols bgp group internal type internal\nset protocols bgp group internal local-address 192.168.0.4\nset protocols bgp group internal export send-direct\nset protocols bgp group internal neighbor 192.168.0.5\nset protocols bgp group external type external\nset protocols bgp group external export send-direct\nset protocols bgp group external neighbor 172.16.0.10 peer-as 3\nset protocols bgp group external neighbor 172.16.0.1 peer-as 1\nset protocols ospf area 0.0.0.0 interface fe-1/2/1.9\nset protocols ospf area 0.0.0.0 interface lo0.4 passive\nset policy-options policy-statement send-direct term 1 from protocol direct\nset policy-options policy-statement send-direct term 1 then accept\nset routing-options router-id 192.168.0.4\nset routing-options autonomous-system 2",
            "设备 R5": "set interfaces fe-1/2/0 unit 6 description R5->R3\nset interfaces fe-1/2/0 unit 6 family inet address 172.16.0.6/30\nset interfaces fe-1/2/1 unit 10 description R5->R4\nset interfaces fe-1/2/1 unit 10 family inet address 10.0.4.2/30\nset interfaces fe-1/2/2 unit 11 description R5->R8\nset interfaces fe-1/2/2 unit 11 family inet address 172.16.0.13/30\nset interfaces lo0 unit 5 family inet address 192.168.0.5/32\nset protocols bgp group internal type internal\nset protocols bgp group internal local-address 192.168.0.5\nset protocols bgp group internal export send-direct\nset protocols bgp group internal neighbor 192.168.0.4\nset protocols bgp group external type external\nset protocols bgp group external export send-direct\nset protocols bgp group external neighbor 172.16.0.5 peer-as 1\nset protocols bgp group external neighbor 172.16.0.14 peer-as 3\nset protocols ospf area 0.0.0.0 interface fe-1/2/1.10\nset protocols ospf area 0.0.0.0 interface lo0.5 passive\nset policy-options policy-statement send-direct term 1 from protocol direct\nset policy-options policy-statement send-direct term 1 then accept\nset routing-options router-id 192.168.0.5\nset routing-options autonomous-system 2",
            "设备 R6": "set interfaces fe-1/2/0 unit 14 description R6->R4\nset interfaces fe-1/2/0 unit 14 family inet address 172.16.0.10/30\nset interfaces fe-1/2/1 unit 15 description R6->R7\nset interfaces fe-1/2/1 unit 15 family inet address 10.0.6.1/30\nset interfaces lo0 unit 6 family inet address 192.168.0.6/32\nset protocols bgp group internal type internal\nset protocols bgp group internal local-address 192.168.0.6\nset protocols bgp group internal export send-direct\nset protocols bgp group internal neighbor 192.168.0.7\nset protocols bgp group internal neighbor 192.168.0.8\nset protocols bgp group external type external\nset protocols bgp group external export send-direct\nset protocols bgp group external peer-as 2\nset protocols bgp group external neighbor 172.16.0.9 peer-as 2\nset protocols ospf area 0.0.0.0 interface fe-1/2/1.15\nset protocols ospf area 0.0.0.0 interface lo0.6 passive\nset policy-options policy-statement send-direct term 1 from protocol direct\nset policy-options policy-statement send-direct term 1 then accept\nset routing-options router-id 192.168.0.6\nset routing-options autonomous-system 3",
            "设备 R7": "set interfaces fe-1/2/0 unit 16 description R7->R6\nset interfaces fe-1/2/0 unit 16 family inet address 10.0.6.2/30\nset interfaces fe-1/2/1 unit 17 description R7->R8\nset interfaces fe-1/2/1 unit 17 family inet address 10.0.7.2/30\nset interfaces lo0 unit 7 family inet address 192.168.0.7/32\nset protocols bgp group internal type internal\nset protocols bgp group internal local-address 192.168.0.7\nset protocols bgp group internal export send-direct\nset protocols bgp group internal neighbor 192.168.0.6\nset protocols bgp group internal neighbor 192.168.0.8\nset protocols ospf area 0.0.0.0 interface fe-1/2/0.16\nset protocols ospf area 0.0.0.0 interface fe-1/2/1.17\nset protocols ospf area 0.0.0.0 interface lo0.7 passive\nset policy-options policy-statement send-direct term 1 from protocol direct\nset policy-options policy-statement send-direct term 1 then accept\nset routing-options router-id 192.168.0.7\nset routing-options autonomous-system 3",
            "设备 R8": "set interfaces fe-1/2/0 unit 12 description R8->R5\nset interfaces fe-1/2/0 unit 12 family inet address 172.16.0.14/30\nset interfaces fe-1/2/1 unit 18 description R8->R7\nset interfaces fe-1/2/1 unit 18 family inet address 10.0.7.1/30\nset interfaces lo0 unit 8 family inet address 192.168.0.8/32\nset protocols bgp group internal type internal\nset protocols bgp group internal local-address 192.168.0.8\nset protocols bgp group internal export send-direct\nset protocols bgp group internal neighbor 192.168.0.6\nset protocols bgp group internal neighbor 192.168.0.7\nset protocols bgp group external type external\nset protocols bgp group external export send-direct\nset protocols bgp group external peer-as 2\nset protocols bgp group external neighbor 172.16.0.13 peer-as 2\nset protocols ospf area 0.0.0.0 interface fe-1/2/1.18\nset protocols ospf area 0.0.0.0 interface lo0.8 passive\nset policy-options policy-statement send-direct term 1 from protocol direct\nset policy-options policy-statement send-direct term 1 then accept\nset routing-options router-id 192.168.0.8\nset routing-options autonomous-system 3"
          }
        },
        {
          "title": "配置设备 R1",
          "level": 4,
          "content": "下面的示例要求您在各个配置层级中进行导航。有关导航 CLI 的信息，请参阅《Junos OS CLI 用户指南》中的在配置模式下使用 CLI 编辑器。 要配置设备 R1： 配置接口。 [edit interfaces fe-1/2/0 unit 2] user@R1# set description R1->R2 user@R1# set family inet address 10.0.0.1/30 [edit interfaces fe-1/2/1 unit 7] user@R1# set description R1->R4 user@R1# set family inet address 172.16.0.1/30 [edit interfaces lo0 unit 1] user@R1# set family inet address 192.168.0.1/32 配置 IBGP。 [edit protocols bgp group internal] user@R1# set type internal user@R1# set local-address 192.168.0.1 user@R1# set export send-direct user@R1# set neighbor 192.168.0.2 user@R1# set neighbor 192.168.0.3 配置 EBGP。 [edit protocols bgp group external] user@R1# set type external user@R1# set export send-direct user@R1# set peer-as 2 user@R1# set neighbor 172.16.0.2 将 MED 值与 IGP 指标相关联。 [edit protocols bgp group external] user@R1# set metric-out igp delay-med-update 包含该 delay-med-update 选项时，MED 更新的默认值为 10 分钟。排除该 delay-med-update 选项时，MED 更新会在 IGP 指标更改后立即发生。 （可选）配置 MED 更新的更新间隔。 [edit routing-options] user@R1# set med-igp-update-interval 12 您可以配置从 10 分钟到 600 分钟的间隔。 配置 OSPF。 [edit protocols ospf area 0.0.0.0] user@R1# set interface fe-1/2/0.2 metric 600 user@R1# set interface lo0.1 passive metric 此处使用该语句来演示 IGP 指标更改时发生的情况。 配置接受直接路由的策略。 此方案的其他有用选项可能是接受通过 OSPF 或本地路由获知的路由。 [edit policy-options policy-statement send-direct term 1] user@R1# set from protocol direct user@R1# set then accept 配置路由器 ID 和自治系统 (AS) 编号。 [edit routing-options] user@R1# set router-id 192.168.0.1 user@R1# set autonomous-system 1 在配置模式下，输入 show interfaces 、 show policy-options 、 show protocols 和 show routing-options 命令，以确认您的配置。如果输出未显示预期的配置，请重复此示例中的说明，以便进行更正。 user@R1# show interfaces fe-1/2/0 { unit 2 { description R1->R2; family inet { address 10.0.0.1/30; } } } fe-1/2/1 { unit 7 { description R1->R4; family inet { address 172.16.0.1/30; } } } lo0 { unit 1 { family inet { address 192.168.0.1/32; } } } user@R1# show policy-options policy-statement send-direct { term 1 { from protocol direct; then accept; } } user@R1# show protocols bgp { group internal { type internal; local-address 192.168.0.1; export send-direct; neighbor 192.168.0.2; neighbor 192.168.0.3; } group external { type external; metric-out igp delay-med-update; export send-direct; peer-as 2; neighbor 172.16.0.2; } } ospf { area 0.0.0.0 { interface fe-1/2/0.2 { metric 600; } interface lo0.1 { passive; } } } user@R1# show routing-options med-igp-update-interval 12; router-id 192.168.0.1; autonomous-system 1; 如果完成设备配置，请从配置模式输入 commit 。根据您的网络需要在拓扑中的其他设备上重复这些配置步骤。",
          "sections": [
            {
              "title": "分步过程",
              "level": 5,
              "step_by_step": [
                {
                  "step": 1,
                  "description": "配置接口。",
                  "code": [
                    "[edit interfaces fe-1/2/0 unit 2]",
                    "user@R1# set description R1->R2",
                    "user@R1# set family inet address 10.0.0.1/30",
                    "[edit interfaces fe-1/2/1 unit 7]",
                    "user@R1# set description R1->R4",
                    "user@R1# set family inet address 172.16.0.1/30",
                    "[edit interfaces lo0 unit 1]",
                    "user@R1# set family inet address 192.168.0.1/32"
                  ]
                },
                {
                  "step": 2,
                  "description": "配置 IBGP。",
                  "code": [
                    "[edit protocols bgp group internal]",
                    "user@R1# set type internal",
                    "user@R1# set local-address 192.168.0.1",
                    "user@R1# set export send-direct",
                    "user@R1# set neighbor 192.168.0.2",
                    "user@R1# set neighbor 192.168.0.3"
                  ]
                },
                {
                  "step": 3,
                  "description": "配置 EBGP。",
                  "code": [
                    "[edit protocols bgp group external]",
                    "user@R1# set type external",
                    "user@R1# set export send-direct",
                    "user@R1# set peer-as 2",
                    "user@R1# set neighbor 172.16.0.2"
                  ]
                },
                {
                  "step": 4,
                  "description": "将 MED 值与 IGP 指标相关联。",
                  "code": [
                    "[edit protocols bgp group external]",
                    "user@R1# set metric-out igp delay-med-update"
                  ]
                },
                {
                  "step": 5,
                  "description": "（可选）配置 MED 更新的更新间隔。",
                  "code": [
                    "[edit routing-options]",
                    "user@R1# set med-igp-update-interval 12"
                  ]
                },
                {
                  "step": 6,
                  "description": "配置 OSPF。",
                  "code": [
                    "[edit protocols ospf area 0.0.0.0]",
                    "user@R1# set interface fe-1/2/0.2 metric 600",
                    "user@R1# set interface lo0.1 passive"
                  ]
                },
                {
                  "step": 7,
                  "description": "配置接受直接路由的策略。",
                  "code": [
                    "[edit policy-options policy-statement send-direct term 1]",
                    "user@R1# set from protocol direct",
                    "user@R1# set then accept"
                  ]
                },
                {
                  "step": 8,
                  "description": "配置路由器 ID 和自治系统 (AS) 编号。",
                  "code": [
                    "[edit routing-options]",
                    "user@R1# set router-id 192.168.0.1",
                    "user@R1# set autonomous-system 1"
                  ]
                }
              ]
            },
            {
              "title": "结果",
              "level": 5,
              "content": "在配置模式下，输入 show interfaces 、 show policy-options 、 show protocols 和 show routing-options 命令，以确认您的配置。如果输出未显示预期的配置，请重复此示例中的说明，以便进行更正。 如果完成设备配置，请从配置模式输入 commit 。根据您的网络需要在拓扑中的其他设备上重复这些配置步骤。",
              "code": [
                "user@R1#show interfacesfe-1/2/0 {\n    unit 2 {\n        description R1->R2;\n        family inet {\n            address 10.0.0.1/30;\n        }\n    }\n}\nfe-1/2/1 {\n    unit 7 {\n        description R1->R4;\n        family inet {\n            address 172.16.0.1/30;\n        }\n    }\n}\nlo0 {\n    unit 1 {\n        family inet {\n            address 192.168.0.1/32;\n        }\n    }\n}",
                "user@R1#show policy-optionspolicy-statement send-direct {\n    term 1 {\n        from protocol direct;\n        then accept;\n    }\n}",
                "user@R1#show protocolsbgp {\n    group internal {\n        type internal;\n        local-address 192.168.0.1;\n        export send-direct;\n        neighbor 192.168.0.2;\n        neighbor 192.168.0.3;\n    }\n    group external {\n        type external;\n        metric-out igp delay-med-update;\n        export send-direct;\n        peer-as 2;\n        neighbor 172.16.0.2;\n    }\n}\nospf {\n    area 0.0.0.0 {\n        interface fe-1/2/0.2 {\n            metric 600;\n        }\n        interface lo0.1 {\n            passive;\n        }\n    }\n}",
                "user@R1#show routing-optionsmed-igp-update-interval 12;\nrouter-id 192.168.0.1;\nautonomous-system 1;"
              ]
            }
          ]
        }
      ]
    }
  ],
  "content": "此示例说明如何将多出口鉴别器 （MED） 路径属性与内部网关协议 （IGP） 指标相关联，以及如何配置计时器以延迟 MED 属性的更新。 要求 在配置此示例之前，不需要除设备初始化之外的特殊配置。 概述 可以将 BGP 配置为根据路由的内部 BGP （IBGP） 路由下一跃点的 IGP 距离通告路由的 MED 属性。IGP 指标使内部路由能够根据管理设置遵循最短路径。在某些部署中，最好将 IGP 最短路径信息传递给相邻自治系统 (AS) 中的外部 BGP (EBGP) 对等方。这允许这些 EBGP 对等方使用尽可能短的路径将流量转发到您的 AS。 从 EBGP 对等方获知的路由通常在直接连接的接口上具有下一跃点，因此 IGP 值等于零。零是宣传的值。当 BGP 对等方发送需要本地系统执行下一跃点解析（IBGP 配置、联合对等方内的配置或包含 multihop 该语句的 EBGP 配置）的第三方下一跃点时，IGP 指标是一个非零值。在这些情况下，通过包含 metric-out minimum-igp 或 metric-out igp 选项将 MED 值与 IGP 指标相关联可能是有意义的。 将 MED 与 IGP 指标相关联的缺点是，当网络中存在 IGP 不稳定时，可能会出现路由通告过多的风险。为 MED 更新配置延迟提供了一种在此类情况下减少路由播发的机制。延迟的工作原理是在下一跃点的 IGP 指标更改时减慢 MED 更新速度。该方法使用计时器定期播发 MED 更新。计时器过期时，已配置路由 metric-out igp delay-updates 的 MED 属性将更新为下一跃点的当前 IGP 指标。启用 BGP 的设备会针对 MED 属性已更改的路由发出播发。 该 delay-updates 选项标识必须禁止其 MED 更新的 BGP 组（或对等方）。默认情况下，播发 MED 更新的时间设置为 10 分钟。您可以通过在 med-igp-update-interval 配置中包含 routing-options 语句来将间隔增加到最多 600 分钟。 注： 如果启用了不间断活动路由 （NSR） 并且发生了切换，则延迟的 MED 更新可能会在切换发生后立即播发。 配置该 metric-out igp 选项时，IGP 指标会直接跟踪 IBGP 对等方的 IGP 成本。当 IGP 成本下降时，通告的 MED 值也会下降。相反，当IGP成本上升时，MED值也会上升。 配置该 metric-out minimum-igp 选项时，仅当 IBGP 对等方的 IGP 成本下降时，通告的 MED 值才会更改。IGP 成本的增加不会影响 MED 值。路由器会监控并记住最低 IGP 开销，直到路由进程 （rpd） 重新启动。仅当 MED 低于之前播发的值或与路由关联的其他属性已更改，或者 BGP 对等方正在响应刷新路由请求时，BGP 对等方才会发送更新。 此示例使用 OSPF 配置中的语句来 metric 演示当 IGP 指标更改时，MED 也会在配置的延迟间隔后更改。OSPF 指标的范围为 1 到 65535。 图 4 显示了示例拓扑。 图 4： 用于延迟 MED 更新的拓扑 在此示例中，设备 R1 播发的 MED 值与在 AS 1 中运行的 IGP 相关联。当 AS 2 将流量转发到 AS 1 时，设备 R1 通告的 MED 值会影响相邻 AS （AS 2） 的决策"
}