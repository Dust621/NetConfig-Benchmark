{
  "title": "示例：为 BGP 配置源验证",
  "sections": [
    {
      "title": "要求",
      "level": 3,
      "content": "此示例具有以下硬件和软件要求： 资源公钥基础结构 （RPKI） 缓存服务器，使用第三方软件对 BGP 前缀进行身份验证。 在通过 TCP 连接与缓存服务器通信的路由设备上运行的 Junos OS 12.2 或更高版本。 此示例具有以下硬件和软件要求： 资源公钥基础结构 （RPKI） 缓存服务器，使用第三方软件对 BGP 前缀进行身份验证。 在通过 TCP 连接与缓存服务器通信的路由设备上运行的 Junos OS 12.2 或更高版本。"
    },
    {
      "title": "概述",
      "level": 3,
      "content": "有时，由于操作员错误，无意中通告了路由。为了防止此安全问题，您可以配置 BGP 来验证始发 AS 并拒绝这些无效公告。 此功能使用缓存服务器对前缀或前缀范围进行身份验证。 以下配置语句启用源 AS 验证： [edit routing-options] validation { group group-name { max-sessions number ; session address { hold-time seconds ; local-address local-ip-address ; port port-number ; preference number ; record-lifetime seconds ; refresh-time seconds ; traceoptions { file filename <files number > <size size > <(world-readable | no-world-readable)>; flag flag { disable; flag-modifier ; } } } static { record destination { maximum-length prefix-length { origin-autonomous-system as-number { validation-state (invalid | valid); } } } } traceoptions { file filename <files number > <size size > <world-readable | no-world-readable>; flag flag { disable; flag-modifier ; } } } 此示例使用验证参数的默认设置。 大多数可用的配置语句都是可选的。所需设置如下： validation { group group-name { session address { } } } [edit routing-options validation static] 层次结构级别使您能够在路由设备上配置静态记录，从而覆盖从 RPKI 缓存服务器接收的记录。 例如： [edit routing-options validation] user@R0# set static record 10.0.0.0/16 maximum-length 24 origin-autonomous-system 200 validation-state valid 您可以配置基于路由前缀的验证状态运行的路由策略。您可以使用社区属性通告和接收外部 BGP （EBGP） 和内部 BGP （IBGP） 对等方之间的前缀的验证状态。在某些路由器上使用路由策略可能比配置与 RPKI 服务器的会话更方便。此示例演示了如何在 IBGP 对等方之间使用验证状态社区属性。 图 4 显示了示例拓扑。 在此示例中，设备 R0 具有与设备 R1 的 IBGP 连接和与设备 R2 的 EBGP 连接。设备 R0 使用互联网草案 draft-ietf-sidr-rpki-rtr-19（ RPKI/路由器协议） 中定义的协议从缓存服务器接收路由验证 （RV） 记录，以发送 RV 记录。RPKI 路由器协议通过 TCP 运行。设备 R0 使用 RV 记录来构建本地 RV 数据库。在设备 R1 上，验证状态基于称为验证状态的 BGP 社区设置，该社区随路由一起接收。"
    },
    {
      "title": "配置",
      "level": 3,
      "content": "要快速配置此示例，请复制以下命令，将其粘贴到文本文件中，删除所有换行符，更改与您的网络配置匹配所需的任何详细信息，然后将命令复制并粘贴到层次结构级别的 CLI [edit] 中。 设备 R0 set interfaces ge-1/2/0 unit 2 description to-R1 set interfaces ge-1/2/0 unit 0 family inet address 10.0.0.2/30 set interfaces ge-1/2/1 unit 0 description to-R2 set interfaces ge-1/2/1 unit 0 family inet address 10.0.0.5/30 set interfaces ge-1/2/2 unit 0 description to-cache set interfaces ge-1/2/2 unit 0 family inet address 10.0.0.9/30 set interfaces lo0 unit 0 family inet address 10.0.1.1/32 set protocols bgp group int type internal set protocols bgp group int local-address 10.0.1.1 set protocols bgp group int export send-direct set protocols bgp group int neighbor 10.1.1.1 set protocols bgp group ext type external set protocols bgp group ext import validation set protocols bgp group ext export send-direct set protocols bgp group ext peer-as 65200 set protocols bgp group ext neighbor 10.0.0.6 set protocols ospf area 0.0.0.0 interface ge-1/2/0.2 set protocols ospf area 0.0.0.0 interface lo0.0 passive set policy-options policy-statement send-direct from protocol direct set policy-options policy-statement send-direct then accept set policy-options policy-statement validation term valid from protocol bgp set policy-options policy-statement validation term valid from validation-database valid set policy-options policy-statement validation term valid then validation-state valid set policy-options policy-statement validation term valid then community add origin-validation-state-valid set policy-options policy-statement validation term valid then accept set policy-options policy-statement validation term invalid from protocol bgp set policy-options policy-statement validation term invalid from validation-database invalid set policy-options policy-statement validation term invalid then validation-state invalid set policy-options policy-statement validation term invalid then community add origin-validation-state-invalid set policy-options policy-statement validation term invalid then reject set policy-options policy-statement validation term unknown from protocol bgp set policy-options policy-statement validation term unknown then validation-state unknown set policy-options policy-statement validation term unknown then community add origin-validation-state-unknown set policy-options policy-statement validation term unknown then accept set policy-options community origin-validation-state-invalid members 0x4300:0.0.0.0:2 set policy-options community origin-validation-state-unknown members 0x4300:0.0.0.0:1 set policy-options community origin-validation-state-valid members 0x4300:0.0.0.0:0 set routing-options autonomous-system 65100 set routing-options validation group test session 10.0.0.10 设备 R1 set interfaces ge-1/2/0 unit 0 family inet address 10.0.0.1/30 set interfaces lo0 unit 0 family inet address 10.1.1.1/32 set protocols bgp group int type internal set protocols bgp group int local-address 10.1.1.1 set protocols bgp group int import validation-ibgp set protocols bgp group int neighbor 10.0.1.1 set protocols ospf area 0.0.0.0 interface ge-1/2/0.0 set protocols ospf area 0.0.0.0 interface lo0.0 passive set policy-options policy-statement validation-ibgp term valid from community origin-validation-state-valid set policy-options policy-statement validation-ibgp term valid then validation-state valid set policy-options policy-statement validation-ibgp term invalid from community origin-validation-state-invalid set policy-options policy-statement validation-ibgp term invalid then validation-state invalid set policy-options policy-statement validation-ibgp term unknown from community origin-validation-state-unknown set policy-options policy-statement validation-ibgp term unknown then validation-state unknown set policy-options community origin-validation-state-invalid members 0x4300:0.0.0.0:2 set policy-options community origin-validation-state-unknown members 0x4300:0.0.0.0:1 set policy-options community origin-validation-state-valid members 0x4300:0.0.0.0:0 set routing-options autonomous-system 65100 设备 R2 set interfaces ge-1/2/0 unit 0 family inet address 10.0.0.6/30 set interfaces lo0 unit 0 family inet address 172.16.1.1/32 set interfaces lo0 unit 0 family inet address 192.168.2.3/32 set protocols bgp group ext export send-direct set protocols bgp group ext peer-as 65100 set protocols bgp group ext neighbor 10.0.0.5 set policy-options policy-statement send-direct from protocol direct set policy-options policy-statement send-direct from protocol local set policy-options policy-statement send-direct then accept set routing-options autonomous-system 65200 下面的示例要求您在各个配置层级中进行导航。有关导航 CLI 的信息，请参阅《Junos OS CLI 用户指南》中的在配置模式下使用 CLI 编辑器。 要配置设备 R0： 配置接口。 [edit interfaces] user@R0# set ge-1/2/0 unit 0 description to-R1 user@R0# set ge-1/2/0 unit 0 family inet address 10.0.0.2/30 user@R0# set ge-1/2/1 unit 0 description to-R2 user@R0# set ge-1/2/1 unit 0 family inet address 10.0.0.5/30 user@R0# set ge-1/2/2 unit 0 description to-cache user@R0# set ge-1/2/2 unit 0 family inet address 10.0.0.9/30 user@R0# set lo0 unit 0 family inet address 10.0.1.1/32 配置 BGP。 send-direct 应用导出策略，以便将直接路由从路由表导出到 BGP 中。 应用导入策略， validation 为从设备 R0 的 EBGP 对等方导入（或接收）的所有路由设置验证状态和 BGP 社区属性。 配置与设备 R1 的 IBGP 会话。配置与设备 R2 的 EBGP 会话。 [edit protocols bgp] user@R0# set group int type internal user@R0# set group int local-address 10.0.1.1 user@R0# set group int export send-direct user@R0# set group int neighbor 10.1.1.1 user@R0# set group ext type external user@R0# set group ext import validation user@R0# set group ext export send-direct user@R0# set group ext peer-as 65200 user@R0# set group ext neighbor 10.0.0.6 在面向 IBGP 对等方的接口和环路接口上配置 OSPF（或其他内部网关协议 [IGP]）。 注： 如果在 IBGP neighbor 语句中使用环路接口地址，则必须在环路接口上启用 IGP。否则，不会建立 IBGP 会话。 如果在 IBGP neighbor 语句中使用环路接口地址，则必须在环路接口上启用 IGP。否则，不会建立 IBGP 会话。 [edit protocols ospf area 0.0.0.0] user@R0# set interface ge-1/2/0.0 user@R0# set interface lo0.0 passive 配置将路由表中的直接路由导出到 BGP 的路由策略。 [edit policy-options policy-statement send-direct] user@R0# set from protocol direct user@R0# set then accept 配置路由策略，根据每个 BGP 路由的验证状态指定要修改的属性。 [edit policy-options policy-statement validation] user@R0# set term valid from protocol bgp user@R0# set term valid from validation-database valid user@R0# set term valid then validation-state valid user@R0# set term valid then community add origin-validation-state-valid user@R0# set term valid then accept user@R0# set term invalid from protocol bgp user@R0# set term invalid from validation-database invalid user@R0# set term invalid then validation-state invalid user@R0# set term invalid then community add origin-validation-state-invalid user@R0# set term invalid then reject user@R0# set term unknown from protocol bgp user@R0# set term unknown then validation-state unknown user@R0# set term unknown then community add origin-validation-state-unknown user@R0# set term unknown then accept [edit policy-options] user@R0# set community origin-validation-state-invalid members 0x4300:0.0.0.0:2 user@R0# set community origin-validation-state-unknown members 0x4300:0.0.0.0:1 user@R0# set community origin-validation-state-valid members 0x4300:0.0.0.0:0 配置与 RPKI 缓存服务器的会话。 [edit routing-options validation] user@R0# set group test session 10.0.0.10 配置自治系统 (AS) 编号。 [edit routing-options] user@R0# set autonomous-system 65100 在配置模式下，输入 show interfaces 、 show protocols 、 show policy-options 和 show routing-options 命令，以确认您的配置。如果输出未显示预期的配置，请重复此示例中的说明，以便进行更正。 user@R0# show interfaces ge-1/2/0 { unit 0 { description to-R1; family inet { address 10.0.0.2/30; } } } ge-1/2/1 { unit 0 { description to-R2; family inet { address 10.0.0.5/30; } } } ge-1/2/2 { unit 0 { description to-cache; family inet { address 10.0.0.9/30; } } } lo0 { unit 0 { family inet { address 10.0.1.1/32; } } } user@R0# show protocols bgp { group int { type internal; local-address 10.0.1.1; export send-direct; neighbor 10.1.1.1; } group ext { type external; import validation; export send-direct; peer-as 65200; neighbor 10.0.0.6; } } ospf { area 0.0.0.0 { interface ge-1/2/0.0; interface lo0.0 { passive; } } } user@R0# show policy-options policy-statement send-direct { from protocol direct; then accept; } policy-statement validation { term valid { from { protocol bgp; validation-database valid; } then { validation-state valid; community add origin-validation-state-valid; accept; } } term invalid { from { protocol bgp; validation-database invalid; } then { validation-state invalid; community add origin-validation-state-invalid; reject; } } term unknown { from protocol bgp; then { validation-state unknown; community add origin-validation-state-unknown; accept; } } } community origin-validation-state-invalid members 0x4300:0.0.0.0:2; community origin-validation-state-unknown members 0x4300:0.0.0.0:1; community origin-validation-state-valid members 0x4300:0.0.0.0:0; } user@R0# show routing-options autonomous-system 65100; validation { group test { session 10.0.0.10; } } 如果完成设备配置，请从配置模式输入 commit 。 要配置设备 R1： [edit interfaces] user@R1# set ge-1/2/0 unit 0 family inet address 10.0.0.1/30 user@R1# set lo0 unit 0 family inet address 10.1.1.1/32 validation-ibgp 应用导入策略，为从设备 R1 的 IBGP 对等方接收的所有路由设置验证状态和 BGP 社区属性。 配置与设备 R0 的 IBGP 会话。 [edit protocols bgp group int] user@R1# set type internal user@R1# set local-address 10.1.1.1 user@R1# set import validation-ibgp user@R1# set neighbor 10.0.1.1 配置 OSPF。 [edit protocols ospf area 0.0.0.0] user@R1# set interface ge-1/2/0.0 user@R1# set interface lo0.0 passive 配置路由策略，该策略根据从设备 R0 接收的 BGP 路由的验证状态 BGP 社区属性指定要修改的属性。 [edit policy-options policy-statement validation-ibgp] user@R1# set term valid from community origin-validation-state-valid user@R1# set term valid then validation-state valid user@R1# set term invalid from community origin-validation-state-invalid user@R1# set term invalid then validation-state invalid user@R1# set term unknown from community origin-validation-state-unknown user@R1# set term unknown then validation-state unknown [edit policy-options] user@R1# set community origin-validation-state-invalid members 0x4300:0.0.0.0:2 user@R1# set community origin-validation-state-unknown members 0x4300:0.0.0.0:1 user@R1# set community origin-validation-state-valid members 0x4300:0.0.0.0:0 [edit routing-options] user@R1# set autonomous-system 65100 user@R1# show interfaces ge-1/2/0 { unit 0 { family inet { address 10.0.0.1/30; } } } lo0 { unit 0 { family inet { address 10.1.1.1/32; } } } user@R1# show protocols bgp { group int { type internal; local-address 10.1.1.1; import validation-ibgp; neighbor 10.0.1.1; } } ospf { area 0.0.0.0 { interface ge-1/2/0.0; interface lo0.0 { passive; } } } user@R1# show policy-options policy-statement validation-ibgp { term valid { from community origin-validation-state-valid; then validation-state valid; } term invalid { from community origin-validation-state-invalid; then validation-state invalid; } term unknown { from community origin-validation-state-unknown; then validation-state unknown; } } community origin-validation-state-invalid members 0x4300:0.0.0.0:2; community origin-validation-state-unknown members 0x4300:0.0.0.0:1; community origin-validation-state-valid members 0x4300:0.0.0.0:0; } user@R1# show routing-options autonomous-system 65100; 要配置设备 R2： 环路接口上配置了多个地址作为演示目的的路由。 [edit interfaces] user@R2# set ge-1/2/0 unit 0 family inet address 10.0.0.6/30 user@R2# set lo0 unit 0 family inet address 172.16.1.1/32 user@R2# set lo0 unit 0 family inet address 192.168.2.3/32 [edit protocols bgp] user@R2# set group ext export send-direct user@R2# set group ext peer-as 65100 user@R2# set group ext neighbor 10.0.0.5 配置路由策略。 [edit policy-options policy-statement send-direct] user@R2# set from protocol direct user@R2# set from protocol local user@R2# set then accept [edit routing-options] user@R2# set autonomous-system 65200 user@R2# show interfaces ge-1/2/0 { unit 0 { family inet { address 10.0.0.6/30; } } } lo0 { unit 0 { family inet { address 172.16.1.1/32; address 192.168.2.3/32; } } } user@R2# show protocols bgp { group ext { export send-direct; peer-as 65100; neighbor 10.0.0.5; } } user@R2# show policy-options policy-statement send-direct { from protocol [ direct local ]; then accept; } user@R2# show routing-options autonomous-system 65200;",
      "sections": [
        {
          "title": "CLI 快速配置",
          "level": 4,
          "content": "要快速配置此示例，请复制以下命令，将其粘贴到文本文件中，删除所有换行符，更改与您的网络配置匹配所需的任何详细信息，然后将命令复制并粘贴到层次结构级别的 CLI [edit] 中。 设备 R0 set interfaces ge-1/2/0 unit 2 description to-R1 set interfaces ge-1/2/0 unit 0 family inet address 10.0.0.2/30 set interfaces ge-1/2/1 unit 0 description to-R2 set interfaces ge-1/2/1 unit 0 family inet address 10.0.0.5/30 set interfaces ge-1/2/2 unit 0 description to-cache set interfaces ge-1/2/2 unit 0 family inet address 10.0.0.9/30 set interfaces lo0 unit 0 family inet address 10.0.1.1/32 set protocols bgp group int type internal set protocols bgp group int local-address 10.0.1.1 set protocols bgp group int export send-direct set protocols bgp group int neighbor 10.1.1.1 set protocols bgp group ext type external set protocols bgp group ext import validation set protocols bgp group ext export send-direct set protocols bgp group ext peer-as 65200 set protocols bgp group ext neighbor 10.0.0.6 set protocols ospf area 0.0.0.0 interface ge-1/2/0.2 set protocols ospf area 0.0.0.0 interface lo0.0 passive set policy-options policy-statement send-direct from protocol direct set policy-options policy-statement send-direct then accept set policy-options policy-statement validation term valid from protocol bgp set policy-options policy-statement validation term valid from validation-database valid set policy-options policy-statement validation term valid then validation-state valid set policy-options policy-statement validation term valid then community add origin-validation-state-valid set policy-options policy-statement validation term valid then accept set policy-options policy-statement validation term invalid from protocol bgp set policy-options policy-statement validation term invalid from validation-database invalid set policy-options policy-statement validation term invalid then validation-state invalid set policy-options policy-statement validation term invalid then community add origin-validation-state-invalid set policy-options policy-statement validation term invalid then reject set policy-options policy-statement validation term unknown from protocol bgp set policy-options policy-statement validation term unknown then validation-state unknown set policy-options policy-statement validation term unknown then community add origin-validation-state-unknown set policy-options policy-statement validation term unknown then accept set policy-options community origin-validation-state-invalid members 0x4300:0.0.0.0:2 set policy-options community origin-validation-state-unknown members 0x4300:0.0.0.0:1 set policy-options community origin-validation-state-valid members 0x4300:0.0.0.0:0 set routing-options autonomous-system 65100 set routing-options validation group test session 10.0.0.10 设备 R1 set interfaces ge-1/2/0 unit 0 family inet address 10.0.0.1/30 set interfaces lo0 unit 0 family inet address 10.1.1.1/32 set protocols bgp group int type internal set protocols bgp group int local-address 10.1.1.1 set protocols bgp group int import validation-ibgp set protocols bgp group int neighbor 10.0.1.1 set protocols ospf area 0.0.0.0 interface ge-1/2/0.0 set protocols ospf area 0.0.0.0 interface lo0.0 passive set policy-options policy-statement validation-ibgp term valid from community origin-validation-state-valid set policy-options policy-statement validation-ibgp term valid then validation-state valid set policy-options policy-statement validation-ibgp term invalid from community origin-validation-state-invalid set policy-options policy-statement validation-ibgp term invalid then validation-state invalid set policy-options policy-statement validation-ibgp term unknown from community origin-validation-state-unknown set policy-options policy-statement validation-ibgp term unknown then validation-state unknown set policy-options community origin-validation-state-invalid members 0x4300:0.0.0.0:2 set policy-options community origin-validation-state-unknown members 0x4300:0.0.0.0:1 set policy-options community origin-validation-state-valid members 0x4300:0.0.0.0:0 set routing-options autonomous-system 65100 设备 R2 set interfaces ge-1/2/0 unit 0 family inet address 10.0.0.6/30 set interfaces lo0 unit 0 family inet address 172.16.1.1/32 set interfaces lo0 unit 0 family inet address 192.168.2.3/32 set protocols bgp group ext export send-direct set protocols bgp group ext peer-as 65100 set protocols bgp group ext neighbor 10.0.0.5 set policy-options policy-statement send-direct from protocol direct set policy-options policy-statement send-direct from protocol local set policy-options policy-statement send-direct then accept set routing-options autonomous-system 65200",
          "commands_by_device": {
            "设备 R0": "set interfaces ge-1/2/0 unit 2 description to-R1\nset interfaces ge-1/2/0 unit 0 family inet address 10.0.0.2/30\nset interfaces ge-1/2/1 unit 0 description to-R2\nset interfaces ge-1/2/1 unit 0 family inet address 10.0.0.5/30\nset interfaces ge-1/2/2 unit 0 description to-cache\nset interfaces ge-1/2/2 unit 0 family inet address 10.0.0.9/30\nset interfaces lo0 unit 0 family inet address 10.0.1.1/32\nset protocols bgp group int type internal\nset protocols bgp group int local-address 10.0.1.1\nset protocols bgp group int export send-direct\nset protocols bgp group int neighbor 10.1.1.1\nset protocols bgp group ext type external\nset protocols bgp group ext import validation\nset protocols bgp group ext export send-direct\nset protocols bgp group ext peer-as 65200\nset protocols bgp group ext neighbor 10.0.0.6\nset protocols ospf area 0.0.0.0 interface ge-1/2/0.2\nset protocols ospf area 0.0.0.0 interface lo0.0 passive\nset policy-options policy-statement send-direct from protocol direct\nset policy-options policy-statement send-direct then accept\nset policy-options policy-statement validation term valid from protocol bgp\nset policy-options policy-statement validation term valid from validation-database valid\nset policy-options policy-statement validation term valid then validation-state valid\nset policy-options policy-statement validation term valid then community add origin-validation-state-valid\nset policy-options policy-statement validation term valid then accept\nset policy-options policy-statement validation term invalid from protocol bgp\nset policy-options policy-statement validation term invalid from validation-database invalid\nset policy-options policy-statement validation term invalid then validation-state invalid\nset policy-options policy-statement validation term invalid then community add origin-validation-state-invalid\nset policy-options policy-statement validation term invalid then reject\nset policy-options policy-statement validation term unknown from protocol bgp\nset policy-options policy-statement validation term unknown then validation-state unknown\nset policy-options policy-statement validation term unknown then community add origin-validation-state-unknown\nset policy-options policy-statement validation term unknown then accept\nset policy-options community origin-validation-state-invalid members 0x4300:0.0.0.0:2\nset policy-options community origin-validation-state-unknown members 0x4300:0.0.0.0:1\nset policy-options community origin-validation-state-valid members 0x4300:0.0.0.0:0\nset routing-options autonomous-system 65100\nset routing-options validation group test session 10.0.0.10",
            "设备 R1": "set interfaces ge-1/2/0 unit 0 family inet address 10.0.0.1/30\nset interfaces lo0 unit 0 family inet address 10.1.1.1/32\nset protocols bgp group int type internal\nset protocols bgp group int local-address 10.1.1.1\nset protocols bgp group int import validation-ibgp\nset protocols bgp group int neighbor 10.0.1.1\nset protocols ospf area 0.0.0.0 interface ge-1/2/0.0\nset protocols ospf area 0.0.0.0 interface lo0.0 passive\nset policy-options policy-statement validation-ibgp term valid from community origin-validation-state-valid\nset policy-options policy-statement validation-ibgp term valid then validation-state valid\nset policy-options policy-statement validation-ibgp term invalid from community origin-validation-state-invalid\nset policy-options policy-statement validation-ibgp term invalid then validation-state invalid\nset policy-options policy-statement validation-ibgp term unknown from community origin-validation-state-unknown\nset policy-options policy-statement validation-ibgp term unknown then validation-state unknown\nset policy-options community origin-validation-state-invalid members 0x4300:0.0.0.0:2\nset policy-options community origin-validation-state-unknown members 0x4300:0.0.0.0:1\nset policy-options community origin-validation-state-valid members 0x4300:0.0.0.0:0\nset routing-options autonomous-system 65100",
            "设备 R2": "set interfaces ge-1/2/0 unit 0 family inet address 10.0.0.6/30\nset interfaces lo0 unit 0 family inet address 172.16.1.1/32\nset interfaces lo0 unit 0 family inet address 192.168.2.3/32\nset protocols bgp group ext export send-direct\nset protocols bgp group ext peer-as 65100\nset protocols bgp group ext neighbor 10.0.0.5\nset policy-options policy-statement send-direct from protocol direct\nset policy-options policy-statement send-direct from protocol local\nset policy-options policy-statement send-direct then accept\nset routing-options autonomous-system 65200"
          }
        },
        {
          "title": "配置设备 R0",
          "level": 4,
          "content": "下面的示例要求您在各个配置层级中进行导航。有关导航 CLI 的信息，请参阅《Junos OS CLI 用户指南》中的在配置模式下使用 CLI 编辑器。 要配置设备 R0： 配置接口。 [edit interfaces] user@R0# set ge-1/2/0 unit 0 description to-R1 user@R0# set ge-1/2/0 unit 0 family inet address 10.0.0.2/30 user@R0# set ge-1/2/1 unit 0 description to-R2 user@R0# set ge-1/2/1 unit 0 family inet address 10.0.0.5/30 user@R0# set ge-1/2/2 unit 0 description to-cache user@R0# set ge-1/2/2 unit 0 family inet address 10.0.0.9/30 user@R0# set lo0 unit 0 family inet address 10.0.1.1/32 配置 BGP。 send-direct 应用导出策略，以便将直接路由从路由表导出到 BGP 中。 应用导入策略， validation 为从设备 R0 的 EBGP 对等方导入（或接收）的所有路由设置验证状态和 BGP 社区属性。 配置与设备 R1 的 IBGP 会话。配置与设备 R2 的 EBGP 会话。 [edit protocols bgp] user@R0# set group int type internal user@R0# set group int local-address 10.0.1.1 user@R0# set group int export send-direct user@R0# set group int neighbor 10.1.1.1 user@R0# set group ext type external user@R0# set group ext import validation user@R0# set group ext export send-direct user@R0# set group ext peer-as 65200 user@R0# set group ext neighbor 10.0.0.6 在面向 IBGP 对等方的接口和环路接口上配置 OSPF（或其他内部网关协议 [IGP]）。 注： 如果在 IBGP neighbor 语句中使用环路接口地址，则必须在环路接口上启用 IGP。否则，不会建立 IBGP 会话。 如果在 IBGP neighbor 语句中使用环路接口地址，则必须在环路接口上启用 IGP。否则，不会建立 IBGP 会话。 [edit protocols ospf area 0.0.0.0] user@R0# set interface ge-1/2/0.0 user@R0# set interface lo0.0 passive 配置将路由表中的直接路由导出到 BGP 的路由策略。 [edit policy-options policy-statement send-direct] user@R0# set from protocol direct user@R0# set then accept 配置路由策略，根据每个 BGP 路由的验证状态指定要修改的属性。 [edit policy-options policy-statement validation] user@R0# set term valid from protocol bgp user@R0# set term valid from validation-database valid user@R0# set term valid then validation-state valid user@R0# set term valid then community add origin-validation-state-valid user@R0# set term valid then accept user@R0# set term invalid from protocol bgp user@R0# set term invalid from validation-database invalid user@R0# set term invalid then validation-state invalid user@R0# set term invalid then community add origin-validation-state-invalid user@R0# set term invalid then reject user@R0# set term unknown from protocol bgp user@R0# set term unknown then validation-state unknown user@R0# set term unknown then community add origin-validation-state-unknown user@R0# set term unknown then accept [edit policy-options] user@R0# set community origin-validation-state-invalid members 0x4300:0.0.0.0:2 user@R0# set community origin-validation-state-unknown members 0x4300:0.0.0.0:1 user@R0# set community origin-validation-state-valid members 0x4300:0.0.0.0:0 配置与 RPKI 缓存服务器的会话。 [edit routing-options validation] user@R0# set group test session 10.0.0.10 配置自治系统 (AS) 编号。 [edit routing-options] user@R0# set autonomous-system 65100 在配置模式下，输入 show interfaces 、 show protocols 、 show policy-options 和 show routing-options 命令，以确认您的配置。如果输出未显示预期的配置，请重复此示例中的说明，以便进行更正。 user@R0# show interfaces ge-1/2/0 { unit 0 { description to-R1; family inet { address 10.0.0.2/30; } } } ge-1/2/1 { unit 0 { description to-R2; family inet { address 10.0.0.5/30; } } } ge-1/2/2 { unit 0 { description to-cache; family inet { address 10.0.0.9/30; } } } lo0 { unit 0 { family inet { address 10.0.1.1/32; } } } user@R0# show protocols bgp { group int { type internal; local-address 10.0.1.1; export send-direct; neighbor 10.1.1.1; } group ext { type external; import validation; export send-direct; peer-as 65200; neighbor 10.0.0.6; } } ospf { area 0.0.0.0 { interface ge-1/2/0.0; interface lo0.0 { passive; } } } user@R0# show policy-options policy-statement send-direct { from protocol direct; then accept; } policy-statement validation { term valid { from { protocol bgp; validation-database valid; } then { validation-state valid; community add origin-validation-state-valid; accept; } } term invalid { from { protocol bgp; validation-database invalid; } then { validation-state invalid; community add origin-validation-state-invalid; reject; } } term unknown { from protocol bgp; then { validation-state unknown; community add origin-validation-state-unknown; accept; } } } community origin-validation-state-invalid members 0x4300:0.0.0.0:2; community origin-validation-state-unknown members 0x4300:0.0.0.0:1; community origin-validation-state-valid members 0x4300:0.0.0.0:0; } user@R0# show routing-options autonomous-system 65100; validation { group test { session 10.0.0.10; } } 如果完成设备配置，请从配置模式输入 commit 。",
          "sections": [
            {
              "title": "分步过程",
              "level": 5,
              "step_by_step": [
                {
                  "step": 1,
                  "description": "配置接口。",
                  "code": [
                    "[edit interfaces]",
                    "user@R0# set ge-1/2/0 unit 0 description to-R1",
                    "user@R0# set ge-1/2/0 unit 0 family inet address 10.0.0.2/30",
                    "user@R0# set ge-1/2/1 unit 0 description to-R2",
                    "user@R0# set ge-1/2/1 unit 0 family inet address 10.0.0.5/30",
                    "user@R0# set ge-1/2/2 unit 0 description to-cache",
                    "user@R0# set ge-1/2/2 unit 0 family inet address 10.0.0.9/30",
                    "user@R0# set lo0 unit 0 family inet address 10.0.1.1/32"
                  ]
                },
                {
                  "step": 2,
                  "description": "配置 BGP。",
                  "code": [
                    "[edit protocols bgp]",
                    "user@R0# set group int type internal",
                    "user@R0# set group int local-address 10.0.1.1",
                    "user@R0# set group int export send-direct",
                    "user@R0# set group int neighbor 10.1.1.1",
                    "user@R0# set group ext type external",
                    "user@R0# set group ext import validation",
                    "user@R0# set group ext export send-direct",
                    "user@R0# set group ext peer-as 65200",
                    "user@R0# set group ext neighbor 10.0.0.6"
                  ]
                },
                {
                  "step": 3,
                  "description": "在面向 IBGP 对等方的接口和环路接口上配置 OSPF（或其他内部网关协议 [IGP]）。",
                  "code": [
                    "[edit protocols ospf area 0.0.0.0]",
                    "user@R0# set interface ge-1/2/0.0",
                    "user@R0# set interface lo0.0 passive"
                  ]
                },
                {
                  "step": 4,
                  "description": "配置将路由表中的直接路由导出到 BGP 的路由策略。",
                  "code": [
                    "[edit policy-options policy-statement send-direct]",
                    "user@R0# set from protocol direct",
                    "user@R0# set then accept"
                  ]
                },
                {
                  "step": 5,
                  "description": "配置路由策略，根据每个 BGP 路由的验证状态指定要修改的属性。",
                  "code": [
                    "[edit policy-options policy-statement validation]",
                    "user@R0# set term valid from protocol bgp",
                    "user@R0# set term valid from validation-database valid",
                    "user@R0# set term valid then validation-state valid",
                    "user@R0# set term valid then community add origin-validation-state-valid",
                    "user@R0# set term valid then accept",
                    "user@R0# set term invalid from protocol bgp",
                    "user@R0# set term invalid from validation-database invalid",
                    "user@R0# set term invalid then validation-state invalid",
                    "user@R0# set term invalid then community add origin-validation-state-invalid",
                    "user@R0# set term invalid then reject",
                    "user@R0# set term unknown from protocol bgp",
                    "user@R0# set term unknown then validation-state unknown",
                    "user@R0# set term unknown then community add origin-validation-state-unknown",
                    "user@R0# set term unknown then accept",
                    "[edit policy-options]",
                    "user@R0# set community origin-validation-state-invalid members 0x4300:0.0.0.0:2",
                    "user@R0# set community origin-validation-state-unknown members 0x4300:0.0.0.0:1",
                    "user@R0# set community origin-validation-state-valid members 0x4300:0.0.0.0:0"
                  ]
                },
                {
                  "step": 6,
                  "description": "配置与 RPKI 缓存服务器的会话。",
                  "code": [
                    "[edit routing-options validation]",
                    "user@R0# set group test session 10.0.0.10"
                  ]
                },
                {
                  "step": 7,
                  "description": "配置自治系统 (AS) 编号。",
                  "code": [
                    "[edit routing-options]",
                    "user@R0# set autonomous-system 65100"
                  ]
                }
              ]
            },
            {
              "title": "结果",
              "level": 5,
              "content": "在配置模式下，输入 show interfaces 、 show protocols 、 show policy-options 和 show routing-options 命令，以确认您的配置。如果输出未显示预期的配置，请重复此示例中的说明，以便进行更正。 如果完成设备配置，请从配置模式输入 commit 。",
              "code": [
                "user@R0#show interfacesge-1/2/0 {\n    unit 0 {\n        description to-R1;\n        family inet {\n            address 10.0.0.2/30;\n        }\n    }\n}\nge-1/2/1 {\n    unit 0 {\n        description to-R2;\n        family inet {\n            address 10.0.0.5/30;\n        }\n    }\n}\nge-1/2/2 {\n    unit 0 {\n        description to-cache;\n        family inet {\n            address 10.0.0.9/30;\n        }\n    }\n}\nlo0 {\n    unit 0 {\n        family inet {\n            address 10.0.1.1/32;\n        }\n    }\n}",
                "user@R0#show protocolsbgp {\n    group int {\n        type internal;\n        local-address 10.0.1.1;\n        export send-direct;\n        neighbor 10.1.1.1;\n    }\n    group ext {\n        type external;\n        import validation;\n        export send-direct;\n        peer-as 65200;\n        neighbor 10.0.0.6;\n    }\n}\nospf {\n    area 0.0.0.0 {\n        interface ge-1/2/0.0;\n        interface lo0.0 {\n            passive;\n        }\n    }\n}",
                "user@R0#show policy-optionspolicy-statement send-direct {\n    from protocol direct;\n    then accept;\n}\n    policy-statement validation {\n        term valid {\n            from {\n                protocol bgp;\n                validation-database valid;\n            }\n            then {\n                validation-state valid;\n                community add origin-validation-state-valid;\n                accept;\n            }\n        }\n        term invalid {\n            from {\n                protocol bgp;\n                validation-database invalid;\n            }\n            then {\n                validation-state invalid;\n                community add origin-validation-state-invalid;\n                reject;\n            }\n        }\n        term unknown {\n            from protocol bgp;\n            then {\n                validation-state unknown;\n                community add origin-validation-state-unknown;\n                accept;\n            }\n        }\n    }\ncommunity origin-validation-state-invalid members 0x4300:0.0.0.0:2;\ncommunity origin-validation-state-unknown members 0x4300:0.0.0.0:1;\ncommunity origin-validation-state-valid members 0x4300:0.0.0.0:0;\n}",
                "user@R0#show routing-optionsautonomous-system 65100;\nvalidation {\n    group test {\n        session 10.0.0.10;\n    }\n}"
              ]
            }
          ]
        },
        {
          "title": "配置设备 R1",
          "level": 4,
          "content": "下面的示例要求您在各个配置层级中进行导航。有关导航 CLI 的信息，请参阅《Junos OS CLI 用户指南》中的在配置模式下使用 CLI 编辑器。 要配置设备 R1： 配置接口。 [edit interfaces] user@R1# set ge-1/2/0 unit 0 family inet address 10.0.0.1/30 user@R1# set lo0 unit 0 family inet address 10.1.1.1/32 配置 BGP。 validation-ibgp 应用导入策略，为从设备 R1 的 IBGP 对等方接收的所有路由设置验证状态和 BGP 社区属性。 配置与设备 R0 的 IBGP 会话。 [edit protocols bgp group int] user@R1# set type internal user@R1# set local-address 10.1.1.1 user@R1# set import validation-ibgp user@R1# set neighbor 10.0.1.1 配置 OSPF。 [edit protocols ospf area 0.0.0.0] user@R1# set interface ge-1/2/0.0 user@R1# set interface lo0.0 passive 配置路由策略，该策略根据从设备 R0 接收的 BGP 路由的验证状态 BGP 社区属性指定要修改的属性。 [edit policy-options policy-statement validation-ibgp] user@R1# set term valid from community origin-validation-state-valid user@R1# set term valid then validation-state valid user@R1# set term invalid from community origin-validation-state-invalid user@R1# set term invalid then validation-state invalid user@R1# set term unknown from community origin-validation-state-unknown user@R1# set term unknown then validation-state unknown [edit policy-options] user@R1# set community origin-validation-state-invalid members 0x4300:0.0.0.0:2 user@R1# set community origin-validation-state-unknown members 0x4300:0.0.0.0:1 user@R1# set community origin-validation-state-valid members 0x4300:0.0.0.0:0 配置自治系统 (AS) 编号。 [edit routing-options] user@R1# set autonomous-system 65100 在配置模式下，输入 show interfaces 、 show protocols 、 show policy-options 和 show routing-options 命令，以确认您的配置。如果输出未显示预期的配置，请重复此示例中的说明，以便进行更正。 user@R1# show interfaces ge-1/2/0 { unit 0 { family inet { address 10.0.0.1/30; } } } lo0 { unit 0 { family inet { address 10.1.1.1/32; } } } user@R1# show protocols bgp { group int { type internal; local-address 10.1.1.1; import validation-ibgp; neighbor 10.0.1.1; } } ospf { area 0.0.0.0 { interface ge-1/2/0.0; interface lo0.0 { passive; } } } user@R1# show policy-options policy-statement validation-ibgp { term valid { from community origin-validation-state-valid; then validation-state valid; } term invalid { from community origin-validation-state-invalid; then validation-state invalid; } term unknown { from community origin-validation-state-unknown; then validation-state unknown; } } community origin-validation-state-invalid members 0x4300:0.0.0.0:2; community origin-validation-state-unknown members 0x4300:0.0.0.0:1; community origin-validation-state-valid members 0x4300:0.0.0.0:0; } user@R1# show routing-options autonomous-system 65100; 如果完成设备配置，请从配置模式输入 commit 。",
          "sections": [
            {
              "title": "分步过程",
              "level": 5,
              "step_by_step": [
                {
                  "step": 1,
                  "description": "配置接口。",
                  "code": [
                    "[edit interfaces]",
                    "user@R1# set ge-1/2/0 unit 0 family inet address 10.0.0.1/30",
                    "user@R1# set lo0 unit 0 family inet address 10.1.1.1/32"
                  ]
                },
                {
                  "step": 2,
                  "description": "配置 BGP。",
                  "code": [
                    "[edit protocols bgp group int]",
                    "user@R1# set type internal",
                    "user@R1# set local-address 10.1.1.1",
                    "user@R1# set import validation-ibgp",
                    "user@R1# set neighbor 10.0.1.1"
                  ]
                },
                {
                  "step": 3,
                  "description": "配置 OSPF。",
                  "code": [
                    "[edit protocols ospf area 0.0.0.0]",
                    "user@R1# set interface ge-1/2/0.0",
                    "user@R1# set interface lo0.0 passive"
                  ]
                },
                {
                  "step": 4,
                  "description": "配置路由策略，该策略根据从设备 R0 接收的 BGP 路由的验证状态 BGP 社区属性指定要修改的属性。",
                  "code": [
                    "[edit policy-options policy-statement validation-ibgp]",
                    "user@R1# set term valid from community origin-validation-state-valid",
                    "user@R1# set term valid then validation-state valid",
                    "user@R1# set term invalid from community origin-validation-state-invalid",
                    "user@R1# set term invalid then validation-state invalid",
                    "user@R1# set term unknown from community origin-validation-state-unknown",
                    "user@R1# set term unknown then validation-state unknown",
                    "[edit policy-options]",
                    "user@R1# set community origin-validation-state-invalid members 0x4300:0.0.0.0:2",
                    "user@R1# set community origin-validation-state-unknown members 0x4300:0.0.0.0:1",
                    "user@R1# set community origin-validation-state-valid members 0x4300:0.0.0.0:0"
                  ]
                },
                {
                  "step": 5,
                  "description": "配置自治系统 (AS) 编号。",
                  "code": [
                    "[edit routing-options]",
                    "user@R1# set autonomous-system 65100"
                  ]
                }
              ]
            },
            {
              "title": "结果",
              "level": 5,
              "content": "在配置模式下，输入 show interfaces 、 show protocols 、 show policy-options 和 show routing-options 命令，以确认您的配置。如果输出未显示预期的配置，请重复此示例中的说明，以便进行更正。 如果完成设备配置，请从配置模式输入 commit 。",
              "code": [
                "user@R1#show interfacesge-1/2/0 {\n    unit 0 {\n        family inet {\n            address 10.0.0.1/30;\n        }\n    }\n}\nlo0 {\n    unit 0 {\n        family inet {\n            address 10.1.1.1/32;\n        }\n    }\n}",
                "user@R1#show protocolsbgp {\n    group int {\n        type internal;\n        local-address 10.1.1.1;\n        import validation-ibgp;\n        neighbor 10.0.1.1;\n    }\n}\nospf {\n    area 0.0.0.0 {\n        interface ge-1/2/0.0;\n        interface lo0.0 {\n            passive;\n        }\n    }\n}",
                "user@R1#show policy-optionspolicy-statement validation-ibgp {\n    term valid {\n        from community origin-validation-state-valid;\n        then validation-state valid;\n    }\n    term invalid {\n        from community origin-validation-state-invalid;\n        then validation-state invalid;\n    }\n    term unknown {\n        from community origin-validation-state-unknown;\n        then validation-state unknown;\n    }\n}\ncommunity origin-validation-state-invalid members 0x4300:0.0.0.0:2;\ncommunity origin-validation-state-unknown members 0x4300:0.0.0.0:1;\ncommunity origin-validation-state-valid members 0x4300:0.0.0.0:0;\n}",
                "user@R1#show routing-optionsautonomous-system 65100;"
              ]
            }
          ]
        },
        {
          "title": "配置设备 R2",
          "level": 4,
          "content": "下面的示例要求您在各个配置层级中进行导航。有关导航 CLI 的信息，请参阅《Junos OS CLI 用户指南》中的在配置模式下使用 CLI 编辑器。 要配置设备 R2： 配置接口。 环路接口上配置了多个地址作为演示目的的路由。 [edit interfaces] user@R2# set ge-1/2/0 unit 0 family inet address 10.0.0.6/30 user@R2# set lo0 unit 0 family inet address 172.16.1.1/32 user@R2# set lo0 unit 0 family inet address 192.168.2.3/32 配置 BGP。 [edit protocols bgp] user@R2# set group ext export send-direct user@R2# set group ext peer-as 65100 user@R2# set group ext neighbor 10.0.0.5 配置路由策略。 [edit policy-options policy-statement send-direct] user@R2# set from protocol direct user@R2# set from protocol local user@R2# set then accept 配置自治系统 (AS) 编号。 [edit routing-options] user@R2# set autonomous-system 65200 在配置模式下，输入 show interfaces 、 show protocols 、 show policy-options 和 show routing-options 命令，以确认您的配置。如果输出未显示预期的配置，请重复此示例中的说明，以便进行更正。 user@R2# show interfaces ge-1/2/0 { unit 0 { family inet { address 10.0.0.6/30; } } } lo0 { unit 0 { family inet { address 172.16.1.1/32; address 192.168.2.3/32; } } } user@R2# show protocols bgp { group ext { export send-direct; peer-as 65100; neighbor 10.0.0.5; } } user@R2# show policy-options policy-statement send-direct { from protocol [ direct local ]; then accept; } user@R2# show routing-options autonomous-system 65200; 如果完成设备配置，请从配置模式输入 commit 。",
          "sections": [
            {
              "title": "分步过程",
              "level": 5,
              "step_by_step": [
                {
                  "step": 1,
                  "description": "配置接口。",
                  "code": [
                    "[edit interfaces]",
                    "user@R2# set ge-1/2/0 unit 0 family inet address 10.0.0.6/30",
                    "user@R2# set lo0 unit 0 family inet address 172.16.1.1/32",
                    "user@R2# set lo0 unit 0 family inet address 192.168.2.3/32"
                  ]
                },
                {
                  "step": 2,
                  "description": "配置 BGP。",
                  "code": [
                    "[edit protocols bgp]",
                    "user@R2# set group ext export send-direct",
                    "user@R2# set group ext peer-as 65100",
                    "user@R2# set group ext neighbor 10.0.0.5"
                  ]
                },
                {
                  "step": 3,
                  "description": "配置路由策略。",
                  "code": [
                    "[edit policy-options policy-statement send-direct]",
                    "user@R2# set from protocol direct",
                    "user@R2# set from protocol local",
                    "user@R2# set then accept"
                  ]
                },
                {
                  "step": 4,
                  "description": "配置自治系统 (AS) 编号。",
                  "code": [
                    "[edit routing-options]",
                    "user@R2# set autonomous-system 65200"
                  ]
                }
              ]
            },
            {
              "title": "结果",
              "level": 5,
              "content": "在配置模式下，输入 show interfaces 、 show protocols 、 show policy-options 和 show routing-options 命令，以确认您的配置。如果输出未显示预期的配置，请重复此示例中的说明，以便进行更正。 如果完成设备配置，请从配置模式输入 commit 。",
              "code": [
                "user@R2#show interfacesge-1/2/0 {\n    unit 0 {\n        family inet {\n            address 10.0.0.6/30;\n        }\n    }\n}\nlo0 {\n    unit 0 {\n        family inet {\n            address 172.16.1.1/32;\n            address 192.168.2.3/32;\n        }\n    }\n}",
                "user@R2#show protocolsbgp {\n    group ext {\n        export send-direct;\n        peer-as 65100;\n        neighbor 10.0.0.5;\n    }\n}",
                "user@R2#show policy-optionspolicy-statement send-direct {\n    from protocol [ direct local ];\n    then accept;\n}",
                "user@R2#show routing-optionsautonomous-system 65200;"
              ]
            }
          ]
        }
      ]
    }
  ],
  "content": "此示例说明如何通过确保从预期的自治系统 （AS） 发送（发起）收到的路由通告，在 BGP 对等方之间配置源验证。如果源 AS 已通过验证，则可以使用策略指定依次播发前缀。 要求 此示例具有以下硬件和软件要求： 资源公钥基础结构 （RPKI） 缓存服务器，使用第三方软件对 BGP 前缀进行身份验证。 在通过 TCP 连接与缓存服务器通信的路由设备上运行的 Junos OS 12.2 或更高版本"
}