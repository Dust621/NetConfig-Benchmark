{
  "title": "检查 BGP 层",
  "sections": [
    {
      "title": "验证 BGP 配置",
      "level": 3,
      "content": "目的 要使 BGP 在路由器上运行，您必须定义本地 AS 编号，配置至少一个组，并包含有关组中至少一个对等方的信息（对等方的 IP 地址和 AS 编号）。当 BGP 是 MPLS 网络的一部分时，必须确保为 LSP 配置了等于 BGP 下一跃点的目标 IP 地址，以便安装 BGP 路由时会将 LSP 作为这些路由的下一跃点。 要使 BGP 在路由器上运行，您必须定义本地 AS 编号，配置至少一个组，并包含有关组中至少一个对等方的信息（对等方的 IP 地址和 AS 编号）。当 BGP 是 MPLS 网络的一部分时，必须确保为 LSP 配置了等于 BGP 下一跃点的目标 IP 地址，以便安装 BGP 路由时会将 LSP 作为这些路由的下一跃点。 要验证 BGP 配置，请输入以下 Junos OS CLI 操作模式命令： user@host> show configuration user@R1> show configuration [...Output truncated...] interfaces { so-0/0/0 { unit 0 { family inet { address 10.1.12.1/30; } family iso; family mpls; } } so-0/0/1 { unit 0 { family inet { address 10.1.15.1/30; } family iso; family mpls; } } so-0/0/2 { unit 0 { family inet { address 10.1.13.1/30; } family iso ; family mpls; } } fxp0 { unit 0 { family inet { address 192.168.70.143/21; } } } lo0 { unit 0 { family inet { address 10.0.0.1/32; } family iso { address 49.0004.1000.0000.0001.00; } } } } routing-options { [...Output truncated...] route 100.100.1.0/24 reject ; } router-id 10.0.0.1 ; autonomous-system 65432 ; } protocols { rsvp { interface so-0/0/0.0; interface so-0/0/1.0; interface so-0/0/2.0; interface fxp0.0 { disable; } } mpls { label-switched-path R1-to-R6 { to 10.0.0.6 ; <<< destination address of the LSP } inactive: interface so-0/0/0.0; inactive: interface so-0/0/1.0; interface so-0/0/2.0; interface fxp0.0 { disable; } } bgp { export send-statics; <<< missing local-address statement group internal { type internal; neighbor 10.0.0.2 ; neighbor 10.0.0.5 ; neighbor 10.0.0.4 ; neighbor 10.0.0.6 ; neighbor 10.0.0.3 ; neighbor 10.1.36.2 ; <<< incorrect interface address } } isis { level 1 disable; interface so-0/0/0.0; interface so-0/0/1.0; interface so-0/0/2.0; interface all { level 2 metric 10; } interface fxp0.0 { disable; } interface lo0.0 { passive; } } ospf { traffic-engineering; area 0.0.0.0 { interface so-0/0/0.0; interface so-0/0/1.0; interface so-0/0/2.0; interface lo0.0; { passive } } } } policy-options { policy-statement send-statics { term statics { from { route-filter 100.100.1.0/24 exact; } then accept; } } } user@R6> show configuration [...Output truncated...] interfaces { so-0/0/0 { unit 0 { family inet { address 10.1.56.2/30; } family iso; family mpls; } } so-0/0/1 { unit 0 { family inet { address 10.1.46.2/30; } family iso; family mpls; } } so-0/0/2 { unit 0 { family inet { address 10.1.26.2/30; } family iso; family mpls; } } so-0/0/3 { unit 0 { family inet { address 10.1.36.2/30; } family iso ; family mpls; } } fxp0 { unit 0 { family inet { address 192.168.70.148/21; } } } lo0 { unit 0 { family inet { address 10.0.0.6/32; address 127.0.0.1/32; } family iso { address 49.0004.1000.0000.0006.00; } } } } routing-options { [...Output truncated...] route 100.100.6.0/24 reject ; } router-id 10.0.0.6 ; autonomous-system 65432 ; } protocols { rsvp { interface so-0/0/0.0; interface so-0/0/1.0; interface so-0/0/2.0; interface so-0/0/3.0; interface fxp0.0 { disable; } } mpls { label-switched-path R6-to-R1 { to 10.0.0.1; <<< destination address of the reverse LSP } inactive: interface so-0/0/0.0; inactive: interface so-0/0/1.0; inactive: interface so-0/0/2.0; interface so-0/0/3.0; } bgp { group internal { type internal; export send-statics; <<< missing local-address statement neighbor 10.0.0.2 ; neighbor 10.0.0.3 ; neighbor 10.0.0.4 ; neighbor 10.0.0.5 ; neighbor 10.0.0.1 ; neighbor 10.1.13.1 ; <<< incorrect interface address } } isis { level 1 disable; interface all { level 2 metric 10; } interface fxp0.0 { disable; } interface lo0.0 { passive; } } ospf { traffic-engineering; area 0.0.0.0 { interface so-0/0/0.0; interface so-0/0/1.0; interface so-0/0/2.0; interface so-0/0/3.0; interface lo0.0 { passive; } } } } policy-options { policy-statement send-statics { term statics { from { route-filter 100.100.6.0/24 exact; } then accept; } } } 意义 示例输出显示了入口路由器 R1 和出口路由器 R6 上的 BGP 配置。两种配置均显示配置的本地 AS （ 65432 ）、一组 （ internal ） 和六个对等方。底层内部网关协议为 IS-IS，相关接口配置为运行 IS-IS。 注： 在此配置中，将手动配置 RID 以避免出现任何重复的 RID 问题，并且使用 BGP 配置的所有接口都包含 family inet [ edit interfaces type-fpc/pic/port unit logical-unit-number ] 层次结构级别的语句。 入口路由器 R1 和出口路由器 R6 的示例输出显示 BGP 协议配置缺少 local-address 内部组的语句。配置语句 local-address 后，BGP 数据包将从本地路由器环回 （ lo0 ） 接口地址转发，该地址是 BGP 对等方对等互连的地址。如果未配置该 local-address 语句，则会从传出接口地址转发 BGP 数据包，该地址与 BGP 对等方对等的地址不匹配，并且不会启动 BGP。 在入口路由器上，语句中的 local-address IP 地址 （ 10.0.0.1 ） 应与语句中 to 在 [ edit protocols mpls label-switched-path lsp-path-name ] 层次结构级别的出口路由器 （ R6 ） 上为 LSP 配置的地址相同。BGP 使用此地址（与 LSP 地址相同）通过 LSP 转发 BGP 流量。 此外，上的 R1 BGP 配置包括 的两个 R6 IP 地址，一个接口地址 （ 10.1.36.2 ） 和一个环路 （ lo0 ） 接口地址 （ 10.0.0.6 ），导致 LSP 目标地址 （ 10.0.0.6 ） 与 BGP 下一跃点地址 （ 10.1.36.2 ） 不匹配。上的 R6 BGP 配置还包括 的两个 R1 IP 地址，一个接口地址 （ 10.1.13.1 ） 和一个环路 （ lo0 ） 接口地址，导致反向 LSP 目标地址 （ 10.0.0.1 ） 与 BGP 下一跃点地址 （ 10.1.13.1 ） 不匹配。 在这种情况下，由于两个路由器的 BGP 配置中都缺少该 local-address 语句，并且 LSP 目标地址与 BGP 下一跃点地址不匹配，因此 BGP 不会使用 LSP 转发流量。 示例输出显示了入口路由器 R1 和出口路由器 R6 上的 BGP 配置。两种配置均显示配置的本地 AS （ 65432 ）、一组 （ internal ） 和六个对等方。底层内部网关协议为 IS-IS，相关接口配置为运行 IS-IS。 注： 在此配置中，将手动配置 RID 以避免出现任何重复的 RID 问题，并且使用 BGP 配置的所有接口都包含 family inet [ edit interfaces type-fpc/pic/port unit logical-unit-number ] 层次结构级别的语句。 在此配置中，将手动配置 RID 以避免出现任何重复的 RID 问题，并且使用 BGP 配置的所有接口都包含 family inet [ edit interfaces type-fpc/pic/port unit logical-unit-number ] 层次结构级别的语句。 入口路由器 R1 和出口路由器 R6 的示例输出显示 BGP 协议配置缺少 local-address 内部组的语句。配置语句 local-address 后，BGP 数据包将从本地路由器环回 （ lo0 ） 接口地址转发，该地址是 BGP 对等方对等互连的地址。如果未配置该 local-address 语句，则会从传出接口地址转发 BGP 数据包，该地址与 BGP 对等方对等的地址不匹配，并且不会启动 BGP。 在入口路由器上，语句中的 local-address IP 地址 （ 10.0.0.1 ） 应与语句中 to 在 [ edit protocols mpls label-switched-path lsp-path-name ] 层次结构级别的出口路由器 （ R6 ） 上为 LSP 配置的地址相同。BGP 使用此地址（与 LSP 地址相同）通过 LSP 转发 BGP 流量。 此外，上的 R1 BGP 配置包括 的两个 R6 IP 地址，一个接口地址 （ 10.1.36.2 ） 和一个环路 （ lo0 ） 接口地址 （ 10.0.0.6 ），导致 LSP 目标地址 （ 10.0.0.6 ） 与 BGP 下一跃点地址 （ 10.1.36.2 ） 不匹配。上的 R6 BGP 配置还包括 的两个 R1 IP 地址，一个接口地址 （ 10.1.13.1 ） 和一个环路 （ lo0 ） 接口地址，导致反向 LSP 目标地址 （ 10.0.0.1 ） 与 BGP 下一跃点地址 （ 10.1.13.1 ） 不匹配。 在这种情况下，由于两个路由器的 BGP 配置中都缺少该 local-address 语句，并且 LSP 目标地址与 BGP 下一跃点地址不匹配，因此 BGP 不会使用 LSP 转发流量。"
    }
  ],
  "content": "目的 配置标签交换路径 （LSP） 并确定其已启动、配置 BGP 并确定已建立会话后，请确保 BGP 使用 LSP 转发流量。 图 3 说明了分层 MPLS 模型的 BGP 层。 图 3： 检查 BGP 层 检查 BGP 层时，验证路由是否存在且处于活动状态，更重要的是，请确保下一跃点是 LSP。除非建立 LSP，否则检查 BGP 层是没有意义的，因为 BGP 使用 MPLS LSP 来转发流量。如果网络在 BGP 层无法运行，则 LSP 无法按配置工作。 图 4 说明了本主题中使用的 MPLS 网络。 图 4： MPLS 网络在 BGP 层中断 中显示的 图 4 网络是全网状配置，其中每个直接连接的接口都可以接收数据包并将其发送到其他每个类似接口。此网络中的 LSP 配置为从入口路由器 R1 运行，通过中转路由器 R3 ，到出口路由器 R6 。此外，反向 LSP 配置为从 R6 到 R3 R1 运行，创建双向流量。 中显示的 图 4 交叉指示未使用 BGP 通过 LSP 转发流量的位置。LSP 无法正常工作的可能原因是 LSP 的目标 IP 地址不等于 BGP 下一跃点，或者 BGP 配置不正确"
}