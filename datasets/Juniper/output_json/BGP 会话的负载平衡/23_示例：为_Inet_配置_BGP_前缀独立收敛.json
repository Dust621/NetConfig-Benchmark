{
  "title": "示例：为 Inet 配置 BGP 前缀独立收敛",
  "sections": [
    {
      "title": "要求",
      "level": 3,
      "content": "配置此示例之前，不需要除设备初始化之外的特殊配置。 此示例使用以下硬件和软件组件： 一台带有 MPC 的 MX 系列路由器，用于配置 BGP PIC 功能 七款路由器，可以是 M 系列、MX 系列、T 系列或 PTX 系列路由器的组合 配置了 BGP PIC 的设备上的 Junos OS 15.1 或更高版本 配置此示例之前，不需要除设备初始化之外的特殊配置。 此示例使用以下硬件和软件组件： 一台带有 MPC 的 MX 系列路由器，用于配置 BGP PIC 功能 七款路由器，可以是 M 系列、MX 系列、T 系列或 PTX 系列路由器的组合 配置了 BGP PIC 的设备上的 Junos OS 15.1 或更高版本"
    },
    {
      "title": "概述",
      "level": 3,
      "content": "从 Junos OS 15.1 版开始，最初支持 3 层 VPN 路由器的 BGP PIC 扩展到具有全局表中多个路由的 BGP，例如 inet 和 inet6 单播，以及标记为单播的 inet 和 inet6。除了计算出的到目标的最佳路径之外，BGP 还会向数据包转发引擎安装第二最佳路径。当 IGP 失去对前缀的可访问性时，路由器将使用此备份路径来减少流量损失，直到解决通过 BGP 的全局收敛问题，从而缩短中断持续时间。 注： BGP PIC 功能仅在具有 MPC 的路由器上受支持。 拓扑学 此示例显示了三个客户边缘 （CE） 路由器：设备 CE0、CE1 和 CE2。路由器 PE0、PE1 和 PE2 是提供商边缘 （PE） 路由器。路由器 P0 和 P1 是提供商核心路由器。BGP PIC 在路由器 PE0 上配置。为了进行测试，地址 192.168.1.5 将添加为设备 CE1 上的第二个环路接口地址。该地址通告给路由器 PE1 和 PE2，并由内部 BGP （IBGP） 中继到路由器 PE0。在路由器 PE0 上，有两条路径可以连接到 192.168.1.5 网络。这些是主路径和备份路径。 图 13 显示了示例网络。 图 13： 为 Inet 配置 BGP PIC 从 Junos OS 15.1 版开始，最初支持 3 层 VPN 路由器的 BGP PIC 扩展到具有全局表中多个路由的 BGP，例如 inet 和 inet6 单播，以及标记为单播的 inet 和 inet6。除了计算出的到目标的最佳路径之外，BGP 还会向数据包转发引擎安装第二最佳路径。当 IGP 失去对前缀的可访问性时，路由器将使用此备份路径来减少流量损失，直到解决通过 BGP 的全局收敛问题，从而缩短中断持续时间。 注： BGP PIC 功能仅在具有 MPC 的路由器上受支持。 BGP PIC 功能仅在具有 MPC 的路由器上受支持。 拓扑学 此示例显示了三个客户边缘 （CE） 路由器：设备 CE0、CE1 和 CE2。路由器 PE0、PE1 和 PE2 是提供商边缘 （PE） 路由器。路由器 P0 和 P1 是提供商核心路由器。BGP PIC 在路由器 PE0 上配置。为了进行测试，地址 192.168.1.5 将添加为设备 CE1 上的第二个环路接口地址。该地址通告给路由器 PE1 和 PE2，并由内部 BGP （IBGP） 中继到路由器 PE0。在路由器 PE0 上，有两条路径可以连接到 192.168.1.5 网络。这些是主路径和备份路径。 图 13 显示了示例网络。 图 13： 为 Inet 配置 BGP PIC 此示例显示了三个客户边缘 （CE） 路由器：设备 CE0、CE1 和 CE2。路由器 PE0、PE1 和 PE2 是提供商边缘 （PE） 路由器。路由器 P0 和 P1 是提供商核心路由器。BGP PIC 在路由器 PE0 上配置。为了进行测试，地址 192.168.1.5 将添加为设备 CE1 上的第二个环路接口地址。该地址通告给路由器 PE1 和 PE2，并由内部 BGP （IBGP） 中继到路由器 PE0。在路由器 PE0 上，有两条路径可以连接到 192.168.1.5 网络。这些是主路径和备份路径。 图 13 显示了示例网络。 图 13： 为 Inet 配置 BGP PIC",
      "sections": [
        {
          "title": "拓扑学",
          "level": 4,
          "content": "此示例显示了三个客户边缘 （CE） 路由器：设备 CE0、CE1 和 CE2。路由器 PE0、PE1 和 PE2 是提供商边缘 （PE） 路由器。路由器 P0 和 P1 是提供商核心路由器。BGP PIC 在路由器 PE0 上配置。为了进行测试，地址 192.168.1.5 将添加为设备 CE1 上的第二个环路接口地址。该地址通告给路由器 PE1 和 PE2，并由内部 BGP （IBGP） 中继到路由器 PE0。在路由器 PE0 上，有两条路径可以连接到 192.168.1.5 网络。这些是主路径和备份路径。 图 13 显示了示例网络。 图 13： 为 Inet 配置 BGP PIC",
          "images": [
            "BGP 会话的负载平衡\\images\\23_示例：为_Inet_配置_BGP_前缀独_1.gif"
          ]
        }
      ]
    },
    {
      "title": "配置",
      "level": 3,
      "content": "要快速配置此示例，请复制以下命令，将其粘贴到文本文件中，删除所有换行符，更改与您的网络配置匹配所需的任何详细信息，将命令复制并粘贴到层次结构级别的 CLI [edit] 中，然后从配置模式进入提交。 路由器 PE0 set chassis network-services enhanced-ip set interfaces ge-0/0/0 unit 0 description PE0->P0 set interfaces ge-0/0/0 unit 0 family inet address 10.0.0.5/24 set interfaces ge-0/0/0 unit 0 family iso set interfaces ge-0/0/0 unit 0 family inet6 address 2001:db8::1/32 set interfaces ge-0/0/0 unit 0 family mpls set interfaces ge-0/0/1 unit 0 description PE0->P1 set interfaces ge-0/0/1 unit 0 family inet address 10.0.0.1/24 set interfaces ge-0/0/1 unit 0 family iso set interfaces ge-0/0/1 unit 0 family inet6 address 2001:db8::2/32 set interfaces ge-0/0/1 unit 0 family mpls set interfaces lo0 unit 0 family inet address 192.168.0.1/32 set interfaces ge-0/0/2 unit 0 description PE0->CE0 set interfaces ge-0/0/2 unit 0 family inet address 172.16.0.1/30 set interfaces ge-0/0/2 unit 0 family inet6 address 2001:db8::10/32 set interfaces ge-0/0/2 unit 0 family mpls set protocols mpls ipv6-tunneling set protocols mpls interface all set protocols mpls interface fxp0.0 disable set protocols bgp group ibgp type internal set protocols bgp group ibgp local-address 192.168.0.1 set protocols bgp group ibgp family inet labeled-unicast per-prefix-label set protocols bgp group ibgp family inet6 labeled-unicast explicit-null set protocols bgp group ibgp export nhself set protocols bgp group ibgp neighbor 192.168.0.4 description PE1 set protocols bgp group ibgp neighbor 192.168.0.5 description PE2 set protocols bgp group ebgp type external set protocols bgp group ebgp local address 192.168.0.1 set protocols bgp group ebgp family inet labeled-unicast set protocols bgp group ebgp family inet6 labeled-unicast set protocols bgp group ebgp peer-as 64497 set protocols bgp group ebgp neighbor 172.16.0.2 description CE0 set protocols ospf area 0.0.0.0 interface all set protocols ospf area 0.0.0.0 interface fxp0.0 disable set protocols ospf area 0.0.0.0 interface lo0.0 passive set protocols ospf area 0.0.0.0 interface ge-0/0/1.0 metric 1000 set protocols ospf3 area 0.0.0.0 interface all set protocols ospf3 area 0.0.0.0 interface fxp0.0 disable set protocols ospf3 area 0.0.0.0 interface lo0.0 passive set protocols ospf3 area 0.0.0.0 interface ge-0/0/1.0 metric 1000 set protocols ldp track-igp-metric set protocols ldp interface all set protocols ldp interface fxp0.0 disable set policy-options policy-statement lb then load-balance per-packet set policy-options policy-statement nhself then next-hop self set routing-options protect core set routing-options forwarding-table export lb set routing-options router-id 192.168.0.1 set routing-options autonomous-system 64496 路由器 P0 set chassis network-services enhanced-ip set interfaces ge-0/0/0 unit 0 description P0->PE0 set interfaces ge-0/0/0 unit 0 family inet address 10.0.0.6/24 set interfaces ge-0/0/0 unit 0 family inet6 address 2001:db8::3/32 set interfaces ge-0/0/0 unit 0 family mpls set interfaces ge-0/0/1 unit 0 description P0->PE1 set interfaces ge-0/0/1 unit 0 family inet address 10.0.0.9/24 set interfaces ge-0/0/1 unit 0 family inet6 address 2001:db8::4/32 set interfaces ge-0/0/1 unit 0 family mpls set interfaces lo0 unit 0 family inet address 192.168.0.2/32 set protocols ospf area 0.0.0.0 interface all set protocols ospf area 0.0.0.0 interface fxp0.0 disable set protocols ospf area 0.0.0.0 interface lo0.0 passive set protocols bgp group ibgp type internal set protocols bgp group ibgp local address 192.168.0.1 set protocols bgp group ibgp neighbor 192.168.0.4 description PE1 set protocols bgp group ibgp neighbor 192.168.0.5 description PE2 set routing-options router-id 192.168.0.2 set routing-options autonomous-system 64496 路由器 P1 set chassis network-services enhanced-ip set interfaces ge-0/0/1 unit 0 description P1->PE0 set interfaces ge-0/0/1 unit 0 family inet address 10.0.0.2/24 set interfaces ge-0/0/1 unit 0 family inet6 address 2001:db8::5/32 set interfaces ge-0/0/1 unit 0 family mpls set interfaces ge-0/0/0 unit 0 description P1->PE2 set interfaces ge-0/0/0 unit 0 family inet address 10.0.0.13/24 set interfaces ge-0/0/0 unit 0 family inet6 address 2001:db8::6/32 set interfaces ge-0/0/0 unit 0 family mpls set interfaces lo0 unit 0 family inet address 192.168.0.3/32 set protocols ospf area 0.0.0.0 interface all set protocols ospf area 0.0.0.0 interface fxp0.0 disable set protocols ospf area 0.0.0.0 interface lo0.0 passive set protocols bgp group ibgp type internal set protocols bgp group ibgp local address 192.168.0.3 set protocols bgp group ibgp neighbor 192.168.0.1 description PE0 set protocols bgp group ibgp neighbor 192.168.0.5 description PE2 set routing-options router-id 192.168.0.3 set routing-options autonomous-system 64496 路由器 PE1 set chassis network-services enhanced-ip set interfaces ge-0/0/0 unit 0 description PE1->P0 set interfaces ge-0/0/0 unit 0 family inet address 10.0.0.10/24 set interfaces ge-0/0/0 unit 0 family inet6 address 2001:db8::7/32 set interfaces ge-0/0/0 unit 0 family mpls set interfaces ge-0/0/0 unit 0 family iso set interfaces ge-0/0/1 unit 0 description PE1->CE1 set interfaces ge-0/0/1 unit 0 family inet address 172.16.1.1/30 set interfaces ge-0/0/1 unit 0 family inet6 address 2001:db8::12/32 set interfaces ge-0/0/1 unit 0 family mpls set interfaces lo0 unit 0 family inet address 192.168.0.4/32 set protocols bgp group ibgp type internal set protocols bgp group ibgp local address 192.168.0.4 set protocols bgp group ibgp family inet labeled-unicast per-prefix-label set protocols bgp group ibgp family inet6 labeled-unicast explicit-null set protocols bgp group ibgp export nhself set protocols bgp group ibgp neighbor 192.168.0.1 description PE0 set protocols bgp group ibgp neighbor 192.168.0.5 description PE2 set protocols bgp group ebgp type external set protocols bgp group ebgp local address 192.168.0.4 set protocols bgp group ebgp peer-as 64497 set protocols bgp group ebgp neighbor 172.16.1.2 description CE1 set protocols ospf area 0.0.0.0 interface all set protocols ospf area 0.0.0.0 interface fxp0.0 disable set protocols ospf area 0.0.0.0 interface lo0.0 passive set protocols ospf area 0.0.0.0 interface ge-0/0/1.0 metric 1000 set protocols ospf3 area 0.0.0.0 interface all set protocols ospf3 area 0.0.0.0 interface fxp0.0 disable set protocols ospf3 area 0.0.0.0 interface lo0.0 passive set protocols ospf3 area 0.0.0.0 interface ge-0/0/0.0 metric 1000 set protocols ldp track-igp-metric set protocols ldp interface all set protocols ldp interface fxp0.0 disable set policy-options policy-statement PE1-v6-nh_CE1 from family inet6 set policy-options policy-statement PE1-v6-nh_CE1 then next-hop 2001:DB8::13 set policy-options policy-statement nhself then next-hop self set routing-options router-id 192.168.0.4 set routing-options autonomous-system 64496 set routing-options static route 192.168.1.2 next-hop 172.16.1.2 路由器 PE2 set chassis network-services enhanced-ip set interfaces ge-0/0/0 unit 0 description PE2->P1 set interfaces ge-0/0/0 unit 0 family inet address 10.0.0.14/24 set interfaces ge-0/0/0 unit 0 family inet6 address 2001:db8::8/32 set interfaces ge-0/0/0 unit 0 family mpls set interfaces ge-0/0/0 unit 0 family iso set interfaces ge-0/0/1 unit 0 description PE2->CE2 set interfaces ge-0/0/1 unit 0 family inet address 172.16.2.1/30 set interfaces ge-0/0/1 unit 0 family inet6 address 2001:db8::14/32 set interfaces ge-0/0/1 unit 0 family mpls set interfaces lo0 unit 0 family inet address 192.168.0.5/32 set protocols mpls ipv6-tunneling set protocols mpls interface all set protocols mpls interface fxp0.0 disable set protocols bgp group ibgp type internal set protocols bgp group ibgp local address 192.168.0.5 set protocols bgp group ibgp family inet labeled-unicast per-prefix-label set protocols bgp group ibgp family inet6 labeled-unicast explicit-null set protocols bgp group ibgp export nhself set protocols bgp group ibgp neighbor 192.168.0.4 description PE1 set protocols bgp group ibgp neighbor 192.168.0.1 description PE0 set protocols bgp group ebgp type external set protocols bgp group ebgp local address 192.168.0.5 set protocols bgp group ebgp peer-as 64497 set protocols bgp group ebgp family inet labeled-unicast set protocols bgp group ebgp family inet6 labeled-unicast set protocols bgp group ebgp neighbor 172.16.2.2 description CE2 set protocols ospf area 0.0.0.0 interface all set protocols ospf area 0.0.0.0 interface fxp0.0 disable set protocols ospf area 0.0.0.0 interface lo0.0 passive set protocols ospf area 0.0.0.0 interface ge-0/0/1.0 metric 1000 set protocols ospf3 area 0.0.0.0 interface all set protocols ospf3 area 0.0.0.0 interface fxp0.0 disable set protocols ospf3 area 0.0.0.0 interface lo0.0 passive set protocols ospf3 area 0.0.0.0 interface ge-0/0/0.0 metric 1000 set protocols ldp track-igp-metric set protocols ldp interface all set protocols ldp interface fxp0.0 disable set policy-options policy-statement nhself then next-hop self set routing-options router-id 192.168.0.5 set routing-options autonomous-system 64496 set routing-options static route 192.168.1.3 next-hop 172.16.2.2 设备 CE0 set chassis network-services enhanced-ip set interfaces ge-0/0/2 unit 0 description CE0->PE0 set interfaces ge-0/0/2 unit 0 family inet address 172.16.0.2/30 set interfaces ge-0/0/2 unit 0 family inet6 address 2001:db8::11/32 set interfaces lo0 unit 0 family inet address 192.168.1.1/32 set protocols mpls interface all set protocols bgp group ebgp type external set protocols bgp group ebgp peer-as 64496 set protocols bgp group ebgp family inet labeled-unicast set protocols bgp group ebgp family inet6 labeled-unicast set protocols bgp group ebgp neighbor 172.16.0.1 description PE0 set protocols bgp group ebgp local-address 192.168.1.1 set routing-options autonomous-system 64497 set routing-options router-id 192.168.1.1 设备 CE1 set chassis network-services enhanced-ip set interfaces ge-0/0/2 unit 0 description CE1->PE1 set interfaces ge-0/0/2 unit 0 family inet address 172.16.1.2/30 set interfaces ge-0/0/2 unit 0 family inet6 address 2001:db8::13/32 set interfaces ge-0/0/2 unit 0 family mpls set interfaces lo0 unit 0 family inet address 192.168.1.2/32 set interfaces lo0 unit 0 family inet address 192.168.1.5/24 set protocols mpls interface all set protocols bgp group ebgp type external set protocols bgp group ebgp peer-as 64496 set protocols bgp group ebgp family inet labeled-unicast set protocols bgp group ebgp family inet6 labeled-unicast set protocols bgp group ebgp export send-direct set protocols bgp group ebgp neighbor 172.16.1.1 description PE1 set policy-options policy statement send-direct from protocol direct then accept set routing-options autonomous-system 64497 set routing-options router-id 192.168.1.2 设备 CE2 set chassis network-services enhanced-ip set interfaces ge-0/0/2 unit 0 description CE2->PE2 set interfaces ge-0/0/2 unit 0 family inet address 172.16.2.2/30 set interfaces ge-0/0/2 unit 0 family inet6 address 2001:db8::15/32 set interfaces ge-0/0/2 unit 0 family mpls set interfaces lo0 unit 0 family inet address 192.168.1.3/32 set protocols mpls interface all set protocols bgp group ebgp type external set protocols bgp group ebgp peer-as 64496 set protocols bgp group ebgp family inet labeled-unicast set protocols bgp group ebgp family inet6 labeled-unicast set protocols bgp group ebgp export send-direct set protocols bgp group ebgp neighbor 172.16.2.1 description PE2 set policy-options policy statement send-direct from protocol direct then accept set routing-options autonomous-system 64497 set routing-options router-id 192.168.1.3 以下示例要求您在配置层次结构中导航各个级别。有关导航 CLI 的信息，请参阅《Junos OS CLI 用户指南》中的在配置模式下使用 CLI 编辑器。 要配置设备 PE0： 在配备模块化端口集中器 （MPC） 的路由器上，启用增强型 IP 网络服务。 [edit chassis] usr@PE0# set network-services enhanced-ip 配置设备接口。 [edit interfaces] user@PE0# set ge-0/0/0 unit 0 description PE0->P0 user@PE0# set ge-0/0/0 unit 0 family inet address 10.0.0.5/24 user@PE0# set ge-0/0/0 unit 0 family iso user@PE0# set ge-0/0/0 unit 0 family inet6 address 2001:db8::1/32 user@PE0# set ge-0/0/0 unit 0 family mpls user@PE0# set ge-0/0/1 unit 0 description PE0->P1 user@PE0# set ge-0/0/1 unit 0 family inet address 10.0.0.1/24 user@PE0# set ge-0/0/1 unit 0 family iso user@PE0# set ge-0/0/1 unit 0 family inet6 address 2001:db8::2/32 user@PE0# set ge-0/0/1 unit 0 family mpls user@PE0# set ge-0/0/2 unit 0 description PE0->CE0 user@PE0# set ge-0/0/2 unit 0 family inet address 172.16.0.1/30 user@PE0# set ge-0/0/2 unit 0 family inet6 address 2001:db8::10/32 user@PE0# set ge-0/0/2 unit 0 family mpls 配置环路接口。 [edit interfaces] user@PE0# set lo0 unit 0 family inet address 192.168.0.1/32 在所有接口（管理接口除外）上配置 MPLS 和 LDP。 [edit protocols] user@PE0# set mpls ipv6-tunneling user@PE0# set mpls interface all user@PE0# set mpls interface fxp0.0 disable user@PE0# set ldp track-igp-metric user@PE0# set ldp interface all user@PE0# set ldp interface fxp0.0 disable 在面向核心的接口上配置 IGP。 [edit protocols] user@PE0# set ospf area 0.0.0.0 interface all user@PE0# set ospf area 0.0.0.0 interface fxp0.0 disable user@PE0# set ospf area 0.0.0.0 interface lo0.0 passive user@PE0# set ospf area 0.0.0.0 interface ge-0/0/1.0 metric 1000 user@PE0# set ospf3 area 0.0.0.0 interface all user@PE0# set ospf3 area 0.0.0.0 interface fxp0.0 disable user@PE0# set ospf3 area 0.0.0.0 interface lo0.0 passive user@PE0# set ospf3 area 0.0.0.0 interface ge-0/0/1.0 metric 1000 配置与其他 PE 设备的 IBGP 连接。 [edit protocols] user@PE0# set bgp group ibgp type internal user@PE0# set bgp group ibgp local-address 192.168.0.1 user@PE0# set bgp group ibgp family inet labeled-unicast per-prefix-label user@PE0# set bgp group ibgp family inet6 labeled-unicast explicit-null user@PE0# set bgp group ibgp export nhself user@PE0# set bgp group ibgp neighbor 192.168.0.4 description PE1 user@PE0# set bgp group ibgp neighbor 192.168.0.5 description PE2 配置与客户设备的 EBGP 连接。 [edit protocols] user@PE0# set bgp group ebgp type external user@PE0# set bgp group ebgp local address 192.168.0.1 user@PE0# set bgp group ebgp family inet labeled-unicast user@PE0# set bgp group ebgp family inet6 labeled-unicast user@PE0# set bgp group ebgp peer-as 64497 user@PE0# set bgp group ebgp neighbor 172.16.0.2 description CE0 配置负载均衡策略。 [edit policy-options] user@PE0# set policy-statement lb then load-balance per-packet 配置下一跃点自我策略。 [edit policy-options] user@PE0# set policy-statement nhself then next-hop self 启用 BGP PIC 边缘功能。 [edit routing-options] user@PE0# set protect core 应用负载平衡策略。 [edit routing-options] user@PE0# set forwarding-table export lb 分配路由器 ID 和自治系统 (AS) 编号。 [edit routing-options] user@PE0# set router-id 192.168.0.2 user@PE0# set autonomous-system 64496 在配置模式下，输入 show chassis 、 show interfaces 、 show policy-options show protocols 和 show routing-options 命令来确认您的配置。如果输出未显示预期的配置，请重复此示例中的说明，以便进行更正。 [edit] user@PE0# show chassis network-services enhanced-ip; [edit] user@PE0# show interfaces ge-0/0/0 { unit 0 { description PE0->P0; family inet { address 10.0.0.5/24; } family iso; family inet6 { address 2001:db8::1/32; } family mpls; } } ge-0/0/1 { unit 0 { description PE0->P1; family inet { address 10.0.0.1/24; } family iso; family inet6 { address 2001:db8::2/32; } family mpls; } } ge-0/0/2 { unit 0 { description PE0->CE0; family inet { address 172.16.0.1/30; } family inet6 { address 2001:db8::10/32; } family mpls; } } lo0 { unit 0 { family inet { address 192.168.0.1/32; } } } [edit] user@PE0# show protocols mpls { ipv6-tunneling; interface all; interface fxp0.0 { disable; } } bgp { group ibgp { type internal; local-address 192.168.0.1; family inet { labeled-unicast { per-prefix-label; } } family inet6 { labeled-unicast { explicit-null; } } export nhself; neighbor 192.168.0.4 { description PE1; } neighbor 192.168.0.5 { description PE2; } } group ebgp { type external; local-address 192.168.0.1; family inet { labeled-unicast; } family inet6 { labeled-unicast; } peer-as 64497; neighbor 172.16.0.2 { description CE0; } } } ospf { area 0.0.0.0 { interface all; interface lo0.0 { passive; } interface ge-0/0/1.0 { metric 1000; } interface fxp0.0 { disable; } } } ospf3 { area 0.0.0.0 { interface all; interface lo0.0 { passive; } interface ge-0/0/1.0 { metric 1000; } interface fxp0.0 { disable; } } } ldp { track-igp-metric; interface all; interface fxp0.0 { disable; } } [edit] user@PE1# show policy-options policy-statement lb { then { load-balance per-packet; } } policy-statement nhself { then { next-hop self; } } [edit] user@PE0# show routing-options protect core; router-id 192.168.0.1; autonomous system 64496 forwarding-table { export lb; }",
      "sections": [
        {
          "title": "CLI 快速配置",
          "level": 4,
          "content": "要快速配置此示例，请复制以下命令，将其粘贴到文本文件中，删除所有换行符，更改与您的网络配置匹配所需的任何详细信息，将命令复制并粘贴到层次结构级别的 CLI [edit] 中，然后从配置模式进入提交。 路由器 PE0 set chassis network-services enhanced-ip set interfaces ge-0/0/0 unit 0 description PE0->P0 set interfaces ge-0/0/0 unit 0 family inet address 10.0.0.5/24 set interfaces ge-0/0/0 unit 0 family iso set interfaces ge-0/0/0 unit 0 family inet6 address 2001:db8::1/32 set interfaces ge-0/0/0 unit 0 family mpls set interfaces ge-0/0/1 unit 0 description PE0->P1 set interfaces ge-0/0/1 unit 0 family inet address 10.0.0.1/24 set interfaces ge-0/0/1 unit 0 family iso set interfaces ge-0/0/1 unit 0 family inet6 address 2001:db8::2/32 set interfaces ge-0/0/1 unit 0 family mpls set interfaces lo0 unit 0 family inet address 192.168.0.1/32 set interfaces ge-0/0/2 unit 0 description PE0->CE0 set interfaces ge-0/0/2 unit 0 family inet address 172.16.0.1/30 set interfaces ge-0/0/2 unit 0 family inet6 address 2001:db8::10/32 set interfaces ge-0/0/2 unit 0 family mpls set protocols mpls ipv6-tunneling set protocols mpls interface all set protocols mpls interface fxp0.0 disable set protocols bgp group ibgp type internal set protocols bgp group ibgp local-address 192.168.0.1 set protocols bgp group ibgp family inet labeled-unicast per-prefix-label set protocols bgp group ibgp family inet6 labeled-unicast explicit-null set protocols bgp group ibgp export nhself set protocols bgp group ibgp neighbor 192.168.0.4 description PE1 set protocols bgp group ibgp neighbor 192.168.0.5 description PE2 set protocols bgp group ebgp type external set protocols bgp group ebgp local address 192.168.0.1 set protocols bgp group ebgp family inet labeled-unicast set protocols bgp group ebgp family inet6 labeled-unicast set protocols bgp group ebgp peer-as 64497 set protocols bgp group ebgp neighbor 172.16.0.2 description CE0 set protocols ospf area 0.0.0.0 interface all set protocols ospf area 0.0.0.0 interface fxp0.0 disable set protocols ospf area 0.0.0.0 interface lo0.0 passive set protocols ospf area 0.0.0.0 interface ge-0/0/1.0 metric 1000 set protocols ospf3 area 0.0.0.0 interface all set protocols ospf3 area 0.0.0.0 interface fxp0.0 disable set protocols ospf3 area 0.0.0.0 interface lo0.0 passive set protocols ospf3 area 0.0.0.0 interface ge-0/0/1.0 metric 1000 set protocols ldp track-igp-metric set protocols ldp interface all set protocols ldp interface fxp0.0 disable set policy-options policy-statement lb then load-balance per-packet set policy-options policy-statement nhself then next-hop self set routing-options protect core set routing-options forwarding-table export lb set routing-options router-id 192.168.0.1 set routing-options autonomous-system 64496 路由器 P0 set chassis network-services enhanced-ip set interfaces ge-0/0/0 unit 0 description P0->PE0 set interfaces ge-0/0/0 unit 0 family inet address 10.0.0.6/24 set interfaces ge-0/0/0 unit 0 family inet6 address 2001:db8::3/32 set interfaces ge-0/0/0 unit 0 family mpls set interfaces ge-0/0/1 unit 0 description P0->PE1 set interfaces ge-0/0/1 unit 0 family inet address 10.0.0.9/24 set interfaces ge-0/0/1 unit 0 family inet6 address 2001:db8::4/32 set interfaces ge-0/0/1 unit 0 family mpls set interfaces lo0 unit 0 family inet address 192.168.0.2/32 set protocols ospf area 0.0.0.0 interface all set protocols ospf area 0.0.0.0 interface fxp0.0 disable set protocols ospf area 0.0.0.0 interface lo0.0 passive set protocols bgp group ibgp type internal set protocols bgp group ibgp local address 192.168.0.1 set protocols bgp group ibgp neighbor 192.168.0.4 description PE1 set protocols bgp group ibgp neighbor 192.168.0.5 description PE2 set routing-options router-id 192.168.0.2 set routing-options autonomous-system 64496 路由器 P1 set chassis network-services enhanced-ip set interfaces ge-0/0/1 unit 0 description P1->PE0 set interfaces ge-0/0/1 unit 0 family inet address 10.0.0.2/24 set interfaces ge-0/0/1 unit 0 family inet6 address 2001:db8::5/32 set interfaces ge-0/0/1 unit 0 family mpls set interfaces ge-0/0/0 unit 0 description P1->PE2 set interfaces ge-0/0/0 unit 0 family inet address 10.0.0.13/24 set interfaces ge-0/0/0 unit 0 family inet6 address 2001:db8::6/32 set interfaces ge-0/0/0 unit 0 family mpls set interfaces lo0 unit 0 family inet address 192.168.0.3/32 set protocols ospf area 0.0.0.0 interface all set protocols ospf area 0.0.0.0 interface fxp0.0 disable set protocols ospf area 0.0.0.0 interface lo0.0 passive set protocols bgp group ibgp type internal set protocols bgp group ibgp local address 192.168.0.3 set protocols bgp group ibgp neighbor 192.168.0.1 description PE0 set protocols bgp group ibgp neighbor 192.168.0.5 description PE2 set routing-options router-id 192.168.0.3 set routing-options autonomous-system 64496 路由器 PE1 set chassis network-services enhanced-ip set interfaces ge-0/0/0 unit 0 description PE1->P0 set interfaces ge-0/0/0 unit 0 family inet address 10.0.0.10/24 set interfaces ge-0/0/0 unit 0 family inet6 address 2001:db8::7/32 set interfaces ge-0/0/0 unit 0 family mpls set interfaces ge-0/0/0 unit 0 family iso set interfaces ge-0/0/1 unit 0 description PE1->CE1 set interfaces ge-0/0/1 unit 0 family inet address 172.16.1.1/30 set interfaces ge-0/0/1 unit 0 family inet6 address 2001:db8::12/32 set interfaces ge-0/0/1 unit 0 family mpls set interfaces lo0 unit 0 family inet address 192.168.0.4/32 set protocols bgp group ibgp type internal set protocols bgp group ibgp local address 192.168.0.4 set protocols bgp group ibgp family inet labeled-unicast per-prefix-label set protocols bgp group ibgp family inet6 labeled-unicast explicit-null set protocols bgp group ibgp export nhself set protocols bgp group ibgp neighbor 192.168.0.1 description PE0 set protocols bgp group ibgp neighbor 192.168.0.5 description PE2 set protocols bgp group ebgp type external set protocols bgp group ebgp local address 192.168.0.4 set protocols bgp group ebgp peer-as 64497 set protocols bgp group ebgp neighbor 172.16.1.2 description CE1 set protocols ospf area 0.0.0.0 interface all set protocols ospf area 0.0.0.0 interface fxp0.0 disable set protocols ospf area 0.0.0.0 interface lo0.0 passive set protocols ospf area 0.0.0.0 interface ge-0/0/1.0 metric 1000 set protocols ospf3 area 0.0.0.0 interface all set protocols ospf3 area 0.0.0.0 interface fxp0.0 disable set protocols ospf3 area 0.0.0.0 interface lo0.0 passive set protocols ospf3 area 0.0.0.0 interface ge-0/0/0.0 metric 1000 set protocols ldp track-igp-metric set protocols ldp interface all set protocols ldp interface fxp0.0 disable set policy-options policy-statement PE1-v6-nh_CE1 from family inet6 set policy-options policy-statement PE1-v6-nh_CE1 then next-hop 2001:DB8::13 set policy-options policy-statement nhself then next-hop self set routing-options router-id 192.168.0.4 set routing-options autonomous-system 64496 set routing-options static route 192.168.1.2 next-hop 172.16.1.2 路由器 PE2 set chassis network-services enhanced-ip set interfaces ge-0/0/0 unit 0 description PE2->P1 set interfaces ge-0/0/0 unit 0 family inet address 10.0.0.14/24 set interfaces ge-0/0/0 unit 0 family inet6 address 2001:db8::8/32 set interfaces ge-0/0/0 unit 0 family mpls set interfaces ge-0/0/0 unit 0 family iso set interfaces ge-0/0/1 unit 0 description PE2->CE2 set interfaces ge-0/0/1 unit 0 family inet address 172.16.2.1/30 set interfaces ge-0/0/1 unit 0 family inet6 address 2001:db8::14/32 set interfaces ge-0/0/1 unit 0 family mpls set interfaces lo0 unit 0 family inet address 192.168.0.5/32 set protocols mpls ipv6-tunneling set protocols mpls interface all set protocols mpls interface fxp0.0 disable set protocols bgp group ibgp type internal set protocols bgp group ibgp local address 192.168.0.5 set protocols bgp group ibgp family inet labeled-unicast per-prefix-label set protocols bgp group ibgp family inet6 labeled-unicast explicit-null set protocols bgp group ibgp export nhself set protocols bgp group ibgp neighbor 192.168.0.4 description PE1 set protocols bgp group ibgp neighbor 192.168.0.1 description PE0 set protocols bgp group ebgp type external set protocols bgp group ebgp local address 192.168.0.5 set protocols bgp group ebgp peer-as 64497 set protocols bgp group ebgp family inet labeled-unicast set protocols bgp group ebgp family inet6 labeled-unicast set protocols bgp group ebgp neighbor 172.16.2.2 description CE2 set protocols ospf area 0.0.0.0 interface all set protocols ospf area 0.0.0.0 interface fxp0.0 disable set protocols ospf area 0.0.0.0 interface lo0.0 passive set protocols ospf area 0.0.0.0 interface ge-0/0/1.0 metric 1000 set protocols ospf3 area 0.0.0.0 interface all set protocols ospf3 area 0.0.0.0 interface fxp0.0 disable set protocols ospf3 area 0.0.0.0 interface lo0.0 passive set protocols ospf3 area 0.0.0.0 interface ge-0/0/0.0 metric 1000 set protocols ldp track-igp-metric set protocols ldp interface all set protocols ldp interface fxp0.0 disable set policy-options policy-statement nhself then next-hop self set routing-options router-id 192.168.0.5 set routing-options autonomous-system 64496 set routing-options static route 192.168.1.3 next-hop 172.16.2.2 设备 CE0 set chassis network-services enhanced-ip set interfaces ge-0/0/2 unit 0 description CE0->PE0 set interfaces ge-0/0/2 unit 0 family inet address 172.16.0.2/30 set interfaces ge-0/0/2 unit 0 family inet6 address 2001:db8::11/32 set interfaces lo0 unit 0 family inet address 192.168.1.1/32 set protocols mpls interface all set protocols bgp group ebgp type external set protocols bgp group ebgp peer-as 64496 set protocols bgp group ebgp family inet labeled-unicast set protocols bgp group ebgp family inet6 labeled-unicast set protocols bgp group ebgp neighbor 172.16.0.1 description PE0 set protocols bgp group ebgp local-address 192.168.1.1 set routing-options autonomous-system 64497 set routing-options router-id 192.168.1.1 设备 CE1 set chassis network-services enhanced-ip set interfaces ge-0/0/2 unit 0 description CE1->PE1 set interfaces ge-0/0/2 unit 0 family inet address 172.16.1.2/30 set interfaces ge-0/0/2 unit 0 family inet6 address 2001:db8::13/32 set interfaces ge-0/0/2 unit 0 family mpls set interfaces lo0 unit 0 family inet address 192.168.1.2/32 set interfaces lo0 unit 0 family inet address 192.168.1.5/24 set protocols mpls interface all set protocols bgp group ebgp type external set protocols bgp group ebgp peer-as 64496 set protocols bgp group ebgp family inet labeled-unicast set protocols bgp group ebgp family inet6 labeled-unicast set protocols bgp group ebgp export send-direct set protocols bgp group ebgp neighbor 172.16.1.1 description PE1 set policy-options policy statement send-direct from protocol direct then accept set routing-options autonomous-system 64497 set routing-options router-id 192.168.1.2 设备 CE2 set chassis network-services enhanced-ip set interfaces ge-0/0/2 unit 0 description CE2->PE2 set interfaces ge-0/0/2 unit 0 family inet address 172.16.2.2/30 set interfaces ge-0/0/2 unit 0 family inet6 address 2001:db8::15/32 set interfaces ge-0/0/2 unit 0 family mpls set interfaces lo0 unit 0 family inet address 192.168.1.3/32 set protocols mpls interface all set protocols bgp group ebgp type external set protocols bgp group ebgp peer-as 64496 set protocols bgp group ebgp family inet labeled-unicast set protocols bgp group ebgp family inet6 labeled-unicast set protocols bgp group ebgp export send-direct set protocols bgp group ebgp neighbor 172.16.2.1 description PE2 set policy-options policy statement send-direct from protocol direct then accept set routing-options autonomous-system 64497 set routing-options router-id 192.168.1.3",
          "commands_by_device": {
            "路由器 PE0": "set chassis network-services enhanced-ip\nset interfaces ge-0/0/0 unit 0 description PE0->P0\nset interfaces ge-0/0/0 unit 0 family inet address 10.0.0.5/24\nset interfaces ge-0/0/0 unit 0 family iso\nset interfaces ge-0/0/0 unit 0 family inet6 address 2001:db8::1/32\nset interfaces ge-0/0/0 unit 0 family mpls\nset interfaces ge-0/0/1 unit 0 description PE0->P1\nset interfaces ge-0/0/1 unit 0 family inet address 10.0.0.1/24\nset interfaces ge-0/0/1 unit 0 family iso\nset interfaces ge-0/0/1 unit 0 family inet6 address 2001:db8::2/32\nset interfaces ge-0/0/1 unit 0 family mpls\nset interfaces lo0 unit 0 family inet address 192.168.0.1/32\nset interfaces ge-0/0/2 unit 0 description PE0->CE0\nset interfaces ge-0/0/2 unit 0 family inet address 172.16.0.1/30\nset interfaces ge-0/0/2 unit 0 family inet6 address 2001:db8::10/32\nset interfaces ge-0/0/2 unit 0 family mpls\nset protocols mpls ipv6-tunneling\nset protocols mpls interface all\nset protocols mpls interface fxp0.0 disable\nset protocols bgp group ibgp type internal\nset protocols bgp group ibgp local-address 192.168.0.1\nset protocols bgp group ibgp family inet labeled-unicast per-prefix-label\nset protocols bgp group ibgp family inet6 labeled-unicast explicit-null\nset protocols bgp group ibgp export nhself\nset protocols bgp group ibgp neighbor 192.168.0.4 description PE1\nset protocols bgp group ibgp neighbor 192.168.0.5 description PE2\nset protocols bgp group ebgp type external\nset protocols bgp group ebgp local address 192.168.0.1\nset protocols bgp group ebgp family inet labeled-unicast\nset protocols bgp group ebgp family inet6 labeled-unicast\nset protocols bgp group ebgp peer-as 64497\nset protocols bgp group ebgp neighbor 172.16.0.2 description CE0\nset protocols ospf area 0.0.0.0 interface all\nset protocols ospf area 0.0.0.0 interface fxp0.0 disable\nset protocols ospf area 0.0.0.0 interface lo0.0 passive\nset protocols ospf area 0.0.0.0 interface ge-0/0/1.0 metric 1000\nset protocols ospf3 area 0.0.0.0 interface all\nset protocols ospf3 area 0.0.0.0 interface fxp0.0 disable\nset protocols ospf3 area 0.0.0.0 interface lo0.0 passive\nset protocols ospf3 area 0.0.0.0 interface ge-0/0/1.0 metric 1000\nset protocols ldp track-igp-metric\nset protocols ldp interface all\nset protocols ldp interface fxp0.0 disable\nset policy-options policy-statement lb then load-balance per-packet\nset policy-options policy-statement nhself then next-hop self\nset routing-options protect core\nset routing-options forwarding-table export lb\nset routing-options router-id 192.168.0.1\nset routing-options autonomous-system 64496",
            "路由器 P0": "set chassis network-services enhanced-ip\nset interfaces ge-0/0/0 unit 0 description P0->PE0\nset interfaces ge-0/0/0 unit 0 family inet address 10.0.0.6/24\nset interfaces ge-0/0/0 unit 0 family inet6 address 2001:db8::3/32\nset interfaces ge-0/0/0 unit 0 family mpls\nset interfaces ge-0/0/1 unit 0 description P0->PE1\nset interfaces ge-0/0/1 unit 0 family inet address 10.0.0.9/24\nset interfaces ge-0/0/1 unit 0 family inet6 address 2001:db8::4/32\nset interfaces ge-0/0/1 unit 0 family mpls\nset interfaces lo0 unit 0 family inet address 192.168.0.2/32\nset protocols ospf area 0.0.0.0 interface all\nset protocols ospf area 0.0.0.0 interface fxp0.0 disable\nset protocols ospf area 0.0.0.0 interface lo0.0 passive\nset protocols bgp group ibgp type internal\nset protocols bgp group ibgp local address 192.168.0.1\nset protocols bgp group ibgp neighbor 192.168.0.4 description PE1\nset protocols bgp group ibgp neighbor 192.168.0.5 description PE2\nset routing-options router-id 192.168.0.2\nset routing-options autonomous-system 64496",
            "路由器 P1": "set chassis network-services enhanced-ip\nset interfaces ge-0/0/1 unit 0 description P1->PE0\nset interfaces ge-0/0/1 unit 0 family inet address 10.0.0.2/24\nset interfaces ge-0/0/1 unit 0 family inet6 address 2001:db8::5/32\nset interfaces ge-0/0/1 unit 0 family mpls\nset interfaces ge-0/0/0 unit 0 description P1->PE2\nset interfaces ge-0/0/0 unit 0 family inet address 10.0.0.13/24\nset interfaces ge-0/0/0 unit 0 family inet6 address 2001:db8::6/32\nset interfaces ge-0/0/0 unit 0 family mpls\nset interfaces lo0 unit 0 family inet address 192.168.0.3/32\nset protocols ospf area 0.0.0.0 interface all\nset protocols ospf area 0.0.0.0 interface fxp0.0 disable\nset protocols ospf area 0.0.0.0 interface lo0.0 passive\nset protocols bgp group ibgp type internal\nset protocols bgp group ibgp local address 192.168.0.3\nset protocols bgp group ibgp neighbor 192.168.0.1 description PE0\nset protocols bgp group ibgp neighbor 192.168.0.5 description PE2\nset routing-options router-id 192.168.0.3\nset routing-options autonomous-system 64496",
            "路由器 PE1": "set chassis network-services enhanced-ip\nset interfaces ge-0/0/0 unit 0 description PE1->P0\nset interfaces ge-0/0/0 unit 0 family inet address 10.0.0.10/24\nset interfaces ge-0/0/0 unit 0 family inet6 address 2001:db8::7/32\nset interfaces ge-0/0/0 unit 0 family mpls\nset interfaces ge-0/0/0 unit 0 family iso\nset interfaces ge-0/0/1 unit 0 description PE1->CE1\nset interfaces ge-0/0/1 unit 0 family inet address 172.16.1.1/30\nset interfaces ge-0/0/1 unit 0 family inet6 address 2001:db8::12/32\nset interfaces ge-0/0/1 unit 0 family mpls\nset interfaces lo0 unit 0 family inet address 192.168.0.4/32\nset protocols bgp group ibgp type internal\nset protocols bgp group ibgp local address 192.168.0.4\nset protocols bgp group ibgp family inet labeled-unicast per-prefix-label\nset protocols bgp group ibgp family inet6 labeled-unicast explicit-null\nset protocols bgp group ibgp export nhself\nset protocols bgp group ibgp neighbor 192.168.0.1 description PE0\nset protocols bgp group ibgp neighbor 192.168.0.5 description PE2\nset protocols bgp group ebgp type external\nset protocols bgp group ebgp local address 192.168.0.4\nset protocols bgp group ebgp peer-as 64497\nset protocols bgp group ebgp neighbor 172.16.1.2 description CE1\nset protocols ospf area 0.0.0.0 interface all\nset protocols ospf area 0.0.0.0 interface fxp0.0 disable\nset protocols ospf area 0.0.0.0 interface lo0.0 passive\nset protocols ospf area 0.0.0.0 interface ge-0/0/1.0 metric 1000\nset protocols ospf3 area 0.0.0.0 interface all\nset protocols ospf3 area 0.0.0.0 interface fxp0.0 disable\nset protocols ospf3 area 0.0.0.0 interface lo0.0 passive\nset protocols ospf3 area 0.0.0.0 interface ge-0/0/0.0 metric 1000\nset protocols ldp track-igp-metric\nset protocols ldp interface all\nset protocols ldp interface fxp0.0 disable\nset policy-options policy-statement PE1-v6-nh_CE1 from family inet6\nset policy-options policy-statement PE1-v6-nh_CE1 then next-hop 2001:DB8::13\nset policy-options policy-statement nhself then next-hop self\nset routing-options router-id 192.168.0.4\nset routing-options autonomous-system 64496\nset routing-options static route 192.168.1.2 next-hop 172.16.1.2",
            "路由器 PE2": "set chassis network-services enhanced-ip\nset interfaces ge-0/0/0 unit 0 description PE2->P1\nset interfaces ge-0/0/0 unit 0 family inet address 10.0.0.14/24\nset interfaces ge-0/0/0 unit 0 family inet6 address 2001:db8::8/32\nset interfaces ge-0/0/0 unit 0 family mpls\nset interfaces ge-0/0/0 unit 0 family iso\nset interfaces ge-0/0/1 unit 0 description PE2->CE2\nset interfaces ge-0/0/1 unit 0 family inet address 172.16.2.1/30\nset interfaces ge-0/0/1 unit 0 family inet6 address 2001:db8::14/32\nset interfaces ge-0/0/1 unit 0 family mpls\nset interfaces lo0 unit 0 family inet address 192.168.0.5/32\nset protocols mpls ipv6-tunneling\nset protocols mpls interface all\nset protocols mpls interface fxp0.0 disable\nset protocols bgp group ibgp type internal\nset protocols bgp group ibgp local address 192.168.0.5\nset protocols bgp group ibgp family inet labeled-unicast per-prefix-label\nset protocols bgp group ibgp family inet6 labeled-unicast explicit-null\nset protocols bgp group ibgp export nhself\nset protocols bgp group ibgp neighbor 192.168.0.4 description PE1\nset protocols bgp group ibgp neighbor 192.168.0.1 description PE0\nset protocols bgp group ebgp type external\nset protocols bgp group ebgp local address 192.168.0.5\nset protocols bgp group ebgp peer-as 64497\nset protocols bgp group ebgp family inet labeled-unicast\nset protocols bgp group ebgp family inet6 labeled-unicast\nset protocols bgp group ebgp neighbor 172.16.2.2 description CE2\nset protocols ospf area 0.0.0.0 interface all\nset protocols ospf area 0.0.0.0 interface fxp0.0 disable\nset protocols ospf area 0.0.0.0 interface lo0.0 passive\nset protocols ospf area 0.0.0.0 interface ge-0/0/1.0 metric 1000\nset protocols ospf3 area 0.0.0.0 interface all\nset protocols ospf3 area 0.0.0.0 interface fxp0.0 disable\nset protocols ospf3 area 0.0.0.0 interface lo0.0 passive\nset protocols ospf3 area 0.0.0.0 interface ge-0/0/0.0 metric 1000\nset protocols ldp track-igp-metric\nset protocols ldp interface all\nset protocols ldp interface fxp0.0 disable\nset policy-options policy-statement nhself then next-hop self\nset routing-options router-id 192.168.0.5\nset routing-options autonomous-system 64496\nset routing-options static route 192.168.1.3 next-hop 172.16.2.2",
            "设备 CE0": "set chassis network-services enhanced-ip\nset interfaces ge-0/0/2 unit 0 description CE0->PE0\nset interfaces ge-0/0/2 unit 0 family inet address 172.16.0.2/30\nset interfaces ge-0/0/2 unit 0 family inet6 address 2001:db8::11/32\nset interfaces lo0 unit 0 family inet address 192.168.1.1/32\nset protocols mpls interface all\nset protocols bgp group ebgp type external\nset protocols bgp group ebgp peer-as 64496\nset protocols bgp group ebgp family inet labeled-unicast\nset protocols bgp group ebgp family inet6 labeled-unicast\nset protocols bgp group ebgp neighbor 172.16.0.1 description PE0\nset protocols bgp group ebgp local-address 192.168.1.1\nset routing-options autonomous-system 64497\nset routing-options router-id 192.168.1.1",
            "设备 CE1": "set chassis network-services enhanced-ip\nset interfaces ge-0/0/2 unit 0 description CE1->PE1\nset interfaces ge-0/0/2 unit 0 family inet address 172.16.1.2/30\nset interfaces ge-0/0/2 unit 0 family inet6 address 2001:db8::13/32\nset interfaces ge-0/0/2 unit 0 family mpls\nset interfaces lo0 unit 0 family inet address 192.168.1.2/32\nset interfaces lo0 unit 0 family inet address 192.168.1.5/24\nset protocols mpls interface all\nset protocols bgp group ebgp type external\nset protocols bgp group ebgp peer-as 64496\nset protocols bgp group ebgp family inet labeled-unicast\nset protocols bgp group ebgp family inet6 labeled-unicast\nset protocols bgp group ebgp export send-direct\nset protocols bgp group ebgp neighbor 172.16.1.1 description PE1\nset policy-options policy statement send-direct from protocol direct then accept\nset routing-options autonomous-system 64497\nset routing-options router-id 192.168.1.2",
            "设备 CE2": "set chassis network-services enhanced-ip\nset interfaces ge-0/0/2 unit 0 description CE2->PE2\nset interfaces ge-0/0/2 unit 0 family inet address 172.16.2.2/30\nset interfaces ge-0/0/2 unit 0 family inet6 address 2001:db8::15/32\nset interfaces ge-0/0/2 unit 0 family mpls\nset interfaces lo0 unit 0 family inet address 192.168.1.3/32\nset protocols mpls interface all\nset protocols bgp group ebgp type external\nset protocols bgp group ebgp peer-as 64496\nset protocols bgp group ebgp family inet labeled-unicast\nset protocols bgp group ebgp family inet6 labeled-unicast\nset protocols bgp group ebgp export send-direct\nset protocols bgp group ebgp neighbor 172.16.2.1 description PE2\nset policy-options policy statement send-direct from protocol direct then accept\nset routing-options autonomous-system 64497\nset routing-options router-id 192.168.1.3"
          }
        },
        {
          "title": "配置设备 PE0",
          "level": 4,
          "content": "以下示例要求您在配置层次结构中导航各个级别。有关导航 CLI 的信息，请参阅《Junos OS CLI 用户指南》中的在配置模式下使用 CLI 编辑器。 要配置设备 PE0： 在配备模块化端口集中器 （MPC） 的路由器上，启用增强型 IP 网络服务。 [edit chassis] usr@PE0# set network-services enhanced-ip 配置设备接口。 [edit interfaces] user@PE0# set ge-0/0/0 unit 0 description PE0->P0 user@PE0# set ge-0/0/0 unit 0 family inet address 10.0.0.5/24 user@PE0# set ge-0/0/0 unit 0 family iso user@PE0# set ge-0/0/0 unit 0 family inet6 address 2001:db8::1/32 user@PE0# set ge-0/0/0 unit 0 family mpls user@PE0# set ge-0/0/1 unit 0 description PE0->P1 user@PE0# set ge-0/0/1 unit 0 family inet address 10.0.0.1/24 user@PE0# set ge-0/0/1 unit 0 family iso user@PE0# set ge-0/0/1 unit 0 family inet6 address 2001:db8::2/32 user@PE0# set ge-0/0/1 unit 0 family mpls user@PE0# set ge-0/0/2 unit 0 description PE0->CE0 user@PE0# set ge-0/0/2 unit 0 family inet address 172.16.0.1/30 user@PE0# set ge-0/0/2 unit 0 family inet6 address 2001:db8::10/32 user@PE0# set ge-0/0/2 unit 0 family mpls 配置环路接口。 [edit interfaces] user@PE0# set lo0 unit 0 family inet address 192.168.0.1/32 在所有接口（管理接口除外）上配置 MPLS 和 LDP。 [edit protocols] user@PE0# set mpls ipv6-tunneling user@PE0# set mpls interface all user@PE0# set mpls interface fxp0.0 disable user@PE0# set ldp track-igp-metric user@PE0# set ldp interface all user@PE0# set ldp interface fxp0.0 disable 在面向核心的接口上配置 IGP。 [edit protocols] user@PE0# set ospf area 0.0.0.0 interface all user@PE0# set ospf area 0.0.0.0 interface fxp0.0 disable user@PE0# set ospf area 0.0.0.0 interface lo0.0 passive user@PE0# set ospf area 0.0.0.0 interface ge-0/0/1.0 metric 1000 user@PE0# set ospf3 area 0.0.0.0 interface all user@PE0# set ospf3 area 0.0.0.0 interface fxp0.0 disable user@PE0# set ospf3 area 0.0.0.0 interface lo0.0 passive user@PE0# set ospf3 area 0.0.0.0 interface ge-0/0/1.0 metric 1000 配置与其他 PE 设备的 IBGP 连接。 [edit protocols] user@PE0# set bgp group ibgp type internal user@PE0# set bgp group ibgp local-address 192.168.0.1 user@PE0# set bgp group ibgp family inet labeled-unicast per-prefix-label user@PE0# set bgp group ibgp family inet6 labeled-unicast explicit-null user@PE0# set bgp group ibgp export nhself user@PE0# set bgp group ibgp neighbor 192.168.0.4 description PE1 user@PE0# set bgp group ibgp neighbor 192.168.0.5 description PE2 配置与客户设备的 EBGP 连接。 [edit protocols] user@PE0# set bgp group ebgp type external user@PE0# set bgp group ebgp local address 192.168.0.1 user@PE0# set bgp group ebgp family inet labeled-unicast user@PE0# set bgp group ebgp family inet6 labeled-unicast user@PE0# set bgp group ebgp peer-as 64497 user@PE0# set bgp group ebgp neighbor 172.16.0.2 description CE0 配置负载均衡策略。 [edit policy-options] user@PE0# set policy-statement lb then load-balance per-packet 配置下一跃点自我策略。 [edit policy-options] user@PE0# set policy-statement nhself then next-hop self 启用 BGP PIC 边缘功能。 [edit routing-options] user@PE0# set protect core 应用负载平衡策略。 [edit routing-options] user@PE0# set forwarding-table export lb 分配路由器 ID 和自治系统 (AS) 编号。 [edit routing-options] user@PE0# set router-id 192.168.0.2 user@PE0# set autonomous-system 64496",
          "sections": [
            {
              "title": "分步过程",
              "level": 5,
              "step_by_step": [
                {
                  "step": 1,
                  "description": "在配备模块化端口集中器 （MPC） 的路由器上，启用增强型 IP 网络服务。",
                  "code": [
                    "[edit chassis]",
                    "usr@PE0# set network-services enhanced-ip"
                  ]
                },
                {
                  "step": 2,
                  "description": "配置设备接口。",
                  "code": [
                    "[edit interfaces]",
                    "user@PE0# set ge-0/0/0 unit 0 description PE0->P0",
                    "user@PE0# set ge-0/0/0 unit 0 family inet address 10.0.0.5/24",
                    "user@PE0# set ge-0/0/0 unit 0 family iso",
                    "user@PE0# set ge-0/0/0 unit 0 family inet6 address 2001:db8::1/32",
                    "user@PE0# set ge-0/0/0 unit 0 family mpls ",
                    "user@PE0# set ge-0/0/1 unit 0 description PE0->P1",
                    "user@PE0# set ge-0/0/1 unit 0 family inet address 10.0.0.1/24",
                    "user@PE0# set ge-0/0/1 unit 0 family iso",
                    "user@PE0# set ge-0/0/1 unit 0 family inet6 address 2001:db8::2/32",
                    "user@PE0# set ge-0/0/1 unit 0 family mpls ",
                    "user@PE0# set ge-0/0/2 unit 0 description PE0->CE0",
                    "user@PE0# set ge-0/0/2 unit 0 family inet address 172.16.0.1/30",
                    "user@PE0# set ge-0/0/2 unit 0 family inet6 address 2001:db8::10/32",
                    "user@PE0# set ge-0/0/2 unit 0 family mpls "
                  ]
                },
                {
                  "step": 3,
                  "description": "配置环路接口。",
                  "code": [
                    "[edit interfaces]",
                    "user@PE0# set lo0 unit 0 family inet address 192.168.0.1/32"
                  ]
                },
                {
                  "step": 4,
                  "description": "在所有接口（管理接口除外）上配置 MPLS 和 LDP。",
                  "code": [
                    "[edit protocols]",
                    "user@PE0# set mpls ipv6-tunneling",
                    "user@PE0# set mpls interface all",
                    "user@PE0# set mpls interface fxp0.0 disable ",
                    "user@PE0# set ldp track-igp-metric",
                    "user@PE0# set ldp interface all",
                    "user@PE0# set ldp interface fxp0.0 disable "
                  ]
                },
                {
                  "step": 5,
                  "description": "在面向核心的接口上配置 IGP。",
                  "code": [
                    "[edit protocols]",
                    "user@PE0# set ospf area 0.0.0.0 interface all",
                    "user@PE0# set ospf area 0.0.0.0 interface fxp0.0 disable",
                    "user@PE0# set ospf area 0.0.0.0 interface lo0.0 passive",
                    "user@PE0# set ospf area 0.0.0.0 interface ge-0/0/1.0 metric 1000 ",
                    "user@PE0# set ospf3 area 0.0.0.0 interface all",
                    "user@PE0# set ospf3 area 0.0.0.0 interface fxp0.0 disable",
                    "user@PE0# set ospf3 area 0.0.0.0 interface lo0.0 passive",
                    "user@PE0# set ospf3 area 0.0.0.0 interface ge-0/0/1.0 metric 1000 "
                  ]
                },
                {
                  "step": 6,
                  "description": "配置与其他 PE 设备的 IBGP 连接。",
                  "code": [
                    "[edit protocols]",
                    "user@PE0# set bgp group ibgp type internal",
                    "user@PE0# set bgp group ibgp local-address 192.168.0.1",
                    "user@PE0# set bgp group ibgp family inet labeled-unicast per-prefix-label",
                    "user@PE0# set bgp group ibgp family inet6 labeled-unicast explicit-null",
                    "user@PE0# set bgp group ibgp export nhself",
                    "user@PE0# set bgp group ibgp neighbor 192.168.0.4 description PE1",
                    "user@PE0# set bgp group ibgp neighbor 192.168.0.5 description PE2 "
                  ]
                },
                {
                  "step": 7,
                  "description": "配置与客户设备的 EBGP 连接。",
                  "code": [
                    "[edit protocols]",
                    "user@PE0# set bgp group ebgp type external",
                    "user@PE0# set bgp group ebgp local address 192.168.0.1",
                    "user@PE0# set bgp group ebgp family inet labeled-unicast",
                    "user@PE0# set bgp group ebgp family inet6 labeled-unicast ",
                    "user@PE0# set bgp group ebgp peer-as 64497",
                    "user@PE0# set bgp group ebgp neighbor 172.16.0.2 description CE0 "
                  ]
                },
                {
                  "step": 8,
                  "description": "配置负载均衡策略。",
                  "code": [
                    "[edit policy-options]",
                    "user@PE0# set policy-statement lb then load-balance per-packet"
                  ]
                },
                {
                  "step": 9,
                  "description": "配置下一跃点自我策略。",
                  "code": [
                    "[edit policy-options]",
                    "user@PE0# set policy-statement nhself then next-hop self "
                  ]
                },
                {
                  "step": 10,
                  "description": "启用 BGP PIC 边缘功能。",
                  "code": [
                    "[edit routing-options]",
                    "user@PE0# set protect core"
                  ]
                },
                {
                  "step": 11,
                  "description": "应用负载平衡策略。",
                  "code": [
                    "[edit routing-options]",
                    "user@PE0# set forwarding-table export lb  "
                  ]
                },
                {
                  "step": 12,
                  "description": "分配路由器 ID 和自治系统 (AS) 编号。",
                  "code": [
                    "[edit routing-options]",
                    "user@PE0# set router-id 192.168.0.2",
                    "user@PE0# set autonomous-system 64496"
                  ]
                }
              ]
            }
          ]
        },
        {
          "title": "结果",
          "level": 4,
          "content": "在配置模式下，输入 show chassis 、 show interfaces 、 show policy-options show protocols 和 show routing-options 命令来确认您的配置。如果输出未显示预期的配置，请重复此示例中的说明，以便进行更正。",
          "code": [
            "[edit]\nuser@PE0#show chassisnetwork-services enhanced-ip;",
            "[edit]\nuser@PE0#show interfacesge-0/0/0 {\n    unit 0 {\n        description PE0->P0;\n        family inet {\n            address 10.0.0.5/24;\n        }\n        family iso;\n        family inet6 {\n            address 2001:db8::1/32;\n        }\n        family mpls;\n    }\n}\nge-0/0/1 {\n    unit 0 {\n        description PE0->P1;\n        family inet {\n            address 10.0.0.1/24;\n        }\n        family iso;\n        family inet6 {\n            address 2001:db8::2/32;\n        }\n        family mpls;\n    }\n}\nge-0/0/2 {\n    unit 0 {\n        description PE0->CE0;\n        family inet {\n            address 172.16.0.1/30;\n        }\n        family inet6 {\n            address 2001:db8::10/32;\n        }\n        family mpls;\n    }\n}\nlo0 {\n    unit 0 {\n        family inet {\n            address 192.168.0.1/32;\n        }\n    }\n}",
            "[edit]\nuser@PE0#show protocolsmpls {\n    ipv6-tunneling;\n    interface all;\n    interface fxp0.0 {\n        disable;\n    }\n}\nbgp {\n    group ibgp {\n        type internal;\n        local-address 192.168.0.1;\n        family inet {\n            labeled-unicast {\n                per-prefix-label;\n            }\n        }\n        family inet6 {\n            labeled-unicast {\n                explicit-null;\n            }\n        }\n        export nhself;\n        neighbor 192.168.0.4 {\n            description PE1;\n        }\n        neighbor 192.168.0.5 {\n            description PE2;\n        }\n    }\n    group ebgp {\n        type external;\n        local-address 192.168.0.1;\n        family inet {\n            labeled-unicast;\n        }\n        family inet6 {\n            labeled-unicast;\n        }\n        peer-as 64497;\n        neighbor 172.16.0.2 {\n            description CE0;\n        }\n    }\n}\nospf {\n    area 0.0.0.0 {\n        interface all;\n        interface lo0.0 {\n            passive;\n        }\n        interface ge-0/0/1.0 {\n            metric 1000;\n        }\n        interface fxp0.0 {\n            disable;\n        }\n    }\n}\nospf3 {\n    area 0.0.0.0 {\n        interface all;\n        interface lo0.0 {\n            passive;\n        }\n        interface ge-0/0/1.0 {\n            metric 1000;\n        }\n        interface fxp0.0 {\n            disable;\n        }\n    }\n}\nldp {\n    track-igp-metric;\n    interface all;\n    interface fxp0.0 {\n        disable;\n    }\n}",
            "[edit]\nuser@PE1#show policy-optionspolicy-statement lb {\n    then {\n        load-balance per-packet;\n    }\n}\npolicy-statement nhself {\n    then {\n        next-hop self;\n    }\n}",
            "[edit]\nuser@PE0#show routing-optionsprotect core;\nrouter-id 192.168.0.1;\nautonomous system 64496\nforwarding-table {\n    export lb;\n}"
          ]
        }
      ]
    }
  ],
  "content": "此示例说明如何为 inet 配置 BGP PIC。在路由器发生故障的情况下，BGP 网络可能需要几秒钟到几分钟的时间才能恢复，具体取决于网络大小或路由器性能等参数。在路由器上启用 BGP 前缀独立收敛 （PIC） 功能后，全局表中具有多个路由（例如 inet 和 inet6 单播以及标记为单播的 inet 和 inet6）的 BGP 除了计算出的到达目标的最佳路径外，还会将第二最佳路径安装到数据包转发引擎。当出口路由器在网络中发生故障时，路由器将使用此备份路径，从而大大减少中断时间。 要求 配置此示例之前，不需要除设备初始化之外的特殊配置。 此示例使用以下硬件和软件组件： 一台带有 MPC 的 MX 系列路由器，用于配置 BGP PIC 功能 七款路由器，可以是 M 系列、MX 系列、T 系列或 PTX 系列路由器的组合 配置了 BGP PIC 的设备上的 Junos OS 15.1 或更高版本 概述 从 Junos OS 15.1 版开始，最初支持 3 层 VPN 路由器的 BGP PIC 扩展到具有全局表中多个路由的 BGP，例如 inet 和 inet6 单播，以及标记为单播的 inet 和 inet6。除了计算出的到目标的最佳路径之外，BGP 还会向数据包转发引擎安装第二最佳路径。当 IGP 失去对前缀的可访问性时，路由器将使用此备份路径来减少流量损失，直到解决通过 BGP 的全局收敛问题，从而缩短中断持续时间。 注： BGP PIC 功能仅在具有 MPC 的路由器上受支持。 拓扑学 此示例显示了三个客户边缘 （CE） 路由器：设备 CE0、CE1 和 CE2。路由器 PE0、PE1 和 PE2 是提供商边缘 （PE） 路由器。路由器 P0 和 P1 是提供商核心路由器。BGP PIC 在路由器 PE0 上配置。为了进行测试，地址 192.168.1.5 将添加为设备 CE1 上的第二个环路接口地址。该地址通告给路由器 PE1 和 PE2，并由内部 BGP （IBGP） 中继到路由器 PE0。在路由器 PE0 上，有两条路径可以连接到 192.168.1.5 网络。这些是主路径和备份路径。 图 13 显示了示例网络"
}