{
  "title": "示例：在分配给路径的带宽不相等的情况下，平衡 BGP 流量的负载",
  "sections": [
    {
      "title": "要求",
      "level": 3,
      "content": "准备工作： 配置设备接口。 配置内部网关协议 （IGP）。 配置 BGP。 配置路由策略，将路由（例如直接路由或 IGP 路由）从路由表导出到 BGP。 准备工作： 配置设备接口。 配置内部网关协议 （IGP）。 配置 BGP。 配置路由策略，将路由（例如直接路由或 IGP 路由）从路由表导出到 BGP。"
    },
    {
      "title": "概述",
      "level": 3,
      "content": "在此示例中，设备 R1 位于 AS 64500 中，并连接到位于 AS 64501 中的设备 R2 和设备 R3。 此示例使用带宽扩展社区。 默认情况下，使用 BGP 多路径时，流量在计算的多个路径之间平均分配。带宽扩展社区允许向 BGP 路径添加附加属性，从而允许流量分布不均。主要应用是具有非对称带宽功能的给定网络存在多个外部路径的方案。在这种情况下，您可以标记使用带宽扩展社区接收的路由。当 BGP 多路径（内部或外部）在包含带宽属性的路由之间运行时，转发引擎可能会根据每个路径对应的带宽不均地分配流量。 当 BGP 有多个候选路径可用于多路径时，BGP 不会根据带宽社区执行不等价负载平衡，除非所有候选路径都具有此属性。 带宽扩展社区的适用性受到 BGP 多路径接受多个路径以供考虑的限制。明确而言，就 BGP 而言，执行负载平衡的路由器与多个出口点之间的 IGP 距离需要相同。这可以通过使用不跟踪相应 IGP 指标的标签交换路径 （LSP） 的完整网格来实现。但是，在电路传播延迟很大的网络中（例如，如果存在长距离电路），考虑不同路径的延迟特性通常是有价值的。 按如下方式配置带宽社区： [edit policy-options] user@host# set community members bandwidth :[1-65535]:[0-4294967295] 第一个 16 位数字表示本地自治系统。第二个 32 位数字表示链路带宽（以字节/秒为单位）。 例如： [edit policy-options] user@host# show community bw-t1 members bandwidth:10458:193000; community bw-t3 members bandwidth:10458:5592000; community bw-oc3 members bandwidth:10458:19440000; 其中 10458 是本地 AS 编号。这些值对应于 T1、T3 和 OC-3 路径的带宽（以字节/秒为单位）。指定为带宽值的值不需要与特定接口的实际带宽相对应。使用的平衡因子计算为指定总带宽的函数。要使用此扩展社区标记路由，请定义策略语句，如下所示： [edit policy-options] user@host# show policy-statement link-bw-t1 { then { community set bw-t1; } accept; } 将此作为导入策略应用于面向非对称带宽链路的 BGP 对等会话。尽管理论上可以在网络中的任何点添加或删除社区属性，但在上述场景中，在面向外部链接的 EBGP 对等会话中将社区作为导入策略应用允许该属性影响本地多路径决策，并且可能更易于管理。 拓扑学 图 3 显示了此示例中使用的拓扑。 图 3： BGP 负载平衡 CLI 快速配置 显示了 中 图 3所有设备的配置。#d29e116__d29e379本节介绍设备 R1 上的步骤。 图 3 显示了此示例中使用的拓扑。 图 3： BGP 负载平衡 CLI 快速配置 显示了 中 图 3所有设备的配置。#d29e116__d29e379本节介绍设备 R1 上的步骤。",
      "sections": [
        {
          "title": "拓扑学",
          "level": 4,
          "content": "图 3 显示了此示例中使用的拓扑。 图 3： BGP 负载平衡 CLI 快速配置 显示了 中 图 3所有设备的配置。#d29e116__d29e379本节介绍设备 R1 上的步骤。",
          "images": [
            "BGP 会话的负载平衡\\images\\7_示例：在分配给路径的带宽不相等的情况下，_1.gif"
          ]
        }
      ]
    },
    {
      "title": "配置",
      "level": 3,
      "content": "要快速配置此示例，请复制以下命令，将其粘贴到文本文件中，删除所有换行符，更改与您的网络配置匹配所需的任何详细信息，然后将命令复制并粘贴到层次结构级别的 CLI [edit] 中。 设备 R1 set interfaces ge-1/2/0 unit 0 description R1->R3 set interfaces ge-1/2/0 unit 0 family inet address 10.0.0.1/30 set interfaces ge-1/2/1 unit 0 description R1->R2 set interfaces ge-1/2/1 unit 0 family inet address 10.0.1.2/30 set interfaces lo0 unit 0 family inet address 192.168.0.1/32 set protocols bgp group external type external set protocols bgp group external import bw-dis set protocols bgp group external peer-as 64501 set protocols bgp group external multipath set protocols bgp group external neighbor 10.0.1.1 set protocols bgp group external neighbor 10.0.0.2 set policy-options policy-statement bw-dis term a from protocol bgp set policy-options policy-statement bw-dis term a from neighbor 10.0.1.1 set policy-options policy-statement bw-dis term a then community add bw-high set policy-options policy-statement bw-dis term a then accept set policy-options policy-statement bw-dis term b from protocol bgp set policy-options policy-statement bw-dis term b from neighbor 10.0.0.2 set policy-options policy-statement bw-dis term b then community add bw-low set policy-options policy-statement bw-dis term b then accept set policy-options policy-statement loadbal from route-filter 10.0.0.0/16 orlonger set policy-options policy-statement loadbal then load-balance per-packet set policy-options community bw-high members bandwidth:65000:60000000 set policy-options community bw-low members bandwidth:65000:40000000 set routing-options autonomous-system 64500 set routing-options forwarding-table export loadbal 设备 R2 set interfaces ge-1/2/0 unit 0 description R2->R1 set interfaces ge-1/2/0 unit 0 family inet address 10.0.1.1/30 set interfaces ge-1/2/1 unit 0 description R2->R3 set interfaces ge-1/2/1 unit 0 family inet address 10.0.2.2/30 set interfaces ge-1/2/1 unit 0 family iso set interfaces lo0 unit 0 family inet address 192.168.0.2/32 set interfaces lo0 unit 0 family iso address 49.0001.1921.6800.0002.00 set protocols bgp group external type external set protocols bgp group external export bgp-default set protocols bgp group external export send-direct set protocols bgp group external peer-as 64500 set protocols bgp group external multipath set protocols bgp group external neighbor 10.0.1.2 set protocols isis interface ge-1/2/1.0 set protocols isis interface lo0.0 set policy-options policy-statement bgp-default from protocol static set policy-options policy-statement bgp-default from route-filter 172.16.0.0/16 exact set policy-options policy-statement bgp-default then accept set policy-options policy-statement send-direct term 1 from protocol direct set policy-options policy-statement send-direct term 1 then accept set routing-options static route 172.16.0.0/16 discard set routing-options static route 172.16.0.0/16 no-install set routing-options autonomous-system 64501 设备 R3 set interfaces ge-1/2/0 unit 0 description R3->R2 set interfaces ge-1/2/0 unit 0 family inet address 10.0.2.1/30 set interfaces ge-1/2/0 unit 0 family iso set interfaces ge-1/2/1 unit 0 description R3->R1 set interfaces ge-1/2/1 unit 0 family inet address 10.0.0.2/30 set interfaces lo0 unit 0 family inet address 192.168.0.3/32 set interfaces lo0 unit 0 family iso address 49.0001.1921.6800.0003.00 set protocols bgp group external type external set protocols bgp group external export send-direct set protocols bgp group external export bgp-default set protocols bgp group external peer-as 64500 set protocols bgp group external multipath set protocols bgp group external neighbor 10.0.0.1 set protocols isis interface ge-1/2/0.0 set protocols isis interface lo0.0 set policy-options policy-statement bgp-default from protocol static set policy-options policy-statement bgp-default from route-filter 172.16.0.0/16 exact set policy-options policy-statement bgp-default then accept set policy-options policy-statement send-direct term 1 from protocol direct set policy-options policy-statement send-direct term 1 then accept set routing-options static route 172.16.0.0/16 discard set routing-options static route 172.16.0.0/16 no-install set routing-options autonomous-system 64501 以下示例要求您在配置层次结构中导航各个级别。有关导航 CLI 的信息，请参阅《Junos OS CLI 用户指南》中的在配置模式下使用 CLI 编辑器。 要配置 BGP 对等会话，请执行以下操作： 配置接口。 user@R1# set ge-1/2/0 unit 0 description R1->R3 user@R1# set ge-1/2/0 unit 0 family inet address 10.0.0.1/30 user@R1# set ge-1/2/1 unit 0 description R1->R2 user@R1# set ge-1/2/1 unit 0 family inet address 10.0.1.2/30 user@R1# set lo0 unit 0 family inet address 192.168.0.1/32 配置 BGP 组。 [edit protocols bgp group external] user@R1# set type external user@R1# set import bw-dis user@R1# set peer-as 64501 user@R1# set neighbor 10.0.1.1 user@R1# set neighbor 10.0.0.2 使 BGP 组能够使用多个路径。 注： 要禁用要求 BGP 多路径接受的路径必须具有相同相邻自治系统 （AS） 的默认检查，请包含该 multiple-as 选项。如果邻接方位于不同的 AS 中，请使用此选项 multiple-as 。 要禁用要求 BGP 多路径接受的路径必须具有相同相邻自治系统 （AS） 的默认检查，请包含该 multiple-as 选项。如果邻接方位于不同的 AS 中，请使用此选项 multiple-as 。 [edit protocols bgp group external] user@R1# set multipath 配置负载均衡策略。 [edit policy-options policy-statement loadbal] user@R1# set from route-filter 10.0.0.0/16 orlonger user@R1# set then load-balance per-packet 应用负载平衡策略。 [edit routing-options] user@R1# set forwarding-table export loadbal 配置 BGP 社区成员。 此示例假定带宽为 1 Gbps，并将 60% 分配给 bw 高，40% 分配给低带宽。参考带宽不必与链路带宽相同。 [edit policy-options] user@R1# set community bw-high members bandwidth:65000:60000000 user@R1# set community bw-low members bandwidth:65000:40000000 配置带宽分配策略。 [edit policy-options bw-dis] user@R1# set term a from protocol bgp user@R1# set term a from neighbor 10.0.1.1 user@R1# set term a then community add bw-high user@R1# set term a then accept user@R1# set term b from protocol bgp user@R1# set term b from neighbor 10.0.0.2 user@R1# set term b then community add bw-low user@R1# set term b then accept 配置本地自治系统 (AS) 编号。 [edit routing-options] user@R1# set autonomous-system 64500 在配置模式下，输入 show interfaces 、 show protocols 、 show policy-options 和 show routing-options 命令，以确认您的配置。如果输出未显示预期的配置，请重复此示例中的说明，以便进行更正。 user@R1# show interfaces ge-1/2/0 { unit 0 { description R1->R3; family inet { address 10.0.0.1/30; } } } ge-1/2/1 { unit 0 { description R1->R2; family inet { address 10.0.1.2/30; } } } lo0 { unit 0 { family inet { address 192.168.0.1/32; } } } user@R1# show protocols bgp { group external { type external; import bw-dis; peer-as 64501; multipath; neighbor 10.0.1.1; neighbor 10.0.0.2; } } user@R1# show policy-options policy-statement bw-dis { term a { from { protocol bgp; neighbor 10.0.1.1; } then { community add bw-high; accept; } } term b { from { protocol bgp; neighbor 10.0.0.2; } then { community add bw-low; accept; } } } policy-statement loadbal { from { route-filter 10.0.0.0/16 orlonger; } then { load-balance per-packet; } } community bw-high members bandwidth:65000:60000000; community bw-low members bandwidth:65000:40000000; user@R1# show routing-options autonomous-system 64500; forwarding-table { export loadbal; } 如果完成设备配置，请从配置模式输入 commit 。",
      "sections": [
        {
          "title": "程序",
          "level": 4,
          "content": "要快速配置此示例，请复制以下命令，将其粘贴到文本文件中，删除所有换行符，更改与您的网络配置匹配所需的任何详细信息，然后将命令复制并粘贴到层次结构级别的 CLI [edit] 中。 设备 R1 set interfaces ge-1/2/0 unit 0 description R1->R3 set interfaces ge-1/2/0 unit 0 family inet address 10.0.0.1/30 set interfaces ge-1/2/1 unit 0 description R1->R2 set interfaces ge-1/2/1 unit 0 family inet address 10.0.1.2/30 set interfaces lo0 unit 0 family inet address 192.168.0.1/32 set protocols bgp group external type external set protocols bgp group external import bw-dis set protocols bgp group external peer-as 64501 set protocols bgp group external multipath set protocols bgp group external neighbor 10.0.1.1 set protocols bgp group external neighbor 10.0.0.2 set policy-options policy-statement bw-dis term a from protocol bgp set policy-options policy-statement bw-dis term a from neighbor 10.0.1.1 set policy-options policy-statement bw-dis term a then community add bw-high set policy-options policy-statement bw-dis term a then accept set policy-options policy-statement bw-dis term b from protocol bgp set policy-options policy-statement bw-dis term b from neighbor 10.0.0.2 set policy-options policy-statement bw-dis term b then community add bw-low set policy-options policy-statement bw-dis term b then accept set policy-options policy-statement loadbal from route-filter 10.0.0.0/16 orlonger set policy-options policy-statement loadbal then load-balance per-packet set policy-options community bw-high members bandwidth:65000:60000000 set policy-options community bw-low members bandwidth:65000:40000000 set routing-options autonomous-system 64500 set routing-options forwarding-table export loadbal 设备 R2 set interfaces ge-1/2/0 unit 0 description R2->R1 set interfaces ge-1/2/0 unit 0 family inet address 10.0.1.1/30 set interfaces ge-1/2/1 unit 0 description R2->R3 set interfaces ge-1/2/1 unit 0 family inet address 10.0.2.2/30 set interfaces ge-1/2/1 unit 0 family iso set interfaces lo0 unit 0 family inet address 192.168.0.2/32 set interfaces lo0 unit 0 family iso address 49.0001.1921.6800.0002.00 set protocols bgp group external type external set protocols bgp group external export bgp-default set protocols bgp group external export send-direct set protocols bgp group external peer-as 64500 set protocols bgp group external multipath set protocols bgp group external neighbor 10.0.1.2 set protocols isis interface ge-1/2/1.0 set protocols isis interface lo0.0 set policy-options policy-statement bgp-default from protocol static set policy-options policy-statement bgp-default from route-filter 172.16.0.0/16 exact set policy-options policy-statement bgp-default then accept set policy-options policy-statement send-direct term 1 from protocol direct set policy-options policy-statement send-direct term 1 then accept set routing-options static route 172.16.0.0/16 discard set routing-options static route 172.16.0.0/16 no-install set routing-options autonomous-system 64501 设备 R3 set interfaces ge-1/2/0 unit 0 description R3->R2 set interfaces ge-1/2/0 unit 0 family inet address 10.0.2.1/30 set interfaces ge-1/2/0 unit 0 family iso set interfaces ge-1/2/1 unit 0 description R3->R1 set interfaces ge-1/2/1 unit 0 family inet address 10.0.0.2/30 set interfaces lo0 unit 0 family inet address 192.168.0.3/32 set interfaces lo0 unit 0 family iso address 49.0001.1921.6800.0003.00 set protocols bgp group external type external set protocols bgp group external export send-direct set protocols bgp group external export bgp-default set protocols bgp group external peer-as 64500 set protocols bgp group external multipath set protocols bgp group external neighbor 10.0.0.1 set protocols isis interface ge-1/2/0.0 set protocols isis interface lo0.0 set policy-options policy-statement bgp-default from protocol static set policy-options policy-statement bgp-default from route-filter 172.16.0.0/16 exact set policy-options policy-statement bgp-default then accept set policy-options policy-statement send-direct term 1 from protocol direct set policy-options policy-statement send-direct term 1 then accept set routing-options static route 172.16.0.0/16 discard set routing-options static route 172.16.0.0/16 no-install set routing-options autonomous-system 64501 以下示例要求您在配置层次结构中导航各个级别。有关导航 CLI 的信息，请参阅《Junos OS CLI 用户指南》中的在配置模式下使用 CLI 编辑器。 要配置 BGP 对等会话，请执行以下操作： 配置接口。 user@R1# set ge-1/2/0 unit 0 description R1->R3 user@R1# set ge-1/2/0 unit 0 family inet address 10.0.0.1/30 user@R1# set ge-1/2/1 unit 0 description R1->R2 user@R1# set ge-1/2/1 unit 0 family inet address 10.0.1.2/30 user@R1# set lo0 unit 0 family inet address 192.168.0.1/32 配置 BGP 组。 [edit protocols bgp group external] user@R1# set type external user@R1# set import bw-dis user@R1# set peer-as 64501 user@R1# set neighbor 10.0.1.1 user@R1# set neighbor 10.0.0.2 使 BGP 组能够使用多个路径。 注： 要禁用要求 BGP 多路径接受的路径必须具有相同相邻自治系统 （AS） 的默认检查，请包含该 multiple-as 选项。如果邻接方位于不同的 AS 中，请使用此选项 multiple-as 。 要禁用要求 BGP 多路径接受的路径必须具有相同相邻自治系统 （AS） 的默认检查，请包含该 multiple-as 选项。如果邻接方位于不同的 AS 中，请使用此选项 multiple-as 。 [edit protocols bgp group external] user@R1# set multipath 配置负载均衡策略。 [edit policy-options policy-statement loadbal] user@R1# set from route-filter 10.0.0.0/16 orlonger user@R1# set then load-balance per-packet 应用负载平衡策略。 [edit routing-options] user@R1# set forwarding-table export loadbal 配置 BGP 社区成员。 此示例假定带宽为 1 Gbps，并将 60% 分配给 bw 高，40% 分配给低带宽。参考带宽不必与链路带宽相同。 [edit policy-options] user@R1# set community bw-high members bandwidth:65000:60000000 user@R1# set community bw-low members bandwidth:65000:40000000 配置带宽分配策略。 [edit policy-options bw-dis] user@R1# set term a from protocol bgp user@R1# set term a from neighbor 10.0.1.1 user@R1# set term a then community add bw-high user@R1# set term a then accept user@R1# set term b from protocol bgp user@R1# set term b from neighbor 10.0.0.2 user@R1# set term b then community add bw-low user@R1# set term b then accept 配置本地自治系统 (AS) 编号。 [edit routing-options] user@R1# set autonomous-system 64500 在配置模式下，输入 show interfaces 、 show protocols 、 show policy-options 和 show routing-options 命令，以确认您的配置。如果输出未显示预期的配置，请重复此示例中的说明，以便进行更正。 user@R1# show interfaces ge-1/2/0 { unit 0 { description R1->R3; family inet { address 10.0.0.1/30; } } } ge-1/2/1 { unit 0 { description R1->R2; family inet { address 10.0.1.2/30; } } } lo0 { unit 0 { family inet { address 192.168.0.1/32; } } } user@R1# show protocols bgp { group external { type external; import bw-dis; peer-as 64501; multipath; neighbor 10.0.1.1; neighbor 10.0.0.2; } } user@R1# show policy-options policy-statement bw-dis { term a { from { protocol bgp; neighbor 10.0.1.1; } then { community add bw-high; accept; } } term b { from { protocol bgp; neighbor 10.0.0.2; } then { community add bw-low; accept; } } } policy-statement loadbal { from { route-filter 10.0.0.0/16 orlonger; } then { load-balance per-packet; } } community bw-high members bandwidth:65000:60000000; community bw-low members bandwidth:65000:40000000; user@R1# show routing-options autonomous-system 64500; forwarding-table { export loadbal; } 如果完成设备配置，请从配置模式输入 commit 。",
          "sections": [
            {
              "title": "CLI 快速配置",
              "level": 5,
              "content": "要快速配置此示例，请复制以下命令，将其粘贴到文本文件中，删除所有换行符，更改与您的网络配置匹配所需的任何详细信息，然后将命令复制并粘贴到层次结构级别的 CLI [edit] 中。 设备 R1 set interfaces ge-1/2/0 unit 0 description R1->R3 set interfaces ge-1/2/0 unit 0 family inet address 10.0.0.1/30 set interfaces ge-1/2/1 unit 0 description R1->R2 set interfaces ge-1/2/1 unit 0 family inet address 10.0.1.2/30 set interfaces lo0 unit 0 family inet address 192.168.0.1/32 set protocols bgp group external type external set protocols bgp group external import bw-dis set protocols bgp group external peer-as 64501 set protocols bgp group external multipath set protocols bgp group external neighbor 10.0.1.1 set protocols bgp group external neighbor 10.0.0.2 set policy-options policy-statement bw-dis term a from protocol bgp set policy-options policy-statement bw-dis term a from neighbor 10.0.1.1 set policy-options policy-statement bw-dis term a then community add bw-high set policy-options policy-statement bw-dis term a then accept set policy-options policy-statement bw-dis term b from protocol bgp set policy-options policy-statement bw-dis term b from neighbor 10.0.0.2 set policy-options policy-statement bw-dis term b then community add bw-low set policy-options policy-statement bw-dis term b then accept set policy-options policy-statement loadbal from route-filter 10.0.0.0/16 orlonger set policy-options policy-statement loadbal then load-balance per-packet set policy-options community bw-high members bandwidth:65000:60000000 set policy-options community bw-low members bandwidth:65000:40000000 set routing-options autonomous-system 64500 set routing-options forwarding-table export loadbal 设备 R2 set interfaces ge-1/2/0 unit 0 description R2->R1 set interfaces ge-1/2/0 unit 0 family inet address 10.0.1.1/30 set interfaces ge-1/2/1 unit 0 description R2->R3 set interfaces ge-1/2/1 unit 0 family inet address 10.0.2.2/30 set interfaces ge-1/2/1 unit 0 family iso set interfaces lo0 unit 0 family inet address 192.168.0.2/32 set interfaces lo0 unit 0 family iso address 49.0001.1921.6800.0002.00 set protocols bgp group external type external set protocols bgp group external export bgp-default set protocols bgp group external export send-direct set protocols bgp group external peer-as 64500 set protocols bgp group external multipath set protocols bgp group external neighbor 10.0.1.2 set protocols isis interface ge-1/2/1.0 set protocols isis interface lo0.0 set policy-options policy-statement bgp-default from protocol static set policy-options policy-statement bgp-default from route-filter 172.16.0.0/16 exact set policy-options policy-statement bgp-default then accept set policy-options policy-statement send-direct term 1 from protocol direct set policy-options policy-statement send-direct term 1 then accept set routing-options static route 172.16.0.0/16 discard set routing-options static route 172.16.0.0/16 no-install set routing-options autonomous-system 64501 设备 R3 set interfaces ge-1/2/0 unit 0 description R3->R2 set interfaces ge-1/2/0 unit 0 family inet address 10.0.2.1/30 set interfaces ge-1/2/0 unit 0 family iso set interfaces ge-1/2/1 unit 0 description R3->R1 set interfaces ge-1/2/1 unit 0 family inet address 10.0.0.2/30 set interfaces lo0 unit 0 family inet address 192.168.0.3/32 set interfaces lo0 unit 0 family iso address 49.0001.1921.6800.0003.00 set protocols bgp group external type external set protocols bgp group external export send-direct set protocols bgp group external export bgp-default set protocols bgp group external peer-as 64500 set protocols bgp group external multipath set protocols bgp group external neighbor 10.0.0.1 set protocols isis interface ge-1/2/0.0 set protocols isis interface lo0.0 set policy-options policy-statement bgp-default from protocol static set policy-options policy-statement bgp-default from route-filter 172.16.0.0/16 exact set policy-options policy-statement bgp-default then accept set policy-options policy-statement send-direct term 1 from protocol direct set policy-options policy-statement send-direct term 1 then accept set routing-options static route 172.16.0.0/16 discard set routing-options static route 172.16.0.0/16 no-install set routing-options autonomous-system 64501",
              "commands_by_device": {
                "设备 R1": "set interfaces ge-1/2/0 unit 0 description R1->R3\nset interfaces ge-1/2/0 unit 0 family inet address 10.0.0.1/30\nset interfaces ge-1/2/1 unit 0 description R1->R2\nset interfaces ge-1/2/1 unit 0 family inet address 10.0.1.2/30\nset interfaces lo0 unit 0 family inet address 192.168.0.1/32\nset protocols bgp group external type external\nset protocols bgp group external import bw-dis\nset protocols bgp group external peer-as 64501\nset protocols bgp group external multipath\nset protocols bgp group external neighbor 10.0.1.1\nset protocols bgp group external neighbor 10.0.0.2\nset policy-options policy-statement bw-dis term a from protocol bgp\nset policy-options policy-statement bw-dis term a from neighbor 10.0.1.1\nset policy-options policy-statement bw-dis term a then community add bw-high\nset policy-options policy-statement bw-dis term a then accept\nset policy-options policy-statement bw-dis term b from protocol bgp\nset policy-options policy-statement bw-dis term b from neighbor 10.0.0.2\nset policy-options policy-statement bw-dis term b then community add bw-low\nset policy-options policy-statement bw-dis term b then accept\nset policy-options policy-statement loadbal from route-filter 10.0.0.0/16 orlonger\nset policy-options policy-statement loadbal then load-balance per-packet\nset policy-options community bw-high members bandwidth:65000:60000000\nset policy-options community bw-low members bandwidth:65000:40000000\nset routing-options autonomous-system 64500\nset routing-options forwarding-table export loadbal",
                "设备 R2": "set interfaces ge-1/2/0 unit 0 description R2->R1\nset interfaces ge-1/2/0 unit 0 family inet address 10.0.1.1/30\nset interfaces ge-1/2/1 unit 0 description R2->R3\nset interfaces ge-1/2/1 unit 0 family inet address 10.0.2.2/30\nset interfaces ge-1/2/1 unit 0 family iso\nset interfaces lo0 unit 0 family inet address 192.168.0.2/32\nset interfaces lo0 unit 0 family iso address 49.0001.1921.6800.0002.00\nset protocols bgp group external type external\nset protocols bgp group external export bgp-default\nset protocols bgp group external export send-direct\nset protocols bgp group external peer-as 64500\nset protocols bgp group external multipath\nset protocols bgp group external neighbor 10.0.1.2\nset protocols isis interface ge-1/2/1.0\nset protocols isis interface lo0.0\nset policy-options policy-statement bgp-default from protocol static\nset policy-options policy-statement bgp-default from route-filter 172.16.0.0/16 exact\nset policy-options policy-statement bgp-default then accept\nset policy-options policy-statement send-direct term 1 from protocol direct\nset policy-options policy-statement send-direct term 1 then accept\nset routing-options static route 172.16.0.0/16 discard\nset routing-options static route 172.16.0.0/16 no-install\nset routing-options autonomous-system 64501",
                "设备 R3": "set interfaces ge-1/2/0 unit 0 description R3->R2\nset interfaces ge-1/2/0 unit 0 family inet address 10.0.2.1/30\nset interfaces ge-1/2/0 unit 0 family iso\nset interfaces ge-1/2/1 unit 0 description R3->R1\nset interfaces ge-1/2/1 unit 0 family inet address 10.0.0.2/30\nset interfaces lo0 unit 0 family inet address 192.168.0.3/32\nset interfaces lo0 unit 0 family iso address 49.0001.1921.6800.0003.00\nset protocols bgp group external type external\nset protocols bgp group external export send-direct\nset protocols bgp group external export bgp-default\nset protocols bgp group external peer-as 64500\nset protocols bgp group external multipath\nset protocols bgp group external neighbor 10.0.0.1\nset protocols isis interface ge-1/2/0.0\nset protocols isis interface lo0.0\nset policy-options policy-statement bgp-default from protocol static\nset policy-options policy-statement bgp-default from route-filter 172.16.0.0/16 exact\nset policy-options policy-statement bgp-default then accept\nset policy-options policy-statement send-direct term 1 from protocol direct\nset policy-options policy-statement send-direct term 1 then accept\nset routing-options static route 172.16.0.0/16 discard\nset routing-options static route 172.16.0.0/16 no-install\nset routing-options autonomous-system 64501"
              }
            },
            {
              "title": "分步过程",
              "level": 5,
              "step_by_step": [
                {
                  "step": 1,
                  "description": "配置接口。",
                  "code": [
                    "user@R1# set ge-1/2/0 unit 0 description R1->R3",
                    "user@R1# set ge-1/2/0 unit 0 family inet address 10.0.0.1/30",
                    "user@R1# set ge-1/2/1 unit 0 description R1->R2",
                    "user@R1# set ge-1/2/1 unit 0 family inet address 10.0.1.2/30",
                    "user@R1# set lo0 unit 0 family inet address 192.168.0.1/32"
                  ]
                },
                {
                  "step": 2,
                  "description": "配置 BGP 组。",
                  "code": [
                    "[edit protocols bgp group external]",
                    "user@R1# set type external",
                    "user@R1# set import bw-dis",
                    "user@R1# set peer-as 64501",
                    "user@R1# set neighbor 10.0.1.1",
                    "user@R1# set neighbor 10.0.0.2"
                  ]
                },
                {
                  "step": 3,
                  "description": "使 BGP 组能够使用多个路径。",
                  "code": [
                    "[edit protocols bgp group external]",
                    "user@R1# set multipath"
                  ]
                },
                {
                  "step": 4,
                  "description": "配置负载均衡策略。",
                  "code": [
                    "[edit policy-options policy-statement loadbal]",
                    "user@R1# set from route-filter 10.0.0.0/16 orlonger ",
                    "user@R1# set then load-balance per-packet "
                  ]
                },
                {
                  "step": 5,
                  "description": "应用负载平衡策略。",
                  "code": [
                    "[edit routing-options]",
                    "user@R1# set forwarding-table export loadbal"
                  ]
                },
                {
                  "step": 6,
                  "description": "配置 BGP 社区成员。",
                  "code": [
                    "[edit policy-options]",
                    "user@R1# set community bw-high members bandwidth:65000:60000000",
                    "user@R1# set community bw-low members bandwidth:65000:40000000"
                  ]
                },
                {
                  "step": 7,
                  "description": "配置带宽分配策略。",
                  "code": [
                    "[edit policy-options bw-dis]",
                    "user@R1# set term a from protocol bgp",
                    "user@R1# set term a from neighbor 10.0.1.1",
                    "user@R1# set term a then community add bw-high",
                    "user@R1# set term a then accept",
                    "user@R1# set term b from protocol bgp",
                    "user@R1# set term b from neighbor 10.0.0.2",
                    "user@R1# set term b then community add bw-low",
                    "user@R1# set term b then accept"
                  ]
                },
                {
                  "step": 8,
                  "description": "配置本地自治系统 (AS) 编号。",
                  "code": [
                    "[edit routing-options]",
                    "user@R1# set autonomous-system 64500"
                  ]
                }
              ]
            },
            {
              "title": "结果",
              "level": 5,
              "content": "在配置模式下，输入 show interfaces 、 show protocols 、 show policy-options 和 show routing-options 命令，以确认您的配置。如果输出未显示预期的配置，请重复此示例中的说明，以便进行更正。 如果完成设备配置，请从配置模式输入 commit 。",
              "code": [
                "user@R1#show interfacesge-1/2/0 {\n    unit 0 {\n        description R1->R3;\n        family inet {\n            address 10.0.0.1/30;\n        }\n    }\n}\nge-1/2/1 {\n    unit 0 {\n        description R1->R2;\n        family inet {\n            address 10.0.1.2/30;\n        }\n    }\n}\nlo0 {\n    unit 0 {\n        family inet {\n            address 192.168.0.1/32;\n        }\n    }\n}",
                "user@R1#show protocolsbgp {\n    group external {\n        type external;\n        import bw-dis;\n        peer-as 64501;\n        multipath;\n        neighbor 10.0.1.1;\n        neighbor 10.0.0.2;\n    }\n}",
                "user@R1#show policy-optionspolicy-statement bw-dis {\n    term a {\n        from {\n            protocol bgp;\n            neighbor 10.0.1.1;\n        }\n        then {\n            community add bw-high;\n            accept;\n        }\n    }\n    term b {\n        from {\n            protocol bgp;\n            neighbor 10.0.0.2;\n        }\n        then {\n            community add bw-low;\n            accept;\n        }\n    }\n}\npolicy-statement loadbal {\n    from {\n        route-filter 10.0.0.0/16 orlonger;\n    }\n    then {\n        load-balance per-packet;\n    }\n}\ncommunity bw-high members bandwidth:65000:60000000;\ncommunity bw-low members bandwidth:65000:40000000;",
                "user@R1#show routing-optionsautonomous-system 64500;\nforwarding-table {\n    export loadbal;\n}"
              ]
            }
          ]
        }
      ]
    }
  ],
  "content": "此示例说明如何将 BGP 配置为选择多个不等价路径作为活动路径。 BGP 社区可以帮助您控制路由策略。BGP 社区良好用法的一个示例是不等负载均衡。当自治系统边界路由器 （ASBR） 接收来自直接连接的外部 BGP （EBGP） 邻接方的路由时，ASBR 会使用 IBGP 通告将这些路由通告给内部邻接方。在 IBGP 广告中，您可以附加链路带宽社区来传达播发的外部链路的带宽。当有多个外部链接可用，并且您希望对这些链接执行不相等的负载平衡时，这很有用。您可以在 AS 的所有入口链路上配置链路带宽扩展社区。链路带宽扩展社区中的带宽信息基于 EBGP 链路的配置带宽。它不基于链路上的流量。Junos OS 支持 BGP 链路带宽和多路径负载平衡，如互联网草案 draft-ietf-idr-link-bandwidth-06，BGP 链路带宽扩展社区 中所述。请注意，即使 draft-ietf-idr-link-bandwidth-06 指定了非传递社区，Junos OS 实施也仅限于传递社区。 要求 准备工作： 配置设备接口。 配置内部网关协议 （IGP）。 配置 BGP。 配置路由策略，将路由（例如直接路由或 IGP 路由）从路由表导出到 BGP"
}