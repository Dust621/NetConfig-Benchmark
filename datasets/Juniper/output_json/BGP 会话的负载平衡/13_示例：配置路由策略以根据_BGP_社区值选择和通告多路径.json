{
  "title": "示例：配置路由策略以根据 BGP 社区值选择和通告多路径",
  "sections": [
    {
      "title": "要求",
      "level": 3,
      "content": "配置此示例之前，不需要除设备初始化之外的特殊配置。 此示例使用以下硬件和软件组件： 八款路由器，可组合使用 M 系列、MX 系列或 T 系列路由器 设备上的 Junos OS 16.1R2 或更高版本 配置此示例之前，不需要除设备初始化之外的特殊配置。 此示例使用以下硬件和软件组件： 八款路由器，可组合使用 M 系列、MX 系列或 T 系列路由器 设备上的 Junos OS 16.1R2 或更高版本"
    },
    {
      "title": "概述",
      "level": 3,
      "content": "从 Junos OS 16.1R2 开始，您可以定义一个策略，以根据社区值识别符合条件的多路径前缀。除了指向给定目标的活动路径之外，BGP 还会通告这些带有社区标记的路由。如果路由的社区值与策略中定义的社区值不匹配，则 BGP 不会播发该路由。此功能允许 BGP 播发到给定目标的不超过 20 条路径。您可以限制和配置 BGP 为多个路径考虑的前缀数，而无需事先实际知道前缀。相反，已知的 BGP 社区值确定是否播发前缀。 在 中 图 8，RR1 和 RR4 是路由反射器。路由器 R2 和 R3 是路由反射器 RR1 的客户端。路由器 R8 是路由反射器 RR4 的客户端。路由器 R5、R6 和路由器 R7 将静态路由重新分发到 BGP 中。路由器 R5 通告静态路由 199.1.1.1/32 和 198.1.1.1/32，社区值为 4713：100。 路由器 RR1 配置为向路由器 RR4 发送最多 6 条路径（每个目标）。路由器 RR4 配置为向路由器 R8 发送最多 6 条路径。路由器 R8 配置为从路由器 RR4 接收多条路径。添加路径社区配置限制路由器 RR4 为仅包含 4713：100 社区值的路由发送多个路径。路由器 RR4 过滤并通告仅包含 4714：100 社区值的多路径。",
      "sections": [
        {
          "title": "拓扑学",
          "level": 4,
          "content": "在 中 图 8，RR1 和 RR4 是路由反射器。路由器 R2 和 R3 是路由反射器 RR1 的客户端。路由器 R8 是路由反射器 RR4 的客户端。路由器 R5、R6 和路由器 R7 将静态路由重新分发到 BGP 中。路由器 R5 通告静态路由 199.1.1.1/32 和 198.1.1.1/32，社区值为 4713：100。 路由器 RR1 配置为向路由器 RR4 发送最多 6 条路径（每个目标）。路由器 RR4 配置为向路由器 R8 发送最多 6 条路径。路由器 R8 配置为从路由器 RR4 接收多条路径。添加路径社区配置限制路由器 RR4 为仅包含 4713：100 社区值的路由发送多个路径。路由器 RR4 过滤并通告仅包含 4714：100 社区值的多路径。",
          "images": [
            "BGP 会话的负载平衡\\images\\13_示例：配置路由策略以根据_BGP_社区值_1.png"
          ]
        }
      ]
    },
    {
      "title": "配置",
      "level": 3,
      "content": "要快速配置此示例，请复制以下命令，将其粘贴到文本文件中，删除所有换行符，更改与您的网络配置匹配所需的任何详细信息，将命令复制并粘贴到层次结构级别的 CLI [edit] 中，然后从配置模式进入提交。 路由器 RR1 set interfaces ge-1/0/10 unit 0 description RR1->R2 set interfaces ge-1/0/10 unit 0 family inet address 10.0.12.1/24 set interfaces ge-1/0/11 unit 0 description RR1->RR4 set interfaces ge-1/0/11 unit 0 family inet address 10.0.14.1/24 set interfaces ge-1/0/12 unit 0 description RR1->R5 set interfaces ge-1/0/12 unit 0 family inet address 10.0.15.1/24 set interfaces ge-1/0/13 unit 0 description RR1->R3 set interfaces ge-1/0/13 unit 0 family inet address 10.0.13.1/24 set interfaces lo0 unit 0 family inet address 10.0.0.10/32 set protocols bgp group rr type internal set protocols bgp group rr local-address 10.0.0.10 set protocols bgp group rr cluster 10.0.0.10 set protocols bgp group rr multipath set protocols bgp group rr neighbor 10.0.0.20 set protocols bgp group rr neighbor 10.0.0.30 set protocols bgp group e1 type external set protocols bgp group e1 neighbor 10.0.15.2 local-address 10.0.15.1 set protocols bgp group e1 neighbor 10.0.15.2 peer-as 64502 set protocols bgp group rr_rr type internal set protocols bgp group rr_rr local-address 10.0.0.10 set protocols bgp group rr_rr neighbor 10.0.0.40 family inet unicast add-path send path-count 6 set protocols ospf area 0.0.0.0 interface lo0.10 passive set protocols ospf area 0.0.0.0 interface ge-1/0/10 set protocols ospf area 0.0.0.0 interface ge-1/0/13 set protocols ospf area 0.0.0.0 interface ge-1/0/11 set protocols ospf area 0.0.0.0 interface ge-1/0/12 set routing-options router-id 10.0.0.10 set routing-options autonomous-system 64501 路由器 R2 set interfaces ge-1/0/10 unit 0 description R2->RR1 set interfaces ge-1/0/10 unit 0 family inet address 10.0.12.2/24 set interfaces ge-1/0/11 unit 0 description R2->R6 set interfaces ge-1/0/11 unit 0 family inet address 10.0.26.1/24 set interfaces lo0 unit 0 family inet address 10.0.0.20/32 set protocols bgp group rr local-address 10.0.0.20 set protocols bgp group rr neighbor 10.0.0.10 export set_nh_self set protocols bgp group e1 type external set protocols bgp group e1 neighbor 10.0.26.2 peer-as 64502 set protocols ospf area 0.0.0.0 interface lo0.20 passive set protocols ospf area 0.0.0.0 interface ge-1/0/10 set protocols ospf area 0.0.0.0 interface ge-1/0/11 set policy-options policy-statement set_nh_self then next-hop self set routing-options autonomous-system 64501 路由器 R3 set interfaces ge-1/0/10 unit 0 description R3->RR1 set interfaces ge-1/0/10 unit 0 family inet address 10.0.13.2/24 set interfaces ge-1/0/11 unit 0 description R3->R7 set interfaces ge-1/0/11 unit 0 family inet address 10.0.37.1/24 set interfaces lo0 unit 0 family inet address 10.0.0.30/32 set protocols bgp group rr type internal set protocols bgp group rr local-address 10.0.0.30 set protocols bgp group rr neighbor 10.0.0.10 export set_nh_self set protocols bgp group e1 type external set protocols bgp group e1 neighbor 10.0.37.2 peer-as 64502 set protocols ospf area 0.0.0.0 interface lo0.30 passive set protocols ospf area 0.0.0.0 interface ge-1/0/10 set protocols ospf area 0.0.0.0 interface ge-1/0/13 set policy-options policy-statement set_nh_self then next-hop self set routing-options autonomous-system 64501 路由器 RR4 set interfaces ge-1/0/10 unit 0 description RR4->RR1 set interfaces ge-1/0/10 unit 0 family inet address 10.0.14.2/24 set interfaces ge-1/0/11 unit 0 description RR4->R8 set interfaces ge-1/0/11 unit 0 family inet address 10.0.48.1/24 set interfaces lo0 unit 0 family inet address 10.0.0.40/32 set protocols bgp group rr type internal set protocols bgp group rr local-address 10.0.0.40 set protocols bgp group rr family inet unicast add-path receive set protocols bgp group rr neighbor 10.0.0.10 set protocols bgp group rr_client type internal set protocols bgp group rr_client local-address 10.0.0.40 set protocols bgp group rr_client cluster 10.0.0.40 set protocols bgp group rr_client neighbor 10.0.0.80 family inet unicast add-path send prefix-policy addpath-communities-send-4713-100 set protocols bgp group rr_client neighbor 10.0.0.80 family inet unicast add-path send path-count 6 set protocols ospf area 0.0.0.0 interface ge-1/0/10 set protocols ospf area 0.0.0.0 interface lo0.40 passive set protocols ospf area 0.0.0.0 interface ge-1/0/11 set policy-options community addpath-communities-send members 4713:100 set policy-options policy-statement addpath-communities-send-4713-100 term term1 from protocol bgp set policy-options policy-statement addpath-communities-send-4713-100 term term1 from community addpath-communities-send set policy-options policy-statement addpath-communities-send-4713-100 term term1 then add-path send-count 16 set policy-options policy-statement addpath-communities-send-4713-100 term term1 then accept set routing-options autonomous-system 64501 路由器 R5 set interfaces ge-1/0/10 unit 0 description R5->RR1 set interfaces ge-1/0/10 unit 0 family inet address 10.0.15.2/24 set interfaces lo0 unit 0 family inet address 10.0.0.50/32 set protocols bgp group e1 type external set protocols bgp group e1 neighbor 10.0.15.1 export s2b set protocols bgp group e1 neighbor 10.0.15.1 peer-as 64501 set policy-options policy-statement s2b from protocol static set policy-options policy-statement s2b from protocol direct set policy-options policy-statement s2b then community add addpath-community set policy-options policy-statement s2b then as-path-expand 2 set policy-options policy-statement s2b then accept set policy-options community addpath-community members 4713:100 set routing-options static route 199.1.1.1/32 reject set routing-options static route 198.1.1.1/32 reject set routing-options autonomous-system 64502 路由器 R6 set interfaces ge-1/0/10 unit 0 description R6->R2 set interfaces ge-1/0/10 unit 0 family inet address 10.0.26.2/24 set interfaces lo0 unit 0 family inet address 10.0.0.60/32 set protocols bgp group e1 type external set protocols bgp group e1 neighbor 10.0.26.1 export s2b set protocols bgp group e1 neighbor 10.0.26.1 peer-as 64501 set policy-options policy-statement s2b from protocol static set policy-options policy-statement s2b from protocol direct set policy-options policy-statement s2b then community add addpath-community set policy-options policy-statement s2b then accept set policy-options community addpath-community members 4713:100 set routing-options static route 199.1.1.1/32 reject set routing-options static route 198.1.1.1/32 reject set routing-options autonomous-system 64502 路由器 R7 set interfaces ge-1/0/10 unit 0 description R7->R3 set interfaces ge-1/0/10 unit 0 family inet address 10.0.37.2/24 set interfaces lo0 unit 0 family inet address 10.0.0.70/32 set protocols bgp group e1 type external set protocols bgp group e1 neighbor 10.0.37.1 export s2b set protocols bgp group e1 neighbor 10.0.37.1 peer-as 64501 set policy-options policy-statement s2b from protocol static set policy-options policy-statement s2b from protocol direct set policy-options policy-statement s2b then community add addpath-community set policy-options policy-statement s2b then accept set policy-options community addpath-community members 4713:100 set routing-options static route 199.1.1.1/32 reject set routing-options autonomous-system 64502 路由器 R8 set interfaces ge-1/0/10 unit 0 description R8->RR4 set interfaces ge-1/0/10 unit 0 family inet address 10.0.48.2/24 set interfaces lo0 unit 0 family inet address 10.0.0.80/32 set protocols bgp group rr type internal set protocols bgp group rr local-address 10.0.0.80 set protocols bgp group rr neighbor 10.0.0.40 family inet unicast add-path receive set protocols ospf area 0.0.0.0 interface lo0.0 passive set protocols ospf area 0.0.0.0 interface ge-1/0/10.8 set routing-options autonomous-system 64501 set chassis fpc 1 pic 0 tunnel-services bandwidth 1g 以下示例要求您在配置层次结构中导航各个级别。有关导航 CLI 的信息，请参阅 CLI 用户指南中的在配置模式下使用 CLI 编辑器。 要配置路由器 RR4： 注： 修改相应的接口名称、地址和其他参数后，对其他路由器重复此过程。 修改相应的接口名称、地址和其他参数后，对其他路由器重复此过程。 使用 IPv4 地址配置接口。 [edit interfaces] user@RR4# set ge-1/0/10 unit 0 description RR4->RR1 user@RR4# set ge-1/0/10 unit 0 family inet address 10.0.14.2/24 user@RR4# set ge-1/0/11 unit 0 description RR4->R8 user@RR4# set ge-1/0/11 unit 0 family inet address 10.0.48.1/24 配置环路地址。 [edit interfaces] user@RR4# set lo0 unit 0 family inet address 10.0.0.40/32 配置 OSPF 或任何其他内部网关协议 （IGP）。 [edit protocols] user@RR4# set ospf area 0.0.0.0 interface lo0.40 passive user@RR4# set ospf area 0.0.0.0 interface ge-1/0/10 user@RR4# set ospf area 0.0.0.0 interface ge-1/0/11 为路由反射器配置两个 IBGP 组 rr，为路由反射器的客户端配置两个 rr_client。 [edit protocols] user@RR4# set bgp group rr type internal user@RR4# set bgp group rr local-address 10.0.0.40 user@RR4# set bgp group rr family inet unicast add-path receive user@RR4# set bgp group rr neighbor 10.0.0.10 user@RR4# set bgp group rr_client type internal user@RR4# set bgp group rr_client local-address 10.0.0.40 user@RR4# set bgp group rr_client cluster 10.0.0.40 将该功能配置为发送仅包含 4713：100 社区值的多个路径，并将播发的多路径数限制为 6。 [edit protocols] user@RR4# set bgp group rr_client neighbor 10.0.0.80 family inet unicast add-path send prefix-policy addpath-communities-send-4713-100 user@RR4# set bgp group rr_client neighbor 10.0.0.80 family inet unicast add-path send path-count 6 定义一个策略 addpath-community-members 4713:100 来过滤具有社区值 4713：100 的前缀，并将设备限制为向路由器 R8 发送最多 16 条路径。此限制将覆盖之前在 BGP 组层次结构级别配置的添加路径发送路径计数 6。 [edit policy-options] user@RR4# set community addpath-communities-send members 4713:100 user@RR4# set policy-statement addpath-communities-send-4713-100 term term1 from protocol bgp user@RR4# set policy-statement addpath-communities-send-4713-100 term term1 from community addpath-communities-send user@RR4# set policy-statement addpath-communities-send-4713-100 term term1 then add-path send-count 16 user@RR4# set policy-statement addpath-communities-send-4713-100 term term1 then accept 为 BGP 主机配置路由器 ID 和自治系统。 [edit routing-options] user@RR4# set router-id 10.0.0.40 user@RR4# set autonomous-system 64501 在配置模式下，输入 show interfaces 、 show protocols 、 show routing-options 和 show policy-options 命令，以确认您的配置。如果输出未显示预期的配置，请重复此示例中的说明，以便进行更正。 [edit] user@RR4# show interfaces ge-1/0/10 { unit 0 { description RR4->RR1; family inet { address 10.0.14.2/24; } } } ge-1/0/11 { unit 0 { description RR4->R8; family inet { address 10.0.48.1/24; } } } lo0 { unit 0 { family inet { address 10.0.0.10/32; } } } [edit] user@RR4# show protocols bgp { group rr { type internal; local-address 10.0.0.40; family inet { unicast { add-path { receive; } } } neighbor 10.0.0.10; } group rr_client { type internal; local-address 10.0.0.40; cluster 10.0.0.40; neighbor 10.0.0.80 { family inet { unicast { add-path { send { prefix-policy addpath-communities-send-4713-100; path-count 6; } } } } } } } ospf { area 0.0.0.0 { interface ge-1/0/10.0; interface lo0.40 { passive; } interface ge-1/0/11.0; } } [edit] user@RR4# show policy-options policy-statement addpath-communities-send-4713-100 { term term1 { from { protocol bgp; community addpath-communities-send; } then { add-path send-count 16; accept; } } } community addpath-communities-send members 4713:100; [edit] user@RR4# show routing-options router-id 10.0.0.40; autonomous-system 64501; 如果完成设备配置，请提交配置。 user@RR4# commit",
      "sections": [
        {
          "title": "CLI 快速配置",
          "level": 4,
          "content": "要快速配置此示例，请复制以下命令，将其粘贴到文本文件中，删除所有换行符，更改与您的网络配置匹配所需的任何详细信息，将命令复制并粘贴到层次结构级别的 CLI [edit] 中，然后从配置模式进入提交。 路由器 RR1 set interfaces ge-1/0/10 unit 0 description RR1->R2 set interfaces ge-1/0/10 unit 0 family inet address 10.0.12.1/24 set interfaces ge-1/0/11 unit 0 description RR1->RR4 set interfaces ge-1/0/11 unit 0 family inet address 10.0.14.1/24 set interfaces ge-1/0/12 unit 0 description RR1->R5 set interfaces ge-1/0/12 unit 0 family inet address 10.0.15.1/24 set interfaces ge-1/0/13 unit 0 description RR1->R3 set interfaces ge-1/0/13 unit 0 family inet address 10.0.13.1/24 set interfaces lo0 unit 0 family inet address 10.0.0.10/32 set protocols bgp group rr type internal set protocols bgp group rr local-address 10.0.0.10 set protocols bgp group rr cluster 10.0.0.10 set protocols bgp group rr multipath set protocols bgp group rr neighbor 10.0.0.20 set protocols bgp group rr neighbor 10.0.0.30 set protocols bgp group e1 type external set protocols bgp group e1 neighbor 10.0.15.2 local-address 10.0.15.1 set protocols bgp group e1 neighbor 10.0.15.2 peer-as 64502 set protocols bgp group rr_rr type internal set protocols bgp group rr_rr local-address 10.0.0.10 set protocols bgp group rr_rr neighbor 10.0.0.40 family inet unicast add-path send path-count 6 set protocols ospf area 0.0.0.0 interface lo0.10 passive set protocols ospf area 0.0.0.0 interface ge-1/0/10 set protocols ospf area 0.0.0.0 interface ge-1/0/13 set protocols ospf area 0.0.0.0 interface ge-1/0/11 set protocols ospf area 0.0.0.0 interface ge-1/0/12 set routing-options router-id 10.0.0.10 set routing-options autonomous-system 64501 路由器 R2 set interfaces ge-1/0/10 unit 0 description R2->RR1 set interfaces ge-1/0/10 unit 0 family inet address 10.0.12.2/24 set interfaces ge-1/0/11 unit 0 description R2->R6 set interfaces ge-1/0/11 unit 0 family inet address 10.0.26.1/24 set interfaces lo0 unit 0 family inet address 10.0.0.20/32 set protocols bgp group rr local-address 10.0.0.20 set protocols bgp group rr neighbor 10.0.0.10 export set_nh_self set protocols bgp group e1 type external set protocols bgp group e1 neighbor 10.0.26.2 peer-as 64502 set protocols ospf area 0.0.0.0 interface lo0.20 passive set protocols ospf area 0.0.0.0 interface ge-1/0/10 set protocols ospf area 0.0.0.0 interface ge-1/0/11 set policy-options policy-statement set_nh_self then next-hop self set routing-options autonomous-system 64501 路由器 R3 set interfaces ge-1/0/10 unit 0 description R3->RR1 set interfaces ge-1/0/10 unit 0 family inet address 10.0.13.2/24 set interfaces ge-1/0/11 unit 0 description R3->R7 set interfaces ge-1/0/11 unit 0 family inet address 10.0.37.1/24 set interfaces lo0 unit 0 family inet address 10.0.0.30/32 set protocols bgp group rr type internal set protocols bgp group rr local-address 10.0.0.30 set protocols bgp group rr neighbor 10.0.0.10 export set_nh_self set protocols bgp group e1 type external set protocols bgp group e1 neighbor 10.0.37.2 peer-as 64502 set protocols ospf area 0.0.0.0 interface lo0.30 passive set protocols ospf area 0.0.0.0 interface ge-1/0/10 set protocols ospf area 0.0.0.0 interface ge-1/0/13 set policy-options policy-statement set_nh_self then next-hop self set routing-options autonomous-system 64501 路由器 RR4 set interfaces ge-1/0/10 unit 0 description RR4->RR1 set interfaces ge-1/0/10 unit 0 family inet address 10.0.14.2/24 set interfaces ge-1/0/11 unit 0 description RR4->R8 set interfaces ge-1/0/11 unit 0 family inet address 10.0.48.1/24 set interfaces lo0 unit 0 family inet address 10.0.0.40/32 set protocols bgp group rr type internal set protocols bgp group rr local-address 10.0.0.40 set protocols bgp group rr family inet unicast add-path receive set protocols bgp group rr neighbor 10.0.0.10 set protocols bgp group rr_client type internal set protocols bgp group rr_client local-address 10.0.0.40 set protocols bgp group rr_client cluster 10.0.0.40 set protocols bgp group rr_client neighbor 10.0.0.80 family inet unicast add-path send prefix-policy addpath-communities-send-4713-100 set protocols bgp group rr_client neighbor 10.0.0.80 family inet unicast add-path send path-count 6 set protocols ospf area 0.0.0.0 interface ge-1/0/10 set protocols ospf area 0.0.0.0 interface lo0.40 passive set protocols ospf area 0.0.0.0 interface ge-1/0/11 set policy-options community addpath-communities-send members 4713:100 set policy-options policy-statement addpath-communities-send-4713-100 term term1 from protocol bgp set policy-options policy-statement addpath-communities-send-4713-100 term term1 from community addpath-communities-send set policy-options policy-statement addpath-communities-send-4713-100 term term1 then add-path send-count 16 set policy-options policy-statement addpath-communities-send-4713-100 term term1 then accept set routing-options autonomous-system 64501 路由器 R5 set interfaces ge-1/0/10 unit 0 description R5->RR1 set interfaces ge-1/0/10 unit 0 family inet address 10.0.15.2/24 set interfaces lo0 unit 0 family inet address 10.0.0.50/32 set protocols bgp group e1 type external set protocols bgp group e1 neighbor 10.0.15.1 export s2b set protocols bgp group e1 neighbor 10.0.15.1 peer-as 64501 set policy-options policy-statement s2b from protocol static set policy-options policy-statement s2b from protocol direct set policy-options policy-statement s2b then community add addpath-community set policy-options policy-statement s2b then as-path-expand 2 set policy-options policy-statement s2b then accept set policy-options community addpath-community members 4713:100 set routing-options static route 199.1.1.1/32 reject set routing-options static route 198.1.1.1/32 reject set routing-options autonomous-system 64502 路由器 R6 set interfaces ge-1/0/10 unit 0 description R6->R2 set interfaces ge-1/0/10 unit 0 family inet address 10.0.26.2/24 set interfaces lo0 unit 0 family inet address 10.0.0.60/32 set protocols bgp group e1 type external set protocols bgp group e1 neighbor 10.0.26.1 export s2b set protocols bgp group e1 neighbor 10.0.26.1 peer-as 64501 set policy-options policy-statement s2b from protocol static set policy-options policy-statement s2b from protocol direct set policy-options policy-statement s2b then community add addpath-community set policy-options policy-statement s2b then accept set policy-options community addpath-community members 4713:100 set routing-options static route 199.1.1.1/32 reject set routing-options static route 198.1.1.1/32 reject set routing-options autonomous-system 64502 路由器 R7 set interfaces ge-1/0/10 unit 0 description R7->R3 set interfaces ge-1/0/10 unit 0 family inet address 10.0.37.2/24 set interfaces lo0 unit 0 family inet address 10.0.0.70/32 set protocols bgp group e1 type external set protocols bgp group e1 neighbor 10.0.37.1 export s2b set protocols bgp group e1 neighbor 10.0.37.1 peer-as 64501 set policy-options policy-statement s2b from protocol static set policy-options policy-statement s2b from protocol direct set policy-options policy-statement s2b then community add addpath-community set policy-options policy-statement s2b then accept set policy-options community addpath-community members 4713:100 set routing-options static route 199.1.1.1/32 reject set routing-options autonomous-system 64502 路由器 R8 set interfaces ge-1/0/10 unit 0 description R8->RR4 set interfaces ge-1/0/10 unit 0 family inet address 10.0.48.2/24 set interfaces lo0 unit 0 family inet address 10.0.0.80/32 set protocols bgp group rr type internal set protocols bgp group rr local-address 10.0.0.80 set protocols bgp group rr neighbor 10.0.0.40 family inet unicast add-path receive set protocols ospf area 0.0.0.0 interface lo0.0 passive set protocols ospf area 0.0.0.0 interface ge-1/0/10.8 set routing-options autonomous-system 64501 set chassis fpc 1 pic 0 tunnel-services bandwidth 1g",
          "commands_by_device": {
            "路由器 RR1": "set interfaces ge-1/0/10 unit 0 description RR1->R2\nset interfaces ge-1/0/10 unit 0 family inet address 10.0.12.1/24\nset interfaces ge-1/0/11 unit 0 description RR1->RR4\nset interfaces ge-1/0/11 unit 0 family inet address 10.0.14.1/24\nset interfaces ge-1/0/12 unit 0 description RR1->R5\nset interfaces ge-1/0/12 unit 0 family inet address 10.0.15.1/24\nset interfaces ge-1/0/13 unit 0 description RR1->R3\nset interfaces ge-1/0/13 unit 0 family inet address 10.0.13.1/24\nset interfaces lo0 unit 0 family inet address 10.0.0.10/32\nset protocols bgp group rr type internal\nset protocols bgp group rr local-address 10.0.0.10\nset protocols bgp group rr cluster 10.0.0.10\nset protocols bgp group rr multipath\nset protocols bgp group rr neighbor 10.0.0.20\nset protocols bgp group rr neighbor 10.0.0.30\nset protocols bgp group e1 type external\nset protocols bgp group e1 neighbor 10.0.15.2 local-address 10.0.15.1\nset protocols bgp group e1 neighbor 10.0.15.2 peer-as 64502\nset protocols bgp group rr_rr type internal\nset protocols bgp group rr_rr local-address 10.0.0.10\nset protocols bgp group rr_rr neighbor 10.0.0.40 family inet unicast add-path send path-count 6\nset protocols ospf area 0.0.0.0 interface lo0.10 passive\nset protocols ospf area 0.0.0.0 interface ge-1/0/10\nset protocols ospf area 0.0.0.0 interface ge-1/0/13\nset protocols ospf area 0.0.0.0 interface ge-1/0/11\nset protocols ospf area 0.0.0.0 interface ge-1/0/12\nset routing-options router-id 10.0.0.10\nset routing-options autonomous-system 64501",
            "路由器 R2": "set interfaces ge-1/0/10 unit 0 description R2->RR1\nset interfaces ge-1/0/10 unit 0 family inet address 10.0.12.2/24\nset interfaces ge-1/0/11 unit 0 description R2->R6\nset interfaces ge-1/0/11 unit 0 family inet address 10.0.26.1/24\nset interfaces lo0 unit 0 family inet address 10.0.0.20/32\nset protocols bgp group rr local-address 10.0.0.20\nset protocols bgp group rr neighbor 10.0.0.10 export set_nh_self\nset protocols bgp group e1 type external\nset protocols bgp group e1 neighbor 10.0.26.2 peer-as 64502\nset protocols ospf area 0.0.0.0 interface lo0.20 passive\nset protocols ospf area 0.0.0.0 interface ge-1/0/10\nset protocols ospf area 0.0.0.0 interface ge-1/0/11\nset policy-options policy-statement set_nh_self then next-hop self\nset routing-options autonomous-system 64501",
            "路由器 R3": "set interfaces ge-1/0/10 unit 0 description R3->RR1\nset interfaces ge-1/0/10 unit 0 family inet address 10.0.13.2/24\nset interfaces ge-1/0/11 unit 0 description R3->R7\nset interfaces ge-1/0/11 unit 0 family inet address 10.0.37.1/24\nset interfaces lo0 unit 0 family inet address 10.0.0.30/32\nset protocols bgp group rr type internal\nset protocols bgp group rr local-address 10.0.0.30\nset protocols bgp group rr neighbor 10.0.0.10 export set_nh_self\nset protocols bgp group e1 type external\nset protocols bgp group e1 neighbor 10.0.37.2 peer-as 64502\nset protocols ospf area 0.0.0.0 interface lo0.30 passive\nset protocols ospf area 0.0.0.0 interface ge-1/0/10\nset protocols ospf area 0.0.0.0 interface ge-1/0/13\nset policy-options policy-statement set_nh_self then next-hop self\nset routing-options autonomous-system 64501",
            "路由器 RR4": "set interfaces ge-1/0/10 unit 0 description RR4->RR1\nset interfaces ge-1/0/10 unit 0 family inet address 10.0.14.2/24\nset interfaces ge-1/0/11 unit 0 description RR4->R8\nset interfaces ge-1/0/11 unit 0 family inet address 10.0.48.1/24\nset interfaces lo0 unit 0 family inet address 10.0.0.40/32\nset protocols bgp group rr type internal\nset protocols bgp group rr local-address 10.0.0.40\nset protocols bgp group rr family inet unicast add-path receive\nset protocols bgp group rr neighbor 10.0.0.10\nset protocols bgp group rr_client type internal\nset protocols bgp group rr_client local-address 10.0.0.40\nset protocols bgp group rr_client cluster 10.0.0.40\nset protocols bgp group rr_client neighbor 10.0.0.80 family inet unicast add-path send prefix-policy addpath-communities-send-4713-100\nset protocols bgp group rr_client neighbor 10.0.0.80 family inet unicast add-path send path-count 6\nset protocols ospf area 0.0.0.0 interface ge-1/0/10\nset protocols ospf area 0.0.0.0 interface lo0.40 passive\nset protocols ospf area 0.0.0.0 interface ge-1/0/11\nset policy-options community addpath-communities-send members 4713:100\nset policy-options policy-statement addpath-communities-send-4713-100 term term1 from protocol bgp\nset policy-options policy-statement addpath-communities-send-4713-100 term term1 from community addpath-communities-send\nset policy-options policy-statement addpath-communities-send-4713-100 term term1 then add-path send-count 16\nset policy-options policy-statement addpath-communities-send-4713-100 term term1 then accept\nset routing-options autonomous-system 64501",
            "路由器 R5": "set interfaces ge-1/0/10 unit 0 description R5->RR1\nset interfaces ge-1/0/10 unit 0 family inet address 10.0.15.2/24\nset interfaces lo0 unit 0 family inet address 10.0.0.50/32\nset protocols bgp group e1 type external\nset protocols bgp group e1 neighbor 10.0.15.1 export s2b\nset protocols bgp group e1 neighbor 10.0.15.1 peer-as 64501\nset policy-options policy-statement s2b from protocol static\nset policy-options policy-statement s2b from protocol direct\nset policy-options policy-statement s2b then community add addpath-community\nset policy-options policy-statement s2b then as-path-expand 2\nset policy-options policy-statement s2b then accept\nset policy-options community addpath-community members 4713:100\nset routing-options static route 199.1.1.1/32 reject\nset routing-options static route 198.1.1.1/32 reject\nset routing-options autonomous-system 64502",
            "路由器 R6": "set interfaces ge-1/0/10 unit 0 description R6->R2\nset interfaces ge-1/0/10 unit 0 family inet address 10.0.26.2/24\nset interfaces lo0 unit 0 family inet address 10.0.0.60/32\nset protocols bgp group e1 type external\nset protocols bgp group e1 neighbor 10.0.26.1 export s2b\nset protocols bgp group e1 neighbor 10.0.26.1 peer-as 64501\nset policy-options policy-statement s2b from protocol static\nset policy-options policy-statement s2b from protocol direct\nset policy-options policy-statement s2b then community add addpath-community\nset policy-options policy-statement s2b then accept\nset policy-options community addpath-community members 4713:100\nset routing-options static route 199.1.1.1/32 reject\nset routing-options static route 198.1.1.1/32 reject\nset routing-options autonomous-system 64502",
            "路由器 R7": "set interfaces ge-1/0/10 unit 0 description R7->R3\nset interfaces ge-1/0/10 unit 0 family inet address 10.0.37.2/24\nset interfaces lo0 unit 0 family inet address 10.0.0.70/32\nset protocols bgp group e1 type external\nset protocols bgp group e1 neighbor 10.0.37.1 export s2b\nset protocols bgp group e1 neighbor 10.0.37.1 peer-as 64501\nset policy-options policy-statement s2b from protocol static\nset policy-options policy-statement s2b from protocol direct\nset policy-options policy-statement s2b then community add addpath-community\nset policy-options policy-statement s2b then accept\nset policy-options community addpath-community members 4713:100\nset routing-options static route 199.1.1.1/32 reject\nset routing-options autonomous-system 64502",
            "路由器 R8": "set interfaces ge-1/0/10 unit 0 description R8->RR4\nset interfaces ge-1/0/10 unit 0 family inet address 10.0.48.2/24\nset interfaces lo0 unit 0 family inet address 10.0.0.80/32\nset protocols bgp group rr type internal\nset protocols bgp group rr local-address 10.0.0.80\nset protocols bgp group rr neighbor 10.0.0.40 family inet unicast add-path receive\nset protocols ospf area 0.0.0.0 interface lo0.0 passive\nset protocols ospf area 0.0.0.0 interface ge-1/0/10.8\nset routing-options autonomous-system 64501\nset chassis fpc 1 pic 0 tunnel-services bandwidth 1g"
          }
        },
        {
          "title": "配置路由器 RR4",
          "level": 4,
          "content": "以下示例要求您在配置层次结构中导航各个级别。有关导航 CLI 的信息，请参阅 CLI 用户指南中的在配置模式下使用 CLI 编辑器。 要配置路由器 RR4： 注： 修改相应的接口名称、地址和其他参数后，对其他路由器重复此过程。 修改相应的接口名称、地址和其他参数后，对其他路由器重复此过程。 使用 IPv4 地址配置接口。 [edit interfaces] user@RR4# set ge-1/0/10 unit 0 description RR4->RR1 user@RR4# set ge-1/0/10 unit 0 family inet address 10.0.14.2/24 user@RR4# set ge-1/0/11 unit 0 description RR4->R8 user@RR4# set ge-1/0/11 unit 0 family inet address 10.0.48.1/24 配置环路地址。 [edit interfaces] user@RR4# set lo0 unit 0 family inet address 10.0.0.40/32 配置 OSPF 或任何其他内部网关协议 （IGP）。 [edit protocols] user@RR4# set ospf area 0.0.0.0 interface lo0.40 passive user@RR4# set ospf area 0.0.0.0 interface ge-1/0/10 user@RR4# set ospf area 0.0.0.0 interface ge-1/0/11 为路由反射器配置两个 IBGP 组 rr，为路由反射器的客户端配置两个 rr_client。 [edit protocols] user@RR4# set bgp group rr type internal user@RR4# set bgp group rr local-address 10.0.0.40 user@RR4# set bgp group rr family inet unicast add-path receive user@RR4# set bgp group rr neighbor 10.0.0.10 user@RR4# set bgp group rr_client type internal user@RR4# set bgp group rr_client local-address 10.0.0.40 user@RR4# set bgp group rr_client cluster 10.0.0.40 将该功能配置为发送仅包含 4713：100 社区值的多个路径，并将播发的多路径数限制为 6。 [edit protocols] user@RR4# set bgp group rr_client neighbor 10.0.0.80 family inet unicast add-path send prefix-policy addpath-communities-send-4713-100 user@RR4# set bgp group rr_client neighbor 10.0.0.80 family inet unicast add-path send path-count 6 定义一个策略 addpath-community-members 4713:100 来过滤具有社区值 4713：100 的前缀，并将设备限制为向路由器 R8 发送最多 16 条路径。此限制将覆盖之前在 BGP 组层次结构级别配置的添加路径发送路径计数 6。 [edit policy-options] user@RR4# set community addpath-communities-send members 4713:100 user@RR4# set policy-statement addpath-communities-send-4713-100 term term1 from protocol bgp user@RR4# set policy-statement addpath-communities-send-4713-100 term term1 from community addpath-communities-send user@RR4# set policy-statement addpath-communities-send-4713-100 term term1 then add-path send-count 16 user@RR4# set policy-statement addpath-communities-send-4713-100 term term1 then accept 为 BGP 主机配置路由器 ID 和自治系统。 [edit routing-options] user@RR4# set router-id 10.0.0.40 user@RR4# set autonomous-system 64501",
          "sections": [
            {
              "title": "分步过程",
              "level": 5,
              "step_by_step": [
                {
                  "step": 1,
                  "description": "使用 IPv4 地址配置接口。",
                  "code": [
                    "[edit interfaces]",
                    "user@RR4# set ge-1/0/10 unit 0 description RR4->RR1 ",
                    "user@RR4# set ge-1/0/10 unit 0 family inet address 10.0.14.2/24",
                    "user@RR4# set ge-1/0/11 unit 0 description RR4->R8 ",
                    "user@RR4# set ge-1/0/11 unit 0 family inet address 10.0.48.1/24"
                  ]
                },
                {
                  "step": 2,
                  "description": "配置环路地址。",
                  "code": [
                    "[edit interfaces]",
                    "user@RR4# set lo0 unit 0 family inet address 10.0.0.40/32"
                  ]
                },
                {
                  "step": 3,
                  "description": "配置 OSPF 或任何其他内部网关协议 （IGP）。",
                  "code": [
                    "[edit protocols]",
                    "user@RR4# set ospf area 0.0.0.0 interface lo0.40 passive",
                    "user@RR4# set ospf area 0.0.0.0 interface ge-1/0/10",
                    "user@RR4# set ospf area 0.0.0.0 interface ge-1/0/11"
                  ]
                },
                {
                  "step": 4,
                  "description": "为路由反射器配置两个 IBGP 组 rr，为路由反射器的客户端配置两个 rr_client。",
                  "code": [
                    "[edit protocols]",
                    "user@RR4# set bgp group rr type internal",
                    "user@RR4# set bgp group rr local-address 10.0.0.40",
                    "user@RR4# set bgp group rr family inet unicast add-path receive",
                    "user@RR4# set bgp group rr neighbor 10.0.0.10",
                    "user@RR4# set bgp group rr_client type internal",
                    "user@RR4# set bgp group rr_client local-address 10.0.0.40 ",
                    "user@RR4# set bgp group rr_client cluster 10.0.0.40"
                  ]
                },
                {
                  "step": 5,
                  "description": "将该功能配置为发送仅包含 4713：100 社区值的多个路径，并将播发的多路径数限制为 6。",
                  "code": [
                    "[edit protocols]",
                    "user@RR4# set bgp group rr_client neighbor 10.0.0.80 family inet unicast add-path send prefix-policy addpath-communities-send-4713-100",
                    "user@RR4# set bgp group rr_client neighbor 10.0.0.80 family inet unicast add-path send path-count 6"
                  ]
                },
                {
                  "step": 6,
                  "description": "定义一个策略 addpath-community-members 4713:100 来过滤具有社区值 4713：100 的前缀，并将设备限制为向路由器 R8 发送最多 16 条路径。此限制将覆盖之前在 BGP 组层次结构级别配置的添加路径发送路径计数 6。",
                  "code": [
                    "[edit policy-options]",
                    "user@RR4# set community addpath-communities-send members 4713:100",
                    "user@RR4# set policy-statement addpath-communities-send-4713-100 term term1 from protocol bgp",
                    "user@RR4# set policy-statement addpath-communities-send-4713-100 term term1 from community addpath-communities-send",
                    "user@RR4# set policy-statement addpath-communities-send-4713-100 term term1 then add-path send-count 16",
                    "user@RR4# set policy-statement addpath-communities-send-4713-100 term term1 then accept"
                  ]
                },
                {
                  "step": 7,
                  "description": "为 BGP 主机配置路由器 ID 和自治系统。",
                  "code": [
                    "[edit routing-options]",
                    "user@RR4# set router-id 10.0.0.40",
                    "user@RR4# set autonomous-system 64501"
                  ]
                }
              ]
            }
          ]
        },
        {
          "title": "结果",
          "level": 4,
          "content": "在配置模式下，输入 show interfaces 、 show protocols 、 show routing-options 和 show policy-options 命令，以确认您的配置。如果输出未显示预期的配置，请重复此示例中的说明，以便进行更正。 如果完成设备配置，请提交配置。",
          "code": [
            "[edit] \nuser@RR4#show interfacesge-1/0/10 {\n    unit 0 {\n        description RR4->RR1;\n        family inet {\n            address 10.0.14.2/24;\n        }\n    }\n}\nge-1/0/11 {\n    unit 0 {\n        description RR4->R8;\n        family inet {\n            address 10.0.48.1/24;\n        }\n    }\n}\nlo0 {\n    unit 0 {\n        family inet {\n            address 10.0.0.10/32;\n        }\n    }\n}",
            "[edit] \nuser@RR4#show protocolsbgp {\n    group rr {\n        type internal;\n        local-address 10.0.0.40;\n        family inet {\n            unicast {\n                add-path {\n                    receive;\n                }\n            }\n        }\n        neighbor 10.0.0.10;\n    }\n    group rr_client {\n        type internal;\n        local-address 10.0.0.40;\n        cluster 10.0.0.40;\n        neighbor 10.0.0.80 {\n            family inet {\n                unicast {\n                    add-path {\n                        send {\n                            prefix-policy addpath-communities-send-4713-100;\n                            path-count 6;\n                        }\n                    }\n                }\n            }\n        }\n    }\n}\nospf {\n    area 0.0.0.0 {\n        interface ge-1/0/10.0;\n        interface lo0.40 {\n            passive;\n        }\n        interface ge-1/0/11.0;\n    }\n}",
            "[edit] \nuser@RR4#show policy-optionspolicy-statement addpath-communities-send-4713-100 {\n    term term1 {\n        from {\n            protocol bgp;\n            community addpath-communities-send;\n        }\n        then {\n            add-path send-count 16;\n            accept;\n        }\n    }\n}\ncommunity addpath-communities-send members 4713:100;",
            "[edit] \nuser@RR4#show routing-optionsrouter-id 10.0.0.40;\nautonomous-system 64501;",
            "user@RR4#commit"
          ]
        }
      ]
    }
  ],
  "content": "播发所有可用的多个路径可能会导致设备内存上的大量处理开销。如果要在事先实际不知道前缀的情况下播发有限的前缀子集，则可以使用 BGP 公共组值来确定需要向 BGP 邻接方播发的前缀路由。此示例说明如何定义路由策略，以根据已知的 BGP 社区值过滤和播发多个路径。 要求 配置此示例之前，不需要除设备初始化之外的特殊配置"
}