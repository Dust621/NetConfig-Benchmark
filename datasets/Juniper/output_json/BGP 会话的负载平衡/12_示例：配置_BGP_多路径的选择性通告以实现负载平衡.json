{
  "title": "示例：配置 BGP 多路径的选择性通告以实现负载平衡",
  "sections": [
    {
      "title": "要求",
      "level": 3,
      "content": "配置此示例之前，不需要除设备初始化之外的特殊配置。 此示例使用以下硬件和软件组件： 八款路由器，可组合使用 M 系列、MX 系列或 T 系列路由器 设备上的 Junos OS 16.1R2 或更高版本 配置此示例之前，不需要除设备初始化之外的特殊配置。 此示例使用以下硬件和软件组件： 八款路由器，可组合使用 M 系列、MX 系列或 T 系列路由器 设备上的 Junos OS 16.1R2 或更高版本"
    },
    {
      "title": "概述",
      "level": 3,
      "content": "从 Junos OS 16.1R2 版开始，您可以将 BGP 限制为 add-path 仅向参与者通告多个路径。您最多可以限制和配置 BGP multipath 算法选择的六个前缀。多路径的选择性广告有利于互联网服务提供商和数据中心使用路由反射器在 IBGP 中构建路径内多样性。您可以启用 BGP 路由反射器来通告作为负载均衡参与者路径的多路径。 在 中 图 7，RR1 和 RR4 是路由反射器。路由器 R2 和 R3 是路由反射器 RR1 的客户端。路由器 R8 是路由反射器 RR4 的客户端。具有邻居 R2 和 R3 的 RR1 组配置为多路径。路由器 R5、R6 和路由器 R7 将静态路由 199.1.1.1/32 和 198.1.1.1/32 重新分发到 BGP 中。 在路由器 RR1 上配置负载均衡策略，以便计算 199.1.1.1/32 路由的多路径。多路径功能在邻居 RR4 的添加路径下配置。但是，路由器 RR4 未配置负载平衡多路径。路由器 RR1 配置为向路由器 RR4 发送最多 6 个从多路径候选路由中选择的 199.1.1.1/32 添加路径路由。",
      "sections": [
        {
          "title": "拓扑学",
          "level": 4,
          "content": "在 中 图 7，RR1 和 RR4 是路由反射器。路由器 R2 和 R3 是路由反射器 RR1 的客户端。路由器 R8 是路由反射器 RR4 的客户端。具有邻居 R2 和 R3 的 RR1 组配置为多路径。路由器 R5、R6 和路由器 R7 将静态路由 199.1.1.1/32 和 198.1.1.1/32 重新分发到 BGP 中。 在路由器 RR1 上配置负载均衡策略，以便计算 199.1.1.1/32 路由的多路径。多路径功能在邻居 RR4 的添加路径下配置。但是，路由器 RR4 未配置负载平衡多路径。路由器 RR1 配置为向路由器 RR4 发送最多 6 个从多路径候选路由中选择的 199.1.1.1/32 添加路径路由。",
          "images": [
            "BGP 会话的负载平衡\\images\\12_示例：配置_BGP_多路径的选择性通告以_1.png"
          ]
        }
      ]
    },
    {
      "title": "配置",
      "level": 3,
      "content": "要快速配置此示例，请复制以下命令，将其粘贴到文本文件中，删除所有换行符，更改与您的网络配置匹配所需的任何详细信息，将命令复制并粘贴到层次结构级别的 CLI [edit] 中，然后从配置模式进入提交。 路由器 RR1 set interfaces ge-1/0/10 unit 0 description RR1->R2 set interfaces ge-1/0/10 unit 0 family inet address 10.0.12.1/24 set interfaces ge-1/0/11 unit 0 description RR1->RR4 set interfaces ge-1/0/11 unit 0 family inet address 10.0.14.1/24 set interfaces ge-1/0/12 unit 0 description RR1->R5 set interfaces ge-1/0/12 unit 0 family inet address 10.0.15.1/24 set interfaces ge-1/0/13 unit 0 description RR1->R3 set interfaces ge-1/0/13 unit 0 family inet address 10.0.13.1/24 set interfaces lo0 unit 0 family inet address 10.0.0.10/32 set protocols bgp group rr type internal set protocols bgp group rr local-address 10.0.0.10 set protocols bgp group rr cluster 10.0.0.10 set protocols bgp group rr multipath set protocols bgp group rr neighbor 10.0.0.20 set protocols bgp group rr neighbor 10.0.0.30 set protocols bgp group e1 type external set protocols bgp group e1 neighbor 10.0.15.2 local-address 10.0.15.1 set protocols bgp group e1 neighbor 10.0.15.2 peer-as 64502 set protocols bgp group rr_rr type internal set protocols bgp group rr_rr local-address 10.0.0.10 set protocols bgp group rr_rr neighbor 10.0.0.40 family inet unicast add-path send path-count 6 set protocols bgp group rr_rr neighbor 10.0.0.40 family inet unicast add-path send multipath set protocols ospf area 0.0.0.0 interface lo0.10 passive set protocols ospf area 0.0.0.0 interface ge-1/0/10 set protocols ospf area 0.0.0.0 interface ge-1/0/13 set protocols ospf area 0.0.0.0 interface ge-1/0/11 set protocols ospf area 0.0.0.0 interface ge-1/0/12 set policy-options prefix-list match_199 199.1.1.1/32 set policy-options policy-statement loadbal_199 term match_100 from prefix-list match_199 set policy-options policy-statement loadbal_199 from route-filter 199.1.1.1/32 exact set policy-options policy-statement loadbal_199 then load-balance per-packet set routing-options router-id 10.0.0.10 set routing-options autonomous-system 64501 set routing-options forwarding-table export loadbal_199 路由器 R2 set interfaces ge-1/0/10 unit 0 description R2->RR1 set interfaces ge-1/0/10 unit 0 family inet address 10.0.12.2/24 set interfaces ge-1/0/11 unit 0 description R2->R6 set interfaces ge-1/0/11 unit 0 family inet address 10.0.26.1/24 set interfaces lo0 unit 0 family inet address 10.0.0.20/32 set protocols bgp group rr local-address 10.0.0.20 set protocols bgp group rr neighbor 10.0.0.10 export set_nh_self set protocols bgp group e1 type external set protocols bgp group e1 neighbor 10.0.26.2 peer-as 64502 set protocols ospf area 0.0.0.0 interface lo0.20 passive set protocols ospf area 0.0.0.0 interface ge-1/0/10 set protocols ospf area 0.0.0.0 interface ge-1/0/11 set policy-options policy-statement set_nh_self then next-hop self set routing-options autonomous-system 64501 路由器 R3 set interfaces ge-1/0/10 unit 0 description R3->RR1 set interfaces ge-1/0/10 unit 0 family inet address 10.0.13.2/24 set interfaces ge-1/0/11 unit 0 description R3->R7 set interfaces ge-1/0/11 unit 0 family inet address 10.0.37.1/24 set interfaces lo0 unit 0 family inet address 10.0.0.30/32 set protocols bgp group rr type internal set protocols bgp group rr local-address 10.0.0.30 set protocols bgp group rr neighbor 10.0.0.10 export set_nh_self set protocols bgp group e1 type external set protocols bgp group e1 neighbor 10.0.37.2 peer-as 64502 set protocols ospf area 0.0.0.0 interface lo0.30 passive set protocols ospf area 0.0.0.0 interface ge-1/0/10 set protocols ospf area 0.0.0.0 interface ge-1/0/13 set policy-options policy-statement set_nh_self then next-hop self set routing-options autonomous-system 64501 路由器 RR4 set interfaces ge-1/0/10 unit 0 description RR4->RR1 set interfaces ge-1/0/10 unit 0 family inet address 10.0.14.2/24 set interfaces ge-1/0/11 unit 0 description RR4->R8 set interfaces ge-1/0/11 unit 0 family inet address 10.0.48.1/24 set interfaces lo0 unit 0 family inet address 10.0.0.40/32 set protocols bgp group rr type internal set protocols bgp group rr local-address 10.0.0.40 set protocols bgp group rr family inet unicast add-path receive set protocols bgp group rr neighbor 10.0.0.10 set protocols bgp group rr_client type internal set protocols bgp group rr_client local-address 10.0.0.40 set protocols bgp group rr_client cluster 10.0.0.40 set protocols bgp group rr_client neighbor 10.0.0.80 family inet unicast add-path send prefix-policy addpath-communities-send-4713-100 set protocols bgp group rr_client neighbor 10.0.0.80 family inet unicast add-path send path-count 2 set protocols bgp group rr_client neighbor 10.0.0.80 family inet unicast add-path send multipath set protocols ospf area 0.0.0.0 interface ge-1/0/10 set protocols ospf area 0.0.0.0 interface lo0.40 passive set protocols ospf area 0.0.0.0 interface ge-1/0/11 set policy-options prefix-list match_199 199.1.1.1/32 set routing-options autonomous-system 64501 路由器 R5 set interfaces ge-1/0/10 unit 0 description R5->RR1 set interfaces ge-1/0/10 unit 0 family inet address 10.0.15.2/24 set interfaces lo0 unit 0 family inet address 10.0.0.50/32 set protocols bgp group e1 type external set protocols bgp group e1 neighbor 10.0.15.1 export s2b set protocols bgp group e1 neighbor 10.0.15.1 peer-as 64501 set policy-options policy-statement s2b from protocol static set policy-options policy-statement s2b from protocol direct set policy-options policy-statement s2b then community add addpath-community set policy-options policy-statement s2b then as-path-expand 2 set policy-options policy-statement s2b then accept set policy-options community addpath-community members 4713:100 set routing-options static route 199.1.1.1/32 reject set routing-options static route 198.1.1.1/32 reject set routing-options autonomous-system 64502 路由器 R6 set interfaces ge-1/0/10 unit 0 description R6->R2 set interfaces ge-1/0/10 unit 0 family inet address 10.0.26.2/24 set interfaces lo0 unit 0 family inet address 10.0.0.60/32 set protocols bgp group e1 type external set protocols bgp group e1 neighbor 10.0.26.1 export s2b set protocols bgp group e1 neighbor 10.0.26.1 peer-as 64501 set policy-options policy-statement s2b from protocol static set policy-options policy-statement s2b from protocol direct set policy-options policy-statement s2b then community add addpath-community set policy-options policy-statement s2b then accept set policy-options community addpath-community members 4713:100 set routing-options static route 199.1.1.1/32 reject set routing-options static route 198.1.1.1/32 reject set routing-options autonomous-system 64502 路由器 R7 set interfaces ge-1/0/10 unit 0 description R7->R3 set interfaces ge-1/0/10 unit 0 family inet address 10.0.37.2/24 set interfaces lo0 unit 0 family inet address 10.0.0.70/32 set protocols bgp group e1 type external set protocols bgp group e1 neighbor 10.0.37.1 export s2b set protocols bgp group e1 neighbor 10.0.37.1 peer-as 64501 set policy-options policy-statement s2b from protocol static set policy-options policy-statement s2b from protocol direct set policy-options policy-statement s2b then community add addpath-community set policy-options policy-statement s2b then accept set policy-options community addpath-community members 4713:100 set routing-options static route 199.1.1.1/32 reject set routing-options autonomous-system 64502 路由器 R8 set interfaces ge-1/0/10 unit 0 description R8->RR4 set interfaces ge-1/0/10 unit 0 family inet address 10.0.48.2/24 set interfaces lo0 unit 0 family inet address 10.0.0.80/32 set protocols bgp group rr type internal set protocols bgp group rr local-address 10.0.0.80 set protocols bgp group rr neighbor 10.0.0.40 family inet unicast add-path receive set protocols ospf area 0.0.0.0 interface lo0.0 passive set protocols ospf area 0.0.0.0 interface ge-1/0/10.8 set routing-options autonomous-system 64501 set chassis fpc 1 pic 0 tunnel-services bandwidth 1g 以下示例要求您在配置层次结构中导航各个级别。有关导航 CLI 的信息，请参阅 CLI 用户指南中的在配置模式下使用 CLI 编辑器。 要配置路由器 RR1： 注： 修改相应的接口名称、地址和其他参数后，对其他路由器重复此过程。 修改相应的接口名称、地址和其他参数后，对其他路由器重复此过程。 使用 IPv4 地址配置接口。 [edit interfaces] user@RR1# set ge-1/0/10 unit 0 description RR1->R2 user@RR1# set ge-1/0/10 unit 0 family inet address 10.0.12.1/24 user@RR1# set ge-1/0/11 unit 0 description RR1->RR4 user@RR1# set ge-1/0/11 unit 0 family inet address 10.0.14.1/24 user@RR1# set ge-1/0/12 unit 0 description RR1->R5 user@RR1# set ge-1/0/12 unit 0 family inet address 10.0.15.1/24 user@RR1# set ge-1/0/13 unit 0 description RR1->R3 user@RR1# set ge-1/0/13 unit 0 family inet address 10.0.13.1/24 配置环路地址。 [edit interfaces] user@RR1# set lo0 unit 0 family inet address 10.0.0.10/32 配置内部网关协议 （IGP），例如 OSPF 或 IS-IS。 [edit protocols] user@RR1# set ospf area 0.0.0.0 interface lo0.10 passive user@RR1# set ospf area 0.0.0.0 interface ge-1/0/10 user@RR1# set ospf area 0.0.0.0 interface ge-1/0/13 user@RR1# set ospf area 0.0.0.0 interface ge-1/0/11 user@RR1# set ospf area 0.0.0.0 interface ge-1/0/12 为连接到内部路由器 R2 和 R3 的接口配置内部组 rr。 [edit protocols] user@RR1# set bgp group rr type internal user@RR1# set bgp group rr local-address 10.0.0.10 user@RR1# set bgp group rr cluster 10.0.0.10 user@RR1# set bgp group rr neighbor 10.0.0.20 user@RR1# set bgp group rr neighbor 10.0.0.30 为内部 BGP 组 rr 配置负载平衡。 [edit protocols] user@RR1# set bgp group rr multipath 为路由反射器配置内部组rr_rr。 [edit protocols] user@RR1# set bgp group rr_rr type internal user@RR1# set bgp group rr_rr local-address 10.0.0.10 将添加路径多路径功能配置为仅播发参与者多个路径，并将播发的多路径数限制为 6。 [edit protocols] user@RR1# set bgp group rr_rr neighbor 10.0.0.40 family inet unicast add-path send multipath user@RR1# set bgp group rr_rr neighbor 10.0.0.40 family inet unicast add-path send path-count 6 在连接到外部边缘路由器的接口上配置 EBGP。 [edit protocols] user@RR1# set bgp group e1 type external user@RR1# set bgp group e1 neighbor 10.0.15.2 local-address 10.0.15.1 user@RR1# set bgp group e1 neighbor 10.0.15.2 peer-as 64502 为每个数据包负载平衡定义策略loadbal_199。 [edit policy-options] user@RR1# set prefix-list match_199 199.1.1.1/32 user@RR1# set policy-statement loadbal_199 term match_100 from prefix-list match_199 user@RR1# set policy-statement loadbal_199 from route-filter 199.1.1.1/32 exact user@RR1# set policy-statement loadbal_199 then load-balance per-packet loadbal_199应用定义的导出策略。 [edit routing-options] user@RR1# set forwarding-table export loadbal_199 为 BGP 主机配置路由器 ID 和自治系统。 [edit routing-options] user@RR1# set router-id 10.0.0.10 user@RR1# set autonomous-system 64501 在配置模式下，输入 show interfaces 、 show protocols 、 show routing-options 和 show policy-options 命令，以确认您的配置。如果输出未显示预期的配置，请重复此示例中的说明，以便进行更正。 [edit] user@RR1# show interfaces ge-1/0/10 { unit 0 { description RR1->R2; family inet { address 10.0.12.1/24; } } } ge-1/0/11 { unit 0 { description RR1->RR4; family inet { address 10.0.14.1/24; } } } ge-1/0/12 { unit 0 { description RR1->R5; family inet { address 10.0.15.1/24; } } } ge-1/0/13 { unit 0 { description RR1->R3; family inet { address 10.0.13.1/24; } } } lo0 { unit 0 { family inet { address 10.0.0.10/32; } } } [edit] user@RR1# show protocols bgp { group rr { type internal; local-address 10.0.0.10; cluster 10.0.0.10; multipath; neighbor 10.0.0.20; neighbor 10.0.0.30; } group e1 { type external; neighbor 10.0.15.2 { local-address 10.0.15.1; peer-as 64502; } } group rr_rr { type internal; local-address 10.0.0.10; neighbor 10.0.0.40 { family inet { unicast { add-path { send { path-count 6; multipath; } } } } } } } ospf { area 0.0.0.0 { interface all; interface fxp0.0 { disable; } interface lo0.10 { passive; } interface ge-1/0/10; interface ge-1/0/13; interface ge-1/0/11; interface ge-1/0/12; } } [edit] user@RR1# show routing-options router-id 10.0.0.10; autonomous-system 64501; forwarding-table { export load-bal_199; } [edit] user@RR1# show policy-options prefix-list match_199 { 199.1.1.1/32; } policy-statement loadbal_199 { term match_100 { from { prefix-list match_199; } } from { route-filter 199.1.1.1/32 exact; } then { load-balance per-packet; } } 如果完成设备配置，请提交配置。 user@RR1# commit",
      "sections": [
        {
          "title": "CLI 快速配置",
          "level": 4,
          "content": "要快速配置此示例，请复制以下命令，将其粘贴到文本文件中，删除所有换行符，更改与您的网络配置匹配所需的任何详细信息，将命令复制并粘贴到层次结构级别的 CLI [edit] 中，然后从配置模式进入提交。 路由器 RR1 set interfaces ge-1/0/10 unit 0 description RR1->R2 set interfaces ge-1/0/10 unit 0 family inet address 10.0.12.1/24 set interfaces ge-1/0/11 unit 0 description RR1->RR4 set interfaces ge-1/0/11 unit 0 family inet address 10.0.14.1/24 set interfaces ge-1/0/12 unit 0 description RR1->R5 set interfaces ge-1/0/12 unit 0 family inet address 10.0.15.1/24 set interfaces ge-1/0/13 unit 0 description RR1->R3 set interfaces ge-1/0/13 unit 0 family inet address 10.0.13.1/24 set interfaces lo0 unit 0 family inet address 10.0.0.10/32 set protocols bgp group rr type internal set protocols bgp group rr local-address 10.0.0.10 set protocols bgp group rr cluster 10.0.0.10 set protocols bgp group rr multipath set protocols bgp group rr neighbor 10.0.0.20 set protocols bgp group rr neighbor 10.0.0.30 set protocols bgp group e1 type external set protocols bgp group e1 neighbor 10.0.15.2 local-address 10.0.15.1 set protocols bgp group e1 neighbor 10.0.15.2 peer-as 64502 set protocols bgp group rr_rr type internal set protocols bgp group rr_rr local-address 10.0.0.10 set protocols bgp group rr_rr neighbor 10.0.0.40 family inet unicast add-path send path-count 6 set protocols bgp group rr_rr neighbor 10.0.0.40 family inet unicast add-path send multipath set protocols ospf area 0.0.0.0 interface lo0.10 passive set protocols ospf area 0.0.0.0 interface ge-1/0/10 set protocols ospf area 0.0.0.0 interface ge-1/0/13 set protocols ospf area 0.0.0.0 interface ge-1/0/11 set protocols ospf area 0.0.0.0 interface ge-1/0/12 set policy-options prefix-list match_199 199.1.1.1/32 set policy-options policy-statement loadbal_199 term match_100 from prefix-list match_199 set policy-options policy-statement loadbal_199 from route-filter 199.1.1.1/32 exact set policy-options policy-statement loadbal_199 then load-balance per-packet set routing-options router-id 10.0.0.10 set routing-options autonomous-system 64501 set routing-options forwarding-table export loadbal_199 路由器 R2 set interfaces ge-1/0/10 unit 0 description R2->RR1 set interfaces ge-1/0/10 unit 0 family inet address 10.0.12.2/24 set interfaces ge-1/0/11 unit 0 description R2->R6 set interfaces ge-1/0/11 unit 0 family inet address 10.0.26.1/24 set interfaces lo0 unit 0 family inet address 10.0.0.20/32 set protocols bgp group rr local-address 10.0.0.20 set protocols bgp group rr neighbor 10.0.0.10 export set_nh_self set protocols bgp group e1 type external set protocols bgp group e1 neighbor 10.0.26.2 peer-as 64502 set protocols ospf area 0.0.0.0 interface lo0.20 passive set protocols ospf area 0.0.0.0 interface ge-1/0/10 set protocols ospf area 0.0.0.0 interface ge-1/0/11 set policy-options policy-statement set_nh_self then next-hop self set routing-options autonomous-system 64501 路由器 R3 set interfaces ge-1/0/10 unit 0 description R3->RR1 set interfaces ge-1/0/10 unit 0 family inet address 10.0.13.2/24 set interfaces ge-1/0/11 unit 0 description R3->R7 set interfaces ge-1/0/11 unit 0 family inet address 10.0.37.1/24 set interfaces lo0 unit 0 family inet address 10.0.0.30/32 set protocols bgp group rr type internal set protocols bgp group rr local-address 10.0.0.30 set protocols bgp group rr neighbor 10.0.0.10 export set_nh_self set protocols bgp group e1 type external set protocols bgp group e1 neighbor 10.0.37.2 peer-as 64502 set protocols ospf area 0.0.0.0 interface lo0.30 passive set protocols ospf area 0.0.0.0 interface ge-1/0/10 set protocols ospf area 0.0.0.0 interface ge-1/0/13 set policy-options policy-statement set_nh_self then next-hop self set routing-options autonomous-system 64501 路由器 RR4 set interfaces ge-1/0/10 unit 0 description RR4->RR1 set interfaces ge-1/0/10 unit 0 family inet address 10.0.14.2/24 set interfaces ge-1/0/11 unit 0 description RR4->R8 set interfaces ge-1/0/11 unit 0 family inet address 10.0.48.1/24 set interfaces lo0 unit 0 family inet address 10.0.0.40/32 set protocols bgp group rr type internal set protocols bgp group rr local-address 10.0.0.40 set protocols bgp group rr family inet unicast add-path receive set protocols bgp group rr neighbor 10.0.0.10 set protocols bgp group rr_client type internal set protocols bgp group rr_client local-address 10.0.0.40 set protocols bgp group rr_client cluster 10.0.0.40 set protocols bgp group rr_client neighbor 10.0.0.80 family inet unicast add-path send prefix-policy addpath-communities-send-4713-100 set protocols bgp group rr_client neighbor 10.0.0.80 family inet unicast add-path send path-count 2 set protocols bgp group rr_client neighbor 10.0.0.80 family inet unicast add-path send multipath set protocols ospf area 0.0.0.0 interface ge-1/0/10 set protocols ospf area 0.0.0.0 interface lo0.40 passive set protocols ospf area 0.0.0.0 interface ge-1/0/11 set policy-options prefix-list match_199 199.1.1.1/32 set routing-options autonomous-system 64501 路由器 R5 set interfaces ge-1/0/10 unit 0 description R5->RR1 set interfaces ge-1/0/10 unit 0 family inet address 10.0.15.2/24 set interfaces lo0 unit 0 family inet address 10.0.0.50/32 set protocols bgp group e1 type external set protocols bgp group e1 neighbor 10.0.15.1 export s2b set protocols bgp group e1 neighbor 10.0.15.1 peer-as 64501 set policy-options policy-statement s2b from protocol static set policy-options policy-statement s2b from protocol direct set policy-options policy-statement s2b then community add addpath-community set policy-options policy-statement s2b then as-path-expand 2 set policy-options policy-statement s2b then accept set policy-options community addpath-community members 4713:100 set routing-options static route 199.1.1.1/32 reject set routing-options static route 198.1.1.1/32 reject set routing-options autonomous-system 64502 路由器 R6 set interfaces ge-1/0/10 unit 0 description R6->R2 set interfaces ge-1/0/10 unit 0 family inet address 10.0.26.2/24 set interfaces lo0 unit 0 family inet address 10.0.0.60/32 set protocols bgp group e1 type external set protocols bgp group e1 neighbor 10.0.26.1 export s2b set protocols bgp group e1 neighbor 10.0.26.1 peer-as 64501 set policy-options policy-statement s2b from protocol static set policy-options policy-statement s2b from protocol direct set policy-options policy-statement s2b then community add addpath-community set policy-options policy-statement s2b then accept set policy-options community addpath-community members 4713:100 set routing-options static route 199.1.1.1/32 reject set routing-options static route 198.1.1.1/32 reject set routing-options autonomous-system 64502 路由器 R7 set interfaces ge-1/0/10 unit 0 description R7->R3 set interfaces ge-1/0/10 unit 0 family inet address 10.0.37.2/24 set interfaces lo0 unit 0 family inet address 10.0.0.70/32 set protocols bgp group e1 type external set protocols bgp group e1 neighbor 10.0.37.1 export s2b set protocols bgp group e1 neighbor 10.0.37.1 peer-as 64501 set policy-options policy-statement s2b from protocol static set policy-options policy-statement s2b from protocol direct set policy-options policy-statement s2b then community add addpath-community set policy-options policy-statement s2b then accept set policy-options community addpath-community members 4713:100 set routing-options static route 199.1.1.1/32 reject set routing-options autonomous-system 64502 路由器 R8 set interfaces ge-1/0/10 unit 0 description R8->RR4 set interfaces ge-1/0/10 unit 0 family inet address 10.0.48.2/24 set interfaces lo0 unit 0 family inet address 10.0.0.80/32 set protocols bgp group rr type internal set protocols bgp group rr local-address 10.0.0.80 set protocols bgp group rr neighbor 10.0.0.40 family inet unicast add-path receive set protocols ospf area 0.0.0.0 interface lo0.0 passive set protocols ospf area 0.0.0.0 interface ge-1/0/10.8 set routing-options autonomous-system 64501 set chassis fpc 1 pic 0 tunnel-services bandwidth 1g",
          "commands_by_device": {
            "路由器 RR1": "set interfaces ge-1/0/10 unit 0 description RR1->R2\nset interfaces ge-1/0/10 unit 0 family inet address 10.0.12.1/24\nset interfaces ge-1/0/11 unit 0 description RR1->RR4\nset interfaces ge-1/0/11 unit 0 family inet address 10.0.14.1/24\nset interfaces ge-1/0/12 unit 0 description RR1->R5\nset interfaces ge-1/0/12 unit 0 family inet address 10.0.15.1/24\nset interfaces ge-1/0/13 unit 0 description RR1->R3\nset interfaces ge-1/0/13 unit 0 family inet address 10.0.13.1/24\nset interfaces lo0 unit 0 family inet address 10.0.0.10/32\nset protocols bgp group rr type internal\nset protocols bgp group rr local-address 10.0.0.10\nset protocols bgp group rr cluster 10.0.0.10\nset protocols bgp group rr multipath\nset protocols bgp group rr neighbor 10.0.0.20\nset protocols bgp group rr neighbor 10.0.0.30\nset protocols bgp group e1 type external\nset protocols bgp group e1 neighbor 10.0.15.2 local-address 10.0.15.1\nset protocols bgp group e1 neighbor 10.0.15.2 peer-as 64502\nset protocols bgp group rr_rr type internal\nset protocols bgp group rr_rr local-address 10.0.0.10\nset protocols bgp group rr_rr neighbor 10.0.0.40 family inet unicast add-path send path-count 6\nset protocols bgp group rr_rr neighbor 10.0.0.40 family inet unicast add-path send multipath\nset protocols ospf area 0.0.0.0 interface lo0.10 passive\nset protocols ospf area 0.0.0.0 interface ge-1/0/10\nset protocols ospf area 0.0.0.0 interface ge-1/0/13\nset protocols ospf area 0.0.0.0 interface ge-1/0/11\nset protocols ospf area 0.0.0.0 interface ge-1/0/12\nset policy-options prefix-list match_199 199.1.1.1/32\nset policy-options policy-statement loadbal_199 term match_100 from prefix-list match_199\nset policy-options policy-statement loadbal_199 from route-filter 199.1.1.1/32 exact\nset policy-options policy-statement loadbal_199 then load-balance per-packet\nset routing-options router-id 10.0.0.10\nset routing-options autonomous-system 64501\nset routing-options forwarding-table export loadbal_199",
            "路由器 R2": "set interfaces ge-1/0/10 unit 0 description R2->RR1\nset interfaces ge-1/0/10 unit 0 family inet address 10.0.12.2/24\nset interfaces ge-1/0/11 unit 0 description R2->R6\nset interfaces ge-1/0/11 unit 0 family inet address 10.0.26.1/24\nset interfaces lo0 unit 0 family inet address 10.0.0.20/32\nset protocols bgp group rr local-address 10.0.0.20\nset protocols bgp group rr neighbor 10.0.0.10 export set_nh_self\nset protocols bgp group e1 type external\nset protocols bgp group e1 neighbor 10.0.26.2 peer-as 64502\nset protocols ospf area 0.0.0.0 interface lo0.20 passive\nset protocols ospf area 0.0.0.0 interface ge-1/0/10\nset protocols ospf area 0.0.0.0 interface ge-1/0/11\nset policy-options policy-statement set_nh_self then next-hop self\nset routing-options autonomous-system 64501",
            "路由器 R3": "set interfaces ge-1/0/10 unit 0 description R3->RR1\nset interfaces ge-1/0/10 unit 0 family inet address 10.0.13.2/24\nset interfaces ge-1/0/11 unit 0 description R3->R7\nset interfaces ge-1/0/11 unit 0 family inet address 10.0.37.1/24\nset interfaces lo0 unit 0 family inet address 10.0.0.30/32\nset protocols bgp group rr type internal\nset protocols bgp group rr local-address 10.0.0.30\nset protocols bgp group rr neighbor 10.0.0.10 export set_nh_self\nset protocols bgp group e1 type external\nset protocols bgp group e1 neighbor 10.0.37.2 peer-as 64502\nset protocols ospf area 0.0.0.0 interface lo0.30 passive\nset protocols ospf area 0.0.0.0 interface ge-1/0/10\nset protocols ospf area 0.0.0.0 interface ge-1/0/13\nset policy-options policy-statement set_nh_self then next-hop self\nset routing-options autonomous-system 64501",
            "路由器 RR4": "set interfaces ge-1/0/10 unit 0 description RR4->RR1\nset interfaces ge-1/0/10 unit 0 family inet address 10.0.14.2/24\nset interfaces ge-1/0/11 unit 0 description RR4->R8\nset interfaces ge-1/0/11 unit 0 family inet address 10.0.48.1/24\nset interfaces lo0 unit 0 family inet address 10.0.0.40/32\nset protocols bgp group rr type internal\nset protocols bgp group rr local-address 10.0.0.40\nset protocols bgp group rr family inet unicast add-path receive\nset protocols bgp group rr neighbor 10.0.0.10\nset protocols bgp group rr_client type internal\nset protocols bgp group rr_client local-address 10.0.0.40\nset protocols bgp group rr_client cluster 10.0.0.40\nset protocols bgp group rr_client neighbor 10.0.0.80 family inet unicast add-path send prefix-policy addpath-communities-send-4713-100\nset protocols bgp group rr_client neighbor 10.0.0.80 family inet unicast add-path send path-count 2\nset protocols bgp group rr_client neighbor 10.0.0.80 family inet unicast add-path send multipath\nset protocols ospf area 0.0.0.0 interface ge-1/0/10\nset protocols ospf area 0.0.0.0 interface lo0.40 passive\nset protocols ospf area 0.0.0.0 interface ge-1/0/11\nset policy-options prefix-list match_199 199.1.1.1/32\nset routing-options autonomous-system 64501",
            "路由器 R5": "set interfaces ge-1/0/10 unit 0 description R5->RR1\nset interfaces ge-1/0/10 unit 0 family inet address 10.0.15.2/24\nset interfaces lo0 unit 0 family inet address 10.0.0.50/32\nset protocols bgp group e1 type external\nset protocols bgp group e1 neighbor 10.0.15.1 export s2b\nset protocols bgp group e1 neighbor 10.0.15.1 peer-as 64501\nset policy-options policy-statement s2b from protocol static\nset policy-options policy-statement s2b from protocol direct\nset policy-options policy-statement s2b then community add addpath-community\nset policy-options policy-statement s2b then as-path-expand 2\nset policy-options policy-statement s2b then accept\nset policy-options community addpath-community members 4713:100\nset routing-options static route 199.1.1.1/32 reject\nset routing-options static route 198.1.1.1/32 reject\nset routing-options autonomous-system 64502",
            "路由器 R6": "set interfaces ge-1/0/10 unit 0 description R6->R2\nset interfaces ge-1/0/10 unit 0 family inet address 10.0.26.2/24\nset interfaces lo0 unit 0 family inet address 10.0.0.60/32\nset protocols bgp group e1 type external\nset protocols bgp group e1 neighbor 10.0.26.1 export s2b\nset protocols bgp group e1 neighbor 10.0.26.1 peer-as 64501\nset policy-options policy-statement s2b from protocol static\nset policy-options policy-statement s2b from protocol direct\nset policy-options policy-statement s2b then community add addpath-community\nset policy-options policy-statement s2b then accept\nset policy-options community addpath-community members 4713:100\nset routing-options static route 199.1.1.1/32 reject\nset routing-options static route 198.1.1.1/32 reject\nset routing-options autonomous-system 64502",
            "路由器 R7": "set interfaces ge-1/0/10 unit 0 description R7->R3\nset interfaces ge-1/0/10 unit 0 family inet address 10.0.37.2/24\nset interfaces lo0 unit 0 family inet address 10.0.0.70/32\nset protocols bgp group e1 type external\nset protocols bgp group e1 neighbor 10.0.37.1 export s2b\nset protocols bgp group e1 neighbor 10.0.37.1 peer-as 64501\nset policy-options policy-statement s2b from protocol static\nset policy-options policy-statement s2b from protocol direct\nset policy-options policy-statement s2b then community add addpath-community\nset policy-options policy-statement s2b then accept\nset policy-options community addpath-community members 4713:100\nset routing-options static route 199.1.1.1/32 reject\nset routing-options autonomous-system 64502",
            "路由器 R8": "set interfaces ge-1/0/10 unit 0 description R8->RR4\nset interfaces ge-1/0/10 unit 0 family inet address 10.0.48.2/24\nset interfaces lo0 unit 0 family inet address 10.0.0.80/32\nset protocols bgp group rr type internal\nset protocols bgp group rr local-address 10.0.0.80\nset protocols bgp group rr neighbor 10.0.0.40 family inet unicast add-path receive\nset protocols ospf area 0.0.0.0 interface lo0.0 passive\nset protocols ospf area 0.0.0.0 interface ge-1/0/10.8\nset routing-options autonomous-system 64501\nset chassis fpc 1 pic 0 tunnel-services bandwidth 1g"
          }
        },
        {
          "title": "配置路由器 RR1",
          "level": 4,
          "content": "以下示例要求您在配置层次结构中导航各个级别。有关导航 CLI 的信息，请参阅 CLI 用户指南中的在配置模式下使用 CLI 编辑器。 要配置路由器 RR1： 注： 修改相应的接口名称、地址和其他参数后，对其他路由器重复此过程。 修改相应的接口名称、地址和其他参数后，对其他路由器重复此过程。 使用 IPv4 地址配置接口。 [edit interfaces] user@RR1# set ge-1/0/10 unit 0 description RR1->R2 user@RR1# set ge-1/0/10 unit 0 family inet address 10.0.12.1/24 user@RR1# set ge-1/0/11 unit 0 description RR1->RR4 user@RR1# set ge-1/0/11 unit 0 family inet address 10.0.14.1/24 user@RR1# set ge-1/0/12 unit 0 description RR1->R5 user@RR1# set ge-1/0/12 unit 0 family inet address 10.0.15.1/24 user@RR1# set ge-1/0/13 unit 0 description RR1->R3 user@RR1# set ge-1/0/13 unit 0 family inet address 10.0.13.1/24 配置环路地址。 [edit interfaces] user@RR1# set lo0 unit 0 family inet address 10.0.0.10/32 配置内部网关协议 （IGP），例如 OSPF 或 IS-IS。 [edit protocols] user@RR1# set ospf area 0.0.0.0 interface lo0.10 passive user@RR1# set ospf area 0.0.0.0 interface ge-1/0/10 user@RR1# set ospf area 0.0.0.0 interface ge-1/0/13 user@RR1# set ospf area 0.0.0.0 interface ge-1/0/11 user@RR1# set ospf area 0.0.0.0 interface ge-1/0/12 为连接到内部路由器 R2 和 R3 的接口配置内部组 rr。 [edit protocols] user@RR1# set bgp group rr type internal user@RR1# set bgp group rr local-address 10.0.0.10 user@RR1# set bgp group rr cluster 10.0.0.10 user@RR1# set bgp group rr neighbor 10.0.0.20 user@RR1# set bgp group rr neighbor 10.0.0.30 为内部 BGP 组 rr 配置负载平衡。 [edit protocols] user@RR1# set bgp group rr multipath 为路由反射器配置内部组rr_rr。 [edit protocols] user@RR1# set bgp group rr_rr type internal user@RR1# set bgp group rr_rr local-address 10.0.0.10 将添加路径多路径功能配置为仅播发参与者多个路径，并将播发的多路径数限制为 6。 [edit protocols] user@RR1# set bgp group rr_rr neighbor 10.0.0.40 family inet unicast add-path send multipath user@RR1# set bgp group rr_rr neighbor 10.0.0.40 family inet unicast add-path send path-count 6 在连接到外部边缘路由器的接口上配置 EBGP。 [edit protocols] user@RR1# set bgp group e1 type external user@RR1# set bgp group e1 neighbor 10.0.15.2 local-address 10.0.15.1 user@RR1# set bgp group e1 neighbor 10.0.15.2 peer-as 64502 为每个数据包负载平衡定义策略loadbal_199。 [edit policy-options] user@RR1# set prefix-list match_199 199.1.1.1/32 user@RR1# set policy-statement loadbal_199 term match_100 from prefix-list match_199 user@RR1# set policy-statement loadbal_199 from route-filter 199.1.1.1/32 exact user@RR1# set policy-statement loadbal_199 then load-balance per-packet loadbal_199应用定义的导出策略。 [edit routing-options] user@RR1# set forwarding-table export loadbal_199 为 BGP 主机配置路由器 ID 和自治系统。 [edit routing-options] user@RR1# set router-id 10.0.0.10 user@RR1# set autonomous-system 64501",
          "sections": [
            {
              "title": "分步过程",
              "level": 5,
              "step_by_step": [
                {
                  "step": 1,
                  "description": "使用 IPv4 地址配置接口。",
                  "code": [
                    "[edit interfaces]",
                    "user@RR1# set ge-1/0/10 unit 0 description RR1->R2 ",
                    "user@RR1# set ge-1/0/10 unit 0 family inet address 10.0.12.1/24",
                    "user@RR1# set ge-1/0/11 unit 0 description RR1->RR4 ",
                    "user@RR1# set ge-1/0/11 unit 0 family inet address 10.0.14.1/24",
                    "user@RR1# set ge-1/0/12 unit 0 description RR1->R5 ",
                    "user@RR1# set ge-1/0/12 unit 0 family inet address 10.0.15.1/24",
                    "user@RR1# set ge-1/0/13 unit 0 description RR1->R3 ",
                    "user@RR1# set ge-1/0/13 unit 0 family inet address 10.0.13.1/24"
                  ]
                },
                {
                  "step": 2,
                  "description": "配置环路地址。",
                  "code": [
                    "[edit interfaces]",
                    "user@RR1# set lo0 unit 0 family inet address 10.0.0.10/32"
                  ]
                },
                {
                  "step": 3,
                  "description": "配置内部网关协议 （IGP），例如 OSPF 或 IS-IS。",
                  "code": [
                    "[edit protocols]",
                    "user@RR1# set ospf area 0.0.0.0 interface lo0.10 passive",
                    "user@RR1# set ospf area 0.0.0.0 interface ge-1/0/10",
                    "user@RR1# set ospf area 0.0.0.0 interface ge-1/0/13",
                    "user@RR1# set ospf area 0.0.0.0 interface ge-1/0/11",
                    "user@RR1# set ospf area 0.0.0.0 interface ge-1/0/12"
                  ]
                },
                {
                  "step": 4,
                  "description": "为连接到内部路由器 R2 和 R3 的接口配置内部组 rr。",
                  "code": [
                    "[edit protocols]",
                    "user@RR1# set bgp group rr type internal",
                    "user@RR1# set bgp group rr local-address 10.0.0.10",
                    "user@RR1# set bgp group rr cluster 10.0.0.10",
                    "user@RR1# set bgp group rr neighbor 10.0.0.20",
                    "user@RR1# set bgp group rr neighbor 10.0.0.30"
                  ]
                },
                {
                  "step": 5,
                  "description": "为内部 BGP 组 rr 配置负载平衡。",
                  "code": [
                    "[edit protocols]",
                    "user@RR1# set bgp group rr multipath"
                  ]
                },
                {
                  "step": 6,
                  "description": "为路由反射器配置内部组rr_rr。",
                  "code": [
                    "[edit protocols]",
                    "user@RR1# set bgp group rr_rr type internal",
                    "user@RR1# set bgp group rr_rr local-address 10.0.0.10"
                  ]
                },
                {
                  "step": 7,
                  "description": "将添加路径多路径功能配置为仅播发参与者多个路径，并将播发的多路径数限制为 6。",
                  "code": [
                    "[edit protocols]",
                    "user@RR1# set bgp group rr_rr neighbor 10.0.0.40 family inet unicast add-path send multipath",
                    "user@RR1# set bgp group rr_rr neighbor 10.0.0.40 family inet unicast add-path send path-count 6"
                  ]
                },
                {
                  "step": 8,
                  "description": "在连接到外部边缘路由器的接口上配置 EBGP。",
                  "code": [
                    "[edit protocols]",
                    "user@RR1# set bgp group e1 type external",
                    "user@RR1# set bgp group e1 neighbor 10.0.15.2 local-address 10.0.15.1",
                    "user@RR1# set bgp group e1 neighbor 10.0.15.2 peer-as 64502"
                  ]
                },
                {
                  "step": 9,
                  "description": "为每个数据包负载平衡定义策略loadbal_199。",
                  "code": [
                    "[edit policy-options]",
                    "user@RR1# set prefix-list match_199 199.1.1.1/32",
                    "user@RR1# set policy-statement loadbal_199 term match_100 from prefix-list match_199",
                    "user@RR1# set policy-statement loadbal_199 from route-filter 199.1.1.1/32 exact",
                    "user@RR1# set policy-statement loadbal_199 then load-balance per-packet"
                  ]
                },
                {
                  "step": 10,
                  "description": "loadbal_199应用定义的导出策略。",
                  "code": [
                    "[edit routing-options]",
                    "user@RR1# set forwarding-table export loadbal_199"
                  ]
                },
                {
                  "step": 11,
                  "description": "为 BGP 主机配置路由器 ID 和自治系统。",
                  "code": [
                    "[edit routing-options]",
                    "user@RR1# set router-id 10.0.0.10",
                    "user@RR1# set autonomous-system 64501"
                  ]
                }
              ]
            }
          ]
        },
        {
          "title": "结果",
          "level": 4,
          "content": "在配置模式下，输入 show interfaces 、 show protocols 、 show routing-options 和 show policy-options 命令，以确认您的配置。如果输出未显示预期的配置，请重复此示例中的说明，以便进行更正。 如果完成设备配置，请提交配置。",
          "code": [
            "[edit] \nuser@RR1#show interfacesge-1/0/10 {\n    unit 0 {\n        description RR1->R2;\n        family inet {\n            address 10.0.12.1/24;\n        }\n    }\n}\nge-1/0/11 {\n    unit 0 {\n        description RR1->RR4;\n        family inet {\n            address 10.0.14.1/24;\n        }\n    }\n}\nge-1/0/12 {\n    unit 0 {\n        description RR1->R5;\n        family inet {\n            address 10.0.15.1/24;\n        }\n    }\n}\nge-1/0/13 {\n    unit 0 {\n        description RR1->R3;\n        family inet {\n            address 10.0.13.1/24;\n        }\n    }\n}\nlo0 {\n    unit 0 {\n        family inet {\n            address 10.0.0.10/32;\n        }\n    }\n}",
            "[edit] \nuser@RR1#show protocolsbgp {\n    group rr {\n        type internal;\n        local-address 10.0.0.10;\n        cluster 10.0.0.10;\n        multipath;\n        neighbor 10.0.0.20;\n        neighbor 10.0.0.30;\n    }\n    group e1 {\n        type external;\n        neighbor 10.0.15.2 {\n            local-address 10.0.15.1;\n            peer-as 64502;\n        }\n    }\n    group rr_rr {\n        type internal;\n        local-address 10.0.0.10;\n        neighbor 10.0.0.40 {\n            family inet {\n                unicast {\n                    add-path {\n                        send {\n                            path-count 6;\n                            multipath;\n                        }\n                    }\n                }\n            }\n        }\n    }\n}\nospf {\n    area 0.0.0.0 {\n        interface all;\n        interface fxp0.0 {\n            disable;\n        }\n        interface lo0.10 {\n            passive;\n        }\n        interface ge-1/0/10;\n        interface ge-1/0/13;\n        interface ge-1/0/11;\n        interface ge-1/0/12;\n    }\n}",
            "[edit] \nuser@RR1#show routing-optionsrouter-id 10.0.0.10;\nautonomous-system 64501;\nforwarding-table {\n    export load-bal_199;\n}",
            "[edit] \nuser@RR1#show policy-optionsprefix-list match_199 {\n    199.1.1.1/32;\n}\npolicy-statement loadbal_199 {\n    term match_100 {\n        from {\n            prefix-list match_199;\n        }\n    }\n    from {\n        route-filter 199.1.1.1/32 exact;\n    }\n    then {\n        load-balance per-packet;\n    }\n}",
            "user@RR1#commit"
          ]
        }
      ]
    }
  ],
  "content": "此示例说明如何配置 BGP 多路径的选择性播发。播发所有可用的多路径可能会导致设备内存上的大量处理开销，这也是一个扩展注意事项。可以将 BGP 路由反射器配置为仅播发参与者多路径以实现负载平衡。 要求 配置此示例之前，不需要除设备初始化之外的特殊配置"
}