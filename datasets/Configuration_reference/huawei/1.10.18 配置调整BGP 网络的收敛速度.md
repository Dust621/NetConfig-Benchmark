```markdown
# 1.10.18 配置调整BGP网络的收敛速度

通过调整BGP对等体间的连接参数，可以对BGP网络的收敛速度进行调整和优化，从而适应大型网络中网络状况不断变化的情况。

## 应用环境

BGP用于大型网络中传递路由。但是大型网络中网络状况变化频繁，这会影响到BGP邻居关系的建立和维持，进而会影响到BGP网络的收敛速度。

BGP协议自身的增量更新和路由衰减能够在一定程度上抑制路由频繁变化的情况，但是不能从本质上减弱网络震荡对BGP网络连接的影响。

通过配置BGP定时器和去使能EBGP连接快速复位可以抑制BGP网络震荡，提高BGP网络的收敛速度。

### BGP存活定时器和保持定时器

BGP的Keepalive消息用于维护BGP邻居关系，并且检测连接的有效性。当对等体间建立了BGP连接后，它们根据存活定时器定时向对端发送Keepalive消息，以防止路由器认为BGP连接已中断。若路由器在保持定时器设定的连接保持时间（Hold time）内未收到对端的Keepalive消息或任何其它类型的报文，则认为此BGP连接已中断，从而退出此BGP连接。

### BGP更新报文定时器

BGP协议不会定期更新路由表，当BGP路由发生变化时，才会通过Update消息增量地更新路由表。但如果同一路由频繁变化时，为避免每次变化路由器都要发送Update消息给对等体，可以配置发送该同一路由的Update消息的时间间隔。

### 使能EBGP邻居快速复位

EBGP连接快速复位功能，缺省情况下是使能的，目的是为了使EBGP快速感知EBGP连接所使用的接口的状态。但是在有些场合，接口的状态变化频繁，这时可以去使能EBGP连接快速复位功能，EBGP直连会话不会随着接口不断Up和Down而重建与删除，便于网络快速收敛。

### BGP连接重传定时器

BGP发起TCP连接后，如果成功建立起TCP连接，则关闭连接重传定时器。如果TCP连接建立不成功，则会在连接重传定时器超时后重新尝试建立连接。设置较小的连接重传定时器，可以减少等待下次连接建立的时间，加快连接失败后重新建立的速度；设置较大的连接重传定时器，可以减小由于邻居反复震荡引起的路由震荡。

通过使能慢对等体检测功能，可以将严重影响发送路由更新速度的对等体从打包组中切出，提高BGP网络的收敛速度。

## 前置任务

在配置BGP对等体间连接参数之前，需完成以下任务：

- 配置BGP的基本功能

### 1.10.18.1 配置BGP存活时间和保持时间定时器

BGP存活时间定时器和保持时间定时器的大小决定了BGP感知网络故障的速度，按照实际网络状况调整定时器的值可以增强网络性能。

#### 背景信息

BGP的Keepalive消息用于维持BGP连接关系。一对BGP对等体之间依靠互相发送Keepalive消息来告诉邻居自己的状态，如果BGP在保持时间定时器超时后，仍旧未收到邻居发来的Keepalive消息，则会认为连接已经中断。

- 减小存活时间和保持时间，BGP可以更快速的检测到链路的故障，有利于BGP网络快速收敛，但是网络中的Keepalive消息会增多，会增加路由器的负担，并且会占用一定的网络带宽。
- 增大存活时间和保持时间，网络中的Keepalive消息减少，这样会减少路由器的负担和网络带宽的占用，但是过长的保持时间使得BGP不能及时检测到链路状态的变化，不利于BGP网络快速收敛，可能会造成较多的流量损失。

**须知**：改变定时器的值（执行`timer`或`peer timer`命令）会导致路由器之间的BGP Peer关系中断。务必仔细确认是否必须改变定时器的值。

BGP支持在全局或者单个对等体（组）配置存活时间和保持时间定时器。定时器生效的优先级单个对等体高于对等体组，对等体组高于全局。

#### 操作步骤

- **配置全局定时器**

  1. 执行命令`system-view`，进入系统视图。
  2. 执行命令`bgp as-number`，进入BGP视图。
  3. 执行命令`timer keepalive keepalive-time hold hold-time [ min-holdtime min-hold-value ]`配置BGP的存活时间和保持时间，或执行命令`timer send-hold send-hold-time`配置本端设备不发生主动断连的保持时间。

  合理的最大Keepalive消息发送间隔为保持时间的三分之一，且该发送间隔不能小于1秒，因此，保持时间如果不为0，则最小为3秒。

  **说明**：建议配置的保持时间`hold-time`与BGP各地址族邻居总数有关，随着对等体数量增多，建议配置的最小保持时间也相应增多，用户可以根据表1-22调整保持时间。

  **表1-22 BGP各地址族邻居总数量和建议配置的最小保持时间对应关系表**

  | 对等体总数量 | 建议配置的最小保持时间 |
  |--------------|------------------------|
  | 0~20         | 秒                     |
  | 101~30       | 秒                     |
  | 201~45       | 秒                     |
  | 301~60       | 秒                     |
  | 401~75       | 秒                     |
  | 501 以及上   | 90秒                   |

  以下三种定时器取值配置需要尽量避免：

  - `keepalive-time`值和`hold-time`值同时取0，这种配置将导致BGP定时器无效，即BGP不会发送Keepalive消息。
  - `hold-time`值远大于`keepalive-time`值，例如，不能将`keepalive-time`值设置为1而将`hold-time`值设置为65535。因为如果保持时间过长，BGP将不能及时检测到连接的有效性。
  - `keepalive-time`值取0，则`keepalive-time`不启动，`send-hold-time`功能不生效。

  当对等体建立连接之后，实际的`keepalive-time`值和`hold-time`值是通过双方协商来确定的。其中，取对等体双方的Open报文中的`hold-time`的较小值为最终的`hold-time`值；取（协商的`hold-time`值÷3）和本地配置的`keepalive-time`值中较小的作为最终的`keepalive-time`值。

  4. 执行命令`commit`，提交配置。

- **配置对等体的定时器**

  1. 执行命令`system-view`，进入系统视图。
  2. 执行命令`bgp as-number`，进入BGP视图。
  3. 执行命令`peer { ipv4-address | group-name } timer keepalive keepalive-time hold hold-time [ min-holdtime min-hold-value ]`配置对等体或对等体组的`keepalive`发送间隔和保持时间，或执行命令`peer ipv4-address timersend-hold send-hold-time`，配置本端设备不发生主动断连的保持时间。

  存活时间和保持时间的取值关系同配置全局定时器。

  **说明**：建议配置的保持时间`hold-time`与BGP各地址族邻居总数有关，随着对等体数量增多，建议配置的最小保持时间也相应增多，用户可以根据表1-23调整保持时间。

  **表1-23 BGP各地址族邻居总数量和建议配置的最小保持时间对应关系表**

  | 对等体总数量 | 建议配置的最小保持时间 |
  |--------------|------------------------|
  | 0~20         | 秒                     |
  | 101~30       | 秒                     |
  | 201~45       | 秒                     |
  | 301~60       | 秒                     |
  | 401~75       | 秒                     |
  | 501 以及上   | 90秒                   |

  4. 执行命令`commit`，提交配置。

### 1.10.18.2 配置更新报文定时器

设置合理的更新报文定时器，可以抑制路由频繁变化对BGP的影响，有利于BGP网络稳定。

#### 背景信息

BGP的Update消息用于在对等体之间交换路由信息。Update消息可以发布多条属性相同的可达路由信息，也可以撤销多条不可达路由信息。

BGP协议不会定期更新路由表，当BGP路由发生变化时，才会通过Update消息增量地更新路由表。但如果同一路由频繁变化时，为避免每次变化路由器都要发送Update消息给对等体，可以配置更新报文定时器。

#### 操作步骤

1. 执行命令`system-view`，进入系统视图。
2. 执行命令`bgp as-number`，进入BGP视图。
3. 执行命令`peer { ipv4-address | group-name } route-update-interval interval`，配置更新报文定时器。

  `ipv4-address`和`group-name`参数分别表示对单个对等体和对等体组进行配置。更新报文定时器生效的优先级关系是个体优先，即单个对等体优先于对等体组。

4. 执行命令`commit`，提交配置。

### 1.10.18.3 去使能EBGP连接快速复位

通过去使能EBGP连接快速复位功能，可以防止路由震荡带来的EBGP会话的反复重建与删除，有利于BGP网络快速收敛。

#### 背景信息

EBGP连接快速复位功能缺省情况下是使能的，目的是为了使BGP协议不必等待保持时间定时器超时，而立即快速响应接口故障，删除接口上的EBGP直连会话，便于BGP快速收敛。

**说明**：EBGP连接快速复位功能只能快速响应接口故障，而不能快速响应接口故障恢复。接口故障恢复后，BGP协议依靠自身状态机机制来恢复会话。

但是如果EBGP连接所使用的接口状态反复变化，EBGP会话就会反复重建与删除，造成网络震荡。这时，可以去使能EBGP连接快速复位功能，BGP协议会等待保持时间定时器超时，才会删除接口上的EBGP直连会话，这样就在一定程度上抑制了BGP网络震荡，有利于BGP网络快速收敛。同时，在一定程度上节约了网络带宽。

#### 操作步骤

1. 执行命令`system-view`，进入系统视图。
2. 执行命令`bgp as-number`，进入BGP视图。
3. 执行命令`undo ebgp-interface-sensitive`，去使能EBGP连接快速复位。

  **说明**：该命令适用于EBGP连接所使用的接口状态不断变化的场合。如果接口状态恢复稳定，建议立即执行`ebgp-interface-sensitive`命令恢复缺省配置，也即，使能EBGP连接快速复位功能。

4. 执行命令`commit`，提交配置。

### 1.10.18.4 配置BGP连接重传定时器

通过改变BGP连接重传定时器值的大小可以加快或者减缓BGP邻居建立的速度。

#### 背景信息

BGP发起TCP连接后，如果成功建立起TCP连接，则关闭连接重传定时器。如果TCP连接建立不成功，则会在连接重传定时器超时后重新尝试建立连接。

- 设置较小的连接重传定时器，可以减少等待下次连接建立的时间，加快连接失败后重新建立的速度。
- 设置较大的连接重传定时器，可以减小由于邻居反复震荡引起的路由震荡。

BGP支持在全局或者单个对等体（组）配置连接重传定时器。定时器生效的优先级是单个对等体高于对等体组，对等体组高于全局。

#### 操作步骤

- **配置全局连接重传定时器**

  请在运行BGP协议的路由器上进行下列配置。

  1. 执行命令`system-view`，进入系统视图。
  2. 执行命令`bgp as-number`，进入BGP视图。
  3. 执行命令`timer connect-retry connect-retry-time`，配置BGP全局连接重传定时器。
  4. 执行命令`commit`，提交配置。

- **配置对等体或对等体组的连接重传定时器**

  请在运行BGP协议的路由器上进行下列配置。

  1. 执行命令`system-view`，进入系统视图。
  2. 执行命令`bgp as-number`，进入BGP视图。
  3. 执行命令`peer { group-name | ipv4-address } timer connect-retry connect-retry-time`，配置对等体或对等体组的连接重传定时器。
  4. 执行命令`commit`，提交配置。

### 1.10.18.5 使能慢对等体检测功能

通过使能慢对等体检测功能，可以将严重影响发送路由更新速度的对等体从打包组中切出，提高BGP网络的收敛速度。

#### 背景信息

一个打包组里可能包含有多个对等体。如果出现由于网络拥塞等原因而使本端设备向其中一个对等体发布路由的速度很慢的情况，则会影响本端设备向这个打包组中的其他对等体发布路由速度。为了不影响打包组内其他对等体发布路由，默认使能慢对等体检测功能。

在使能慢对等体检测功能后，本地设备将计算某个对等体发送报文所消耗的时间与最快的对等体发送报文所消耗时间的差值，如果此差值大于使能慢对等体检测功能时设置的阈值，则该对等体将被认定为慢对等体，并把这个对等体切出打包组，以免影响向其他对等体发送路由更新的速度。

如果BGP更新报文发布失败时，慢对等体的报文也会发布失败，此时无法通过原有慢对等体检测方式检测出慢对等体。为了解决这个问题，可以使用绝对时间检测方式来检测慢对等体，当对等体发送报文的延迟时间大于设置的绝对时间检测阈值时，即判定该对等体为慢对等体。

一个慢对等体打包组里可能包含多个慢对等体，同样如果出现由于网络拥塞等原因而使本端设备向其中一个慢对等体发布路由的速度很慢的情况，会影响本端设备向这个慢对等体打包组中的其他对等体发布路由速度。为了避免该问题，可以使能慢对等体分级切换功能，即允许慢对等体打包组内最慢的慢对等体自动切换到一个新的慢对等体打包组，且该慢对等体打包组中只存在这个慢对等体自身。

在使能慢对等体分级切换功能后，本端设备将依次计算慢对等体打包组内某个慢对等体发送报文所消耗的时间，如果该值大于等于慢对等体分级功能设置的慢对等体打包组内更慢对等体绝对检测时间阈值，则认为该慢对等体是慢对等体打包组内的更慢对等体，如果同时其他慢对等体已经完成报文发送，则将该慢对等体切出慢对等体打包组，并使其自己在一个新的慢对等体打包组，以免影响组内其他慢对等体发送路由的速度。例如本端设备慢对等体打包组中有A、B、C三个慢对等体，设置的慢对等体打包组内更慢对等体绝对检测时间阈值是300s，本端设备会依次计算A、B、C三个慢对等体发送报文的时间，如果A慢对等体发送报文的时间是400s，且此时慢对等体B、C已经发包完成，则把慢对等体A切出该慢对等体组，使其单独在一个新的慢对等体打包组中；如果慢对等体B、C还没有完成发包，则慢对等体A不切出该慢对等体打包组，继续检测慢对等体B或C的发包时间，重复A的比较原则即可。

#### 操作步骤

1. 执行命令`system-view`，进入系统视图。
2. 执行命令`bgp as-number`，进入BGP视图。
3. 执行命令`slow-peer detection threshold threshold-value`，配置慢对等体检测阈值。

  `threshold threshold-value`参数用来设置检测慢对等体的阈值。本地设备将计算某个对等体发送报文所消耗的时间与最快的对等体发送报文所消耗时间的差值，如果此差值大于`threshold-value`参数设置的阈值时，该对等体将被认定为慢对等体并被切出打包组。

4. （可选）执行命令`slow-peer absolute-detection threshold absolute-threshold-value`，使能慢对等体绝对时间检测功能。
5. （可选）配置慢对等体分级切换功能。

  1. 执行命令`slow-peer single-group { enable | disable | auto-process }`，使能慢对等体分级切换功能。

    不管是否使能慢对等体分级切换功能，设备都会默认自动检测慢对等体打包组中是否存在更慢对等体，如果慢对等体分级切换功能没有生效，那么检测到有更慢对等体，会记录`SLOW_PEER_SINGLEGROUP`日志。

  2. 执行命令`slow-peer single-group number number-value`，配置慢对等体自动切换到单对等体单组的数量上限。
  3. 执行命令`slow-peer single-group detection threshold threshold-value`，配置慢对等体打包组内更慢对等体绝对检测时间阈值。

    `threshold threshold-value`参数用来设置慢对等体打包组内更慢对等体绝对检测时间阈值。在使能慢对等体分级切换功能后，本端设备将依次计算慢对等体打包组内某个慢对等体发送报文所消耗的时间，如果该值大于等于慢对等体分级功能设置的慢对等体打包组内更慢对等体绝对检测时间阈值，则认为该慢对等体是慢对等体打包组内的更慢对等体，如果同时其他慢对等体已经完成报文发送，则将该慢对等体切出慢对等体打包组，并使其自己在一个新的慢对等体打包组。

6. 执行命令`commit`，提交配置。

### 1.10.18.6 检查配置结果

调整BGP网络收敛速度配置成功后，可以查看BGP对等体和对等体组信息。

#### 前提条件

已经完成调整BGP网络收敛速度的所有配置。

#### 操作步骤

- 使用`display bgp peer [ verbose ]`命令查看BGP对等体信息。
- 使用`display bgp group [ group-name ]`命令查看BGP对等体组信息。
- 使用`display bgp slow-peer`命令查看BGP慢对等体的相关信息。
```