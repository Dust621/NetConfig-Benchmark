```markdown
# 1.13.2 XPL 配置注意事项

## 特性限制

表1-72 本特性的使用限制

### 特性限制系列涉及产品

- NE40E
- NE40E-X16A
- NE40E-X16C
- NE40E-X8A
- NE40E-X3A
- NE40E-X8C
- NetEngine 40E-X8AK

### 使用限制

- 如果需要用行编辑方式修改已经存在的全局变量集合、路由属性集合或过滤策略，需要进入相应命令视图进行重新配置。否则新配置的匹配和应用规则会覆盖历史的匹配和应用规则。
- 如果需要保留历史匹配和应用规则，需要重新配置历史及新增历史匹配和应用规则。

### 行编辑模式

- 再次进入为覆盖式操作，新编辑的内容会覆盖以前的内容。
- 使用行编辑模式时，需要一次将策略内容整体编辑完成。

## 1.13.3 XPL 段编辑简介

XPL段编辑方式是XPL在配置方式上的一个新的尝试，段编辑方式与行编辑方式的比较请参见1.13.1 XPL概述。下面主要通过常用快捷键、段编辑操作示例、段编辑方式中集合和过滤策略的配置步骤对段编辑进行介绍。

### 段编辑界面

段编辑的界面相当于一个文本编辑器，用户在文本编辑器中通过XPL语句对集合和策略进行配置或修改，阶段性配置完成后统一提交配置。

### 常用快捷键

段编辑界面中可使用快捷键进行常用的操作，常用快捷键及其功能如表3所示。

表1-73 段编辑界面中常用快捷键的介绍

| 快捷键 | 功能 |
| --- | --- |
| `i` | 进入文本编辑模式，只有在文本编辑模式下才可以对集合或策略进行配置。该快捷键为键盘上的`i`键。 |
| `Esc` | 退出文本编辑模式。该快捷键为键盘左上角的`Esc`键。 |
| `:q!` | 不保存配置并退出段编辑视图。该快捷键需要在单击`Esc`键，退出文本编辑模式后手动键入。 |
| `:wq` | 保存配置并退出段编辑视图。该快捷键需要在单击`Esc`键，退出文本编辑模式后手动键入。 |

**说明**：需单击回车键后此快捷键才会生效。

### 进入段编辑视图

可通过以下任意命令进入XPL段编辑视图：

- 执行 `edit xpl global-value` 命令进入全局变量集合段编辑视图。
- 执行 `edit xpl ip-prefix-list ip-prefix-list-name` 命令进入IPv4地址前缀集合段编辑视图。
- 执行 `edit xpl ipv6-prefix-list ipv6-prefix-list-name` 命令进入IPv6地址前缀集合段编辑视图。
- 执行 `edit xpl as-path-list as-path-list-name` 命令进入AS_Path集合段编辑视图。
- 执行 `edit xpl community-list community-list-name` 命令进入团体属性集合段编辑视图。
- 执行 `edit xpl large-community-list large-community-list-name` 命令进入Large-community属性集合段编辑视图。
- 执行 `edit xpl route-filter route-filter-name` 命令进入过滤策略段编辑视图。

### 段编辑操作示例

表1-74 段编辑操作说明

| 序号 | 操作说明 |
| --- | --- |
| 1 | 进入段编辑视图并进入文本编辑模式。例如，用户视图下执行 `edit xpl ip-prefix-list ip-prefix-list-name` 命令进入IPv4地址前缀集合段编辑视图，并单击快捷键 `i` 键，进入文本编辑模式，此时界面底部出现“-- INSERT --”标识，代表此时可以输入内容。如果未单击快捷键 `i` 键，则无法输入内容。 |
| 2 | 配置XPL集合和过滤策略。在文本编辑模式下，配置IPv4地址前缀集合的起始语句 `xpl ip-prefix-list ip-prefix-list-name`、集合元素、结束语句 `end-list`，并单击快捷键 `Esc` 键退出文本编辑模式。单击 `Esc` 键后，界面底部的“-- INSERT --”标识会消失，此时无法继续输入内容。如需要继续修改，重新单击快捷键 `i` 键回到文本编辑模式即可。请注意，集合元素之间需要用“,”隔开，否则会报错。 |
| 3 | 保存配置并退出段编辑视图。配置完成并单击快捷键 `Esc` 键后，界面底部的“-- INSERT --”标识消失，代表已退出文本编辑模式，此时可键入 `:wq` 后回车，保存配置并退出段编辑视图。也可以键入 `:q!` 后回车，不保存配置并退出段编辑视图。 |
| 4 | 出现错误配置，无法保存。存在错误配置时，无法提交保存，此时可根据报错信息进行修改，修改完成后重新提交配置。 |
| 5 | 修改配置。如果希望修改现有配置，同样可以通过执行 `edit xpl ip-prefix-list ip-prefix-list-name` 命令进入IPv4地址前缀集合段编辑视图，并键入快捷键 `i`，进入文本编辑模式。此时可单击方向键调整光标到需要的位置后，删除或新增集合元素，注意元素之间用“,”隔开。修改完成后单击快捷键 `Esc` 键退出文本编辑模式，再键入 `:wq` 后回车，保存配置并退出段编辑视图即可。 |

### 段编辑方式中集合和过滤策略的配置步骤

集合和过滤策略的配置步骤为：

#### 全局变量集合

1. 配置全局变量集合的起始语句：`xpl global-value`；
2. 在全局变量集合视图下，配置集合元素，集合元素为变量名+具体数值，取值范围如下：
   - 变量名的取值范围是字符串形式，取值范围是1～200，不支持空格和问号，区分大小写，以字母、数字或者冒号（`:`）开头，由字母、数字、下划线（`_`）、中横线（`-`）、点（`.`）、冒号（`:`）组成。变量名不能以关键字 `abort`、`display` 和 `end-global-value` 及其缩写命名，如 `a`、`ab`、`abo`、`di`、`e`、`end` 等。
   - 具体数值两端加单引号，如 `aaa '12'`、`bbb '34'`、`aaa '1.2.3.4'`，元素之间用“,”隔开。
3. 配置全局变量集合的结束语句：`end-global-value`。

#### IPv4地址前缀集合

1. 配置IPv4地址前缀集合的起始语句：`xpl ip-prefix-list ip-prefix-list-name`；
2. 配置集合元素，集合元素为带掩码长度的IPv4地址，如 `1.1.1.0 24`，元素之间用“,”隔开。掩码长度可以与 `eq`、`ge`、`le` 配合使用，如 `1.1.1.0 24 ge 26 le 30` 代表 `1.1.1.0/24` 网段内掩码长度在26和30之间的路由。
3. 配置IPv4地址前缀集合的结束语句：`end-list`。

#### IPv6地址前缀集合

1. 配置IPv6地址前缀集合的起始语句：`xpl ipv6-prefix-list ipv6-prefix-list-name`；
2. 配置集合元素，集合元素为带掩码长度的IPv6地址，如 `2001:db8:0:1:: 64`，元素之间用“,”隔开。掩码长度可以与 `eq`、`ge`、`le` 配合使用，如 `2001:db8:0:1:: 64 ge 96 le 100` 代表 `2001:db8:0:1::/64` 网段内掩码长度在96和100之间的路由。
3. 配置IPv6地址前缀集合的结束语句：`end-list`。

#### AS_Path集合

1. 配置AS_Path集合的起始语句：`xpl as-path-list as-path-list-name`；
2. 配置集合元素，集合元素可为以下几种形式，元素之间用“,”隔开：
   - `length { eq | ge | le } as-length`：AS_Path长度等于（`eq`）、大于等于（`ge`）或小于等于（`le`）`as-length` 的BGP路由，`as-length` 为整数形式，取值为0～2047；
   - `unique-length { eq | ge | le } as-length`：去除重复AS号的AS_Path长度等于（`eq`）、大于等于（`ge`）或小于等于（`le`）`as-length` 的BGP路由，`as-length` 为整数形式，取值为0～2047；
   - `origin as-path [ whole-match ]`：AS_Path起始部分为指定AS组合的BGP路由，即AS_Path尾部为指定AS_Path列表的BGP路由。`as-path`：AS_Path列表，两端加单引号，AS号中间用空格分隔，如配置 `whole-match` 则表示不能去除重复AS号，否则会去除重复AS号予以匹配；
   - `peer-is as-path [ whole-match ]`：AS_Path结束部分为指定AS组合的BGP路由，即AS_Path头部为指定AS_Path列表的BGP路由。`as-path`：AS_Path列表，两端加单引号，AS号中间用空格分隔，如配置 `whole-match` 则表示不能去除重复AS号，否则会去除重复AS号予以匹配；
   - `pass as-path [ whole-match ]`：AS_Path经过指定AS组合的BGP路由，即AS_Path从头部开始匹配，有部分连续AS号可以匹配AS_Path列表的BGP路由。`as-path`：AS_Path列表，两端加单引号，AS号中间用空格分隔，如配置 `whole-match` 则表示不能去除重复AS号，否则会去除重复AS号予以匹配；
   - `regular regular-expression`：AS_Path符合指定正则表达式的BGP路由，`regular-expression` 为正则表达式。

**说明**：正则表达式匹配是CPU运算密集型处理。当XPL策略中配置了大量的正则表达式对BGP路由属性进行匹配且对应的BGP路由属性长度较长时，会导致XPL策略处理性能下降。此时请通过降低正则表达式数量或使用非正则表达式的匹配命令可提升路由策略处理性能。每个策略中配置的正则表达式个数建议不超过100个。

3. 配置AS_Path集合的结束语句：`end-list`。

#### 团体属性集合

1. 配置团体属性集合的起始语句：`xpl community-list community-list-name`；
2. 配置集合元素，集合元素为 `aa:nn`、团体号或知名团体属性（`internet`、`no-export-subconfed`、`no-advertise` 或 `no-export`），如 `100:1`，元素之间用“,”隔开；也可以使用 `regular regular-expression` 格式，表示路由的团体属性符合指定正则表达式，`regular-expression` 为正则表达式。

**说明**：正则表达式匹配是CPU运算密集型处理。当XPL策略中配置了大量的正则表达式对BGP路由属性进行匹配且对应的BGP路由属性长度较长时，会导致XPL策略处理性能下降。此时请通过降低正则表达式数量或使用非正则表达式的匹配命令可提升路由策略处理性能。每个策略中配置的正则表达式个数建议不超过100个。正则表达式 `regular-expression` 可以配置为匹配 `aa:nn` 格式字符串，也可以配置为匹配整数格式的字符串。例如：配置 `regular ^1:1$`，可用于过滤团体属性为65537或者1:1的路由；配置 `regular ^65537$`，也可用于过滤团体属性为65537或者1:1的路由。

3. 配置团体属性集合的结束语句：`end-list`。

#### Large-community属性集合

1. 配置Large-community属性集合的起始语句：`xpl large-community-list large-community-list-name`；
2. 配置集合元素，集合元素为 `aa:bb:cc`，如 `100:1:1`，元素之间用“,”隔开；也可以使用 `regular regular-expression` 格式，表示路由的Large-community属性符合指定正则表达式，`regular-expression` 为正则表达式。

**说明**：正则表达式匹配是CPU运算密集型处理。当XPL策略中配置了大量的正则表达式对BGP路由属性进行匹配且对应的BGP路由属性长度较长时，会导致XPL策略处理性能下降。此时请通过降低正则表达式数量或使用非正则表达式的匹配命令可提升路由策略处理性能。每个策略中配置的正则表达式个数建议不超过100个。

3. 配置Large-community属性集合的结束语句：`end-list`。

#### 过滤策略

1. 配置过滤策略的起始语句：`xpl route-filter route-filter-name($var1,$var2,...)`，参数部分为可选，语句中可配置最多八个参数，可在配置条件语句或动作语句的过程中使用；
2. 配置匹配条件，格式为 `if+条件语句+then`。判断条件之间可进行 `not`、`and`、`or` 的逻辑运算。本行最后需添加 `then` 来引导动作语句；

**说明**：可以不配匹配条件，直接配置动作语句，也可以配置一个空的过滤策略，即只有过滤策略的起始语句和结束语句，其默认动作为 `refuse`；当其和其他策略用 `call` 语句组合使用时，此空策略不起作用。

3. 配置动作语句；

**说明**：
- 可同时配置多个动作语句，配置时需保证配置的动作语句间不冲突；
- 除 `approve`、`refuse`、`finish`、`call route-filter route-filter-name`、`break` 外，其余动作语句都要与 `apply`（动作执行语句）配合使用，形式为 `apply+动作语句`。

4. （可选）配置再次匹配，通过 `elseif+条件语句+then` 匹配未通过 `if` 过滤的路由，通过动作语句为通过此次过滤的路由设置动作。过滤策略中可通过多个 `elseif` 对未通过之前过滤的路由进行过滤。还可通过 `else` 匹配所有未通过之前过滤的路由并通过动作语句为其设置动作；
5. 配置条件结束语句 `endif`；

**说明**：步骤2到步骤5为一个 `if` 条件分支，`if` 条件分支在一个过滤策略中可多次配置，多次配置有两种方式，两种方式在一个过滤策略中可以同时使用：
- 在一个 `if` 条件分支结束后继续配置另一个 `if` 条件分支；
- 在一个 `if` 条件分支的 `if+条件语句+then` 或 `elseif+条件语句+then` 之后插入另一个 `if` 条件分支，表示路由只有通过 `if+条件语句+then` 或 `elseif+条件语句+then` 匹配的情况下才能进行被插入的 `if` 条件分支的匹配。

在这两种方式中，路由均可一直向下匹配直到被 `finish` 或 `break` 或 `refuse` 或走完所有的 `if` 条件分支。

6. 配置过滤策略的结束语句：`end-filter`。

**说明**：过滤策略中可直接引用 `{ 元素, 元素, ... }` 形式配置的路由属性集合，如 `if ip route-source in { 1.1.1.0 24, 2.2.2.2 32 } then`，这种配置方式比较简便，但某个集合在策略中多次应用时还是建议配置定义名称的集合。用户可根据实际情况选择合适的方式。

### 目的

路由器在发布、接收和引入路由信息时，根据实际组网需要实施一些策略，以便对路由信息进行过滤和改变路由信息的属性，如：

- 控制路由的发布只发布满足条件的路由信息。
- 控制路由的接收只接收必要、合法的路由信息，以控制路由表的容量，提高网络的安全性。
- 过滤和控制引入的路由一种路由协议在引入其他路由协议发现的路由信息丰富自己的路由知识时，只引入一部分满足条件的路由信息，并对所引入的路由信息的某些属性进行设置，以使其满足本协议的要求。
- 设置特定路由的属性修改通过过滤策略过滤的路由的属性，满足自身需要。
- 灵活更新对路由的发布接受策略XPL支持段编辑模式，用户可以在段编辑界面中进行配置，阶段性配置完成后统一提交配置，对策略的修改更新相对灵活。

### 受益

XPL具有以下价值：

- 通过控制路由器的路由表规模，节约系统资源。
- 通过控制路由的接收和发送，提高网络安全性。
- 通过修改路由属性，对网络数据流量进行合理规划，提高网络性能。
- 简化传统路由策略的配置方式，使配置更灵活。
```